<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>LADS/js/LADS/tourauthoring/LADS.TourAuthoring.ComponentControls.js - Touch Art Gallery web application</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../LADS/images/WideLogo.scale-100.png" title="Touch Art Gallery web application"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/LADS.Layout.Artmode.html">LADS.Layout.Artmode</a></li>
            
                <li><a href="../classes/LADS.Layout.InternetFailurePage.js.html">LADS.Layout.InternetFailurePage.js</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: LADS/js/LADS/tourauthoring/LADS.TourAuthoring.ComponentControls.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/// &lt;reference path=&quot;LADS.TourAuthoring.InkTrack.js&quot; /&gt;
LADS.Util.makeNamespace(&#x27;LADS.TourAuthoring.ComponentControls&#x27;);



/**
 * Controls for adding Components, editing properties of them, and undo/redo buttons
 * @param spec  root, timeline, timeManager attr
 * @param my    not used
 */
LADS.TourAuthoring.ComponentControls = function (spec, my) {
    &quot;use strict&quot;;

    var functionsPanel = $(document.createElement(&#x27;div&#x27;)),
        functionsPanelDocfrag = document.createDocumentFragment(),
        catalogPicker = $(document.createElement(&#x27;div&#x27;)),
        associatedMediaPicker = $(document.createElement(&#x27;div&#x27;)),
        that = {},
        root = spec.root,
        playbackControls = spec.playbackControls,
        timeManager = spec.timeManager,
        timeline = spec.timeline,
        viewer = spec.viewer,
        tourobj = spec.tourobj,
        undoManager = spec.undoManager,
        inkAuthoring,
        inkTransparencyControls, inkTextControls, inkDrawControls, inkEditTransparency, inkEditText, inkEditDraw,
        addCompButtonHeight,
        myPicker, resizableHeight,
        artQueue = LADS.Util.createQueue(),
        mediaQueue = LADS.Util.createQueue(),
        PICKER_SEARCH_TEXT = &#x27;Search by Name, Artist, or Year...&#x27;,
        IGNORE_IN_SEARCH = [&#x27;visible&#x27;, &#x27;exhibits&#x27;, &#x27;selected&#x27;],
        rinContainer = viewer.getContainer(),
        isUploading = false,
        allArtworks;

    functionsPanelDocfrag.appendChild(functionsPanel[0]);
    timeline.setCompControl(that);
    var catalogPickerOverlay = LADS.Util.UI.blockInteractionOverlay();
    $(catalogPickerOverlay).addClass(&#x27;catalogPickerOverlay&#x27;);
    $(catalogPickerOverlay).css(&#x27;z-index&#x27;, LADS.TourAuthoring.Constants.aboveRinZIndex);

    var associatedMediaPickerOverlay = LADS.Util.UI.blockInteractionOverlay();
    $(associatedMediaPickerOverlay).addClass(&#x27;associatedMediaPickerOverlay&#x27;);
    $(associatedMediaPickerOverlay).css(&#x27;z-index&#x27;, LADS.TourAuthoring.Constants.aboveRinZIndex);    
    
    /**
     * Display warning message if ink cannot be loaded
     * @param displayString     String describing error (to be displayed)
     */
    function creationError(displayString) {
        var messageBox = LADS.Util.UI.popUpMessage(null, displayString, null);
        $(messageBox).css(&#x27;z-index&#x27;, LADS.TourAuthoring.Constants.aboveRinZIndex + 1000);
        $(&#x27;body&#x27;).append(messageBox);
        $(messageBox).fadeIn(500);

        timeline.onUpdate(true);
    }

    (function _createHTML() {

        function ctrlZHandler(evt) {
            if (evt.keyCode === 90 &amp;&amp; evt.ctrlKey) {
                if (!onCtrlZCalled) {
                    onCtrlZCalled = true;
                    root.on(&#x27;keyup.z&#x27;, function (evt) {
                        onCtrlZCalled = false;
                        root.off(&#x27;keyup.z&#x27;);
                        if (timeline.getEditInkOn()) {//in ink authoring mode
                            if (evt.shiftKey) {
                                inkAuthoring.getInkUndoManager().redo();
                            }

                            else {
                                inkAuthoring.getInkUndoManager().undo();
                            }

                        }
                        else {
                            if (evt.shiftKey) {
                                undoManager.redo();
                            }
                            else {
                                undoManager.undo();
                            }
                        }
                    });
                }
            }

            else if (evt.keyCode === 89 &amp;&amp; evt.ctrlKey) {
                root.on(&#x27;keyup.y&#x27;, function (evt) {
                    root.off(&#x27;keyup.y&#x27;);

                    if ((inkAuthoring !== null) &amp;&amp; (inkAuthoring.getInkUndoManager())) {//in ink authoring mode
                        inkAuthoring.getInkUndoManager().redo();
                    }
                    else {
                        undoManager.redo();

                    }
                });
            }
        }
        //code to handle undo-redo using ctrl-z
        var onCtrlZCalled = false;
        root.on(&#x27;keydown&#x27;, ctrlZHandler);

        var maxFontSize = 48;
        var currentFontSize;
        /**
         * Method called when &quot;Edit Ink&quot; is clicked on a draw-type ink track.
         * Creates a new InkController and loads in the datastring of the track.
         * Shows the edit draw controls.
         * If the ink is linked, need to position it correctly using keyframes and size of artwork.
         * @param track        the ink track in question
         * @param datastring   the track&#x27;s ink datastring (see InkController.js for format)
         */
        var myEditDrawPicker = null;
        function showEditDraw(track, datastring) {
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
            var cw, ch, initKeyframe, artname, proxy,
                linked = track.getInkEnabled(),
                linkedTrack = track.getInkLink();

            // gotta do this up here to do creation check
            if (linked) {
                artname = linkedTrack.getTitle();

                var proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;);
                proxy = {
                    x: proxy_div.data(&quot;x&quot;),
                    y: proxy_div.data(&quot;y&quot;),
                    w: proxy_div.data(&quot;w&quot;),
                    h: proxy_div.data(&quot;h&quot;)
                };

                var keyframe = viewer.captureKeyframe(artname);
                if (!keyframe) {
                    track.setIsVisible(true);
                    creationError(&quot;The track this ink is attached to must be fully on screen in order to edit this ink. Please seek to a location where the track is visible.&quot;);
                    return false;
                }
                var kfvx, kfvy, kfvw, kfvh,
                    linkType = linkedTrack.getType();
                if (linkType === LADS.TourAuthoring.TrackType.artwork) {
                    kfvx = keyframe.state.viewport.region.center.x;
                    kfvy = keyframe.state.viewport.region.center.y;
                    kfvw = keyframe.state.viewport.region.span.x;
                    kfvh = keyframe.state.viewport.region.span.y;
                }
                else if (linkType === LADS.TourAuthoring.TrackType.image) {
                    kfvw = 1.0 / keyframe.state.viewport.region.span.x;
                    var rw = keyframe.state.viewport.region.span.x * $(&quot;#rinplayer&quot;).width();
                    kfvh = keyframe.state.viewport.region.span.y; // not used
                    kfvx = -keyframe.state.viewport.region.center.x * kfvw;
                    kfvy = -($(&quot;#rinplayer&quot;).height() / rw) * keyframe.state.viewport.region.center.y;
                }
            }
            //hide any open component controls, show inkEditDraw
            hideInkControls();
            //var newHeight = functionsPanel.parent().height() - addComponentLabel.offset().top - 10;
            inkEditDraw.css({ &#x27;display&#x27;: &#x27;block&#x27; });

            //make sure the initial size of the panel is the full height of the resizable area
            var raTop = $(&quot;#resizableArea&quot;).offset().top;
            var raHeight = $(&quot;#resizableArea&quot;).height();
            inkEditDraw.css(&quot;height&quot;, raTop + raHeight - inkEditDraw.offset().top - 10);

            drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawEditMode = &#x27;draw&#x27;;
            drawEditModeLabel1.text(&quot;Draw&quot;);
            brushEditLabel.text(&quot;Width: &quot;);
            brushEditLabel1.text(&quot;7px&quot;);
            brushEditLabel.append(brushEditLabel1);
            brushEditSliderPoint.css(&quot;left&quot;, &quot;0px&quot;);
            //eraserEditLabel.text(&quot;Eraser: &quot;);
            //eraserEditLabel1.text(&quot;7px&quot;);
            //eraserEditLabel.append(eraserEditLabel1);
            //eraserEditSliderPoint.css(&quot;left&quot;, &quot;0px&quot;);
            opacityEditLabel.text(&quot;Opacity: &quot;);
            opacityEditLabel1.text(&quot;100%&quot;);
            opacityEditLabel.append(opacityEditLabel1);
            opacityEditSliderPoint.css(&quot;left&quot;, (0.87 * opacityEditSlider.width()) + &quot;px&quot;);

            //reset click and save handlers to deal with current datastring
            cancelEditDrawButton.off(&#x27;click&#x27;);
            cancelEditDrawButton.on(&#x27;click&#x27;, function () {
                track.setIsVisible(true);
                timeline.setEditInkOn(false);
                timeline.onUpdate(true);
                timeline.setModifyingInk(false);
                timeline.hideEditorOverlay();

                brushEditSliderPoint.attr(&#x27;value&#x27;, 7.0);
                currentInkController.updatePenWidth(&quot;brushEditSlider&quot;);
                currentInkController.remove_all();
                removeInkCanv();
                inkEditDraw.hide();
                
                playbackControls.undoButton.off(&#x27;click&#x27;); //reset undo/redo buttons to global undo/redo functionality
                playbackControls.redoButton.off(&#x27;click&#x27;);
                playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);
            });

            saveDrawButton.off(&#x27;click&#x27;);
            saveDrawButton.on(&#x27;click&#x27;, function () {
                saveDraw();
                timeline.hideEditorOverlay();
                timeline.setEditInkOn(false);
                timeline.setModifyingInk(false);
            });

            function saveDraw() {
                //first, check if the ink is empty
                if (currentInkController.isDatastringEmpty(currentInkController.update_datastring())) {
                    var confirmationBox = LADS.Util.UI.PopUpConfirmation(function () {
                        //delete track
                        track.setIsVisible(true);

                        var command = LADS.TourAuthoring.Command({
                            execute: function () {
                                timeline.removeTrack(track);
                            },
                            unexecute: function () {
                                track.reloadTrack();
                            }
                        });
                        undoManager.logCommand(command);
                        command.execute();
                        //hide ink controls and removeinkcanv
                        inkEditDraw.hide();
                        removeInkCanv();
                        //change the undomanager back fron ink only
                        playbackControls.undoButton.off(&#x27;click&#x27;); //reset undo/redo buttons to global undo/redo functionality
                        playbackControls.redoButton.off(&#x27;click&#x27;);
                        playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                            undoManager.undo();
                        });
                        playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                            undoManager.redo();
                        });
                        playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                    }, &quot;You have created an empty ink. Would you like to delete ink track or go back to editing?&quot;, &quot;Delete Track&quot;, true);
                    root.append(confirmationBox);
                    $(confirmationBox).show();
                    return;
                }
                //reset the initial keyframe and relative artwork positioning in the track data
                if (linked) {
                    var currcanv = $(&#x27;#inkCanv&#x27;);

                    var new_proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;); //proxy for the artwork -- keeps track of dimensions
                    var new_proxy = {
                        x: new_proxy_div.data(&quot;x&quot;),
                        y: new_proxy_div.data(&quot;y&quot;),
                        w: new_proxy_div.data(&quot;w&quot;),
                        h: new_proxy_div.data(&quot;h&quot;)
                    };

                    var new_keyframe = viewer.captureKeyframe(artname);

                    if (!new_keyframe) {
                        creationError(&quot;The track this ink is attached to must be fully on screen in order to save this ink. Please seek to a location where the track is visible.&quot;);
                        return false;
                    }
                    var new_kfvx, new_kfvy, new_kfvw, new_kfvh,
                        linkType = linkedTrack.getType();
                    if (linkType === LADS.TourAuthoring.TrackType.artwork) {
                        new_kfvx = new_keyframe.state.viewport.region.center.x;
                        new_kfvy = new_keyframe.state.viewport.region.center.y;
                        new_kfvw = new_keyframe.state.viewport.region.span.x;
                        new_kfvh = new_keyframe.state.viewport.region.span.y;
                    }
                    else if (linkType === LADS.TourAuthoring.TrackType.image) {
                        new_kfvw = 1.0 / new_keyframe.state.viewport.region.span.x;
                        var rw = new_keyframe.state.viewport.region.span.x * currcanv.width();
                        new_kfvh = new_keyframe.state.viewport.region.span.y; // not used
                        new_kfvx = -new_keyframe.state.viewport.region.center.x * new_kfvw;
                        new_kfvy = -(currcanv.height() / rw) * new_keyframe.state.viewport.region.center.y;
                    }
                    track.setInkInitKeyframe({ &quot;x&quot;: new_kfvx, &quot;y&quot;: new_kfvy, &quot;w&quot;: new_kfvw, &quot;h&quot;: new_kfvh });
                    track.setInkRelativeArtPos(currentInkController.getArtRelativePos(new_proxy, currcanv.width(), currcanv.height()));
                }
                var datastr = currentInkController.update_datastring();
                var oldDataStr = track.getInkPath();

                var command = LADS.TourAuthoring.Command({
                    execute: function () {
                        track.setInkPath(datastr);
                        timeline.onUpdate(true);
                    },
                    unexecute: function () {
                        track.setInkPath(oldDataStr);
                        timeline.onUpdate(true);
                    },
                });

                currentInkController.remove_all();
                removeInkCanv();
                inkEditDraw.hide();

                track.setIsVisible(true);

                undoManager.logCommand(command);
                command.execute();

                //timeline.onUpdate(true);

                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);

                playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);


                if (inkAuthoring) {
                    inkAuthoring.getInkUndoManager().clear();
                    undoManager.greyOutBtn();
                }
            }
            that.saveDraw = saveDraw;
            hideAll(drawEditArray);

            //create a div on which we&#x27;ll draw inks

            var inkdiv = createInkCanv();
            var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
            $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
            inkAuthoring = p1;
            p1.set_editable();
            p1.set_mode(LADS.TourAuthoring.InkMode.draw);
            //p1.updatePenWidth(&quot;brushSlider&quot;); // reset to defaults
            //p1.updatePenOpacity(&quot;opacitySlider&quot;);

            if (linked) {
                //if the ink is linked, need to figure out where to place it beyond loading in the original datastring
                initKeyframe = track.getInkInitKeyframe();
                p1.setInitKeyframeData(initKeyframe);
                p1.setArtName(artname);
                p1.retrieveOrigDims();
                p1.setEID(track.getTitle());
            }

            p1.loadInk(datastring); //load in the ink to be edited

            if (linked) {
                //now adjust viewbox so art is at the proper coordinates
                p1.update_datastring();
                p1.setOldOpac(1);
                p1.adjustViewBoxDiv({ x: proxy.x, y: proxy.y, width: proxy.w, height: proxy.h });
                p1.drawPaths();
                p1.drawBezierPath();
            }

            currentInkController = p1;


            //call onUpdate to remove the existing ink before reloading it in edit mode
            timeline.onUpdate(true);
            timeline.showEditorOverlay();
            timeline.setEditInkOn(true);
        }
        that.showEditDraw = showEditDraw;

        /**
         * Method called when &quot;Edit Ink&quot; is clicked on a block/isolate-type ink track.
         * See comments for showEditDraw.
         * @param track        the ink track in question
         * @param datastring   the track&#x27;s ink datastring
         * @param trans_type   &#x27;isolate&#x27; or &#x27;block&#x27;
         */
        function getInkUndoManager() {
            if (inkAuthoring)
                return inkAuthoring.getInkUndoManager();
        }
        that.getInkUndoManager = getInkUndoManager;

        function showEditTransparency(track, datastring, trans_type) {
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
            var cw, ch, initKeyframe, artname, proxy, proxy_h, proxy_w,
                kfvx, kfvy, kfvw, kfvh,
                linked = track.getInkEnabled(),
                linkedTrack = track.getInkLink();

            if (linked) {
                initKeyframe = track.getInkInitKeyframe();
                artname = linkedTrack.getTitle();
                var proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;);
                proxy = {
                    x: proxy_div.data(&quot;x&quot;),
                    y: proxy_div.data(&quot;y&quot;),
                    w: proxy_div.data(&quot;w&quot;),
                    h: proxy_div.data(&quot;h&quot;)
                };

                var keyframe = viewer.captureKeyframe(artname);

                if (!keyframe) {
                    track.setIsVisible(true);
                    creationError(&quot;The track this ink is attached to must be fully on screen in order to edit this ink. Please seek to a location where the track is visible.&quot;);
                    return false;
                }

                if (track.getInkLink().getType() === LADS.TourAuthoring.TrackType.artwork) {
                    kfvx = keyframe.state.viewport.region.center.x;
                    kfvy = keyframe.state.viewport.region.center.y;
                    kfvw = keyframe.state.viewport.region.span.x;
                    kfvh = keyframe.state.viewport.region.span.y;
                }
                else if (track.getInkLink().getType() === LADS.TourAuthoring.TrackType.image) {
                    kfvw = 1.0 / keyframe.state.viewport.region.span.x;
                    var rw = keyframe.state.viewport.region.span.x * $(&quot;#rinplayer&quot;).width();
                    kfvh = keyframe.state.viewport.region.span.y; // not used
                    kfvx = -keyframe.state.viewport.region.center.x * kfvw;
                    kfvy = -($(&quot;#rinplayer&quot;).height() / rw) * keyframe.state.viewport.region.center.y;
                }
            }
            

            inkTransparencyControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkTextControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkDrawControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkEditDraw.css(&#x27;display&#x27;, &#x27;none&#x27;);
            inkEditText.css(&#x27;display&#x27;, &#x27;none&#x27;);
            inkEditTransparency.show();

            //var newHeight = functionsPanel.parent().height() - addComponentLabel.offset().top - 10;
            var raTop = $(&quot;#resizableArea&quot;).offset().top;
            var raHeight = $(&quot;#resizableArea&quot;).height();
            inkEditTransparency.css({
                &quot;height&quot;: raTop + raHeight - inkEditTransparency.offset().top - 10
            });
            

            opacityEditTransparencyLabel.text(&quot;Opacity: &quot;);
            opacityEditTransparencyLabel1.text(&quot;80%&quot;);
            opacityEditTransparencyLabel.append(opacityEditTransparencyLabel1);    
            opacityEditTransparencySliderPoint.css(&quot;left&quot;, 0.8 * (opacityEditTransparencySlider.offset().left + opacityEditTransparencySlider.width()) / 1.28 + &#x27;px&#x27;);

            cancelEditTransButton.off(&#x27;click&#x27;);
            cancelEditTransButton.on(&#x27;click&#x27;, function () {
                track.setIsVisible(true);
                timeline.onUpdate(true);
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
                timeline.hideEditorOverlay();

                currentInkController.remove_all();
                removeInkCanv();
                inkEditTransparency.hide();

                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);

                playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);
            });

            saveTransButton.off(&quot;click&quot;);
            saveTransButton.on(&#x27;click&#x27;, function () {
                saveTrans();
                timeline.hideEditorOverlay();
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
            });

            function saveTrans() {
                var datastr;

                //first, check if the ink is empty
                if (currentInkController.isDatastringEmpty(currentInkController.update_datastring())) {
                    var confirmationBox = LADS.Util.UI.PopUpConfirmation(function () {
                        //delete track
                        track.setIsVisible(true);

                        var command = LADS.TourAuthoring.Command({
                            execute: function () {
                                timeline.removeTrack(track);
                            },
                            unexecute: function () {
                                track.reloadTrack();
                            }
                        });
                        undoManager.logCommand(command);
                        command.execute();
                        //hide ink controls and removeinkcanv
                        inkEditTransparency.hide();
                        removeInkCanv();
                        //change the undomanager back fron ink only
                        playbackControls.undoButton.off(&#x27;click&#x27;); //reset undo/redo buttons to global undo/redo functionality
                        playbackControls.redoButton.off(&#x27;click&#x27;);
                        playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                            undoManager.undo();
                        });
                        playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                            undoManager.redo();
                        });
                        playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                    }, &quot;You have created an empty ink. Would you like to delete ink track or go back to editing?&quot;, &quot;Delete Track&quot;, true);
                    root.append(confirmationBox);
                    $(confirmationBox).show();
                    return;
                }
                if (linked) {
                    var currcanv = $(&#x27;#inkCanv&#x27;);

                    var new_proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;); //proxy for the artwork -- keeps track of dimensions
                    var new_proxy = {
                        x: new_proxy_div.data(&quot;x&quot;),
                        y: new_proxy_div.data(&quot;y&quot;),
                        w: new_proxy_div.data(&quot;w&quot;),
                        h: new_proxy_div.data(&quot;h&quot;)
                    };

                    var new_keyframe = viewer.captureKeyframe(artname);

                    if (!new_keyframe) {
                        creationError(&quot;The track this ink is attached to must be fully on screen in order to save this ink. Please seek to a location where the track is visible.&quot;);
                        return false;
                    }
                    var new_kfvx, new_kfvy, new_kfvw, new_kfvh,
                        linkType = linkedTrack.getType();
                    if (linkType === LADS.TourAuthoring.TrackType.artwork) {
                        new_kfvx = new_keyframe.state.viewport.region.center.x;
                        new_kfvy = new_keyframe.state.viewport.region.center.y;
                        new_kfvw = new_keyframe.state.viewport.region.span.x;
                        new_kfvh = new_keyframe.state.viewport.region.span.y;
                    }
                    else if (linkType === LADS.TourAuthoring.TrackType.image) {
                        new_kfvw = 1.0 / new_keyframe.state.viewport.region.span.x;
                        var rw = new_keyframe.state.viewport.region.span.x * currcanv.width();
                        new_kfvh = new_keyframe.state.viewport.region.span.y; // not used
                        new_kfvx = -new_keyframe.state.viewport.region.center.x * new_kfvw;
                        new_kfvy = -(currcanv.height() / rw) * new_keyframe.state.viewport.region.center.y;
                    }
                    track.setInkInitKeyframe({ &quot;x&quot;: new_kfvx, &quot;y&quot;: new_kfvy, &quot;w&quot;: new_kfvw, &quot;h&quot;: new_kfvh });
                    track.setInkRelativeArtPos(currentInkController.getArtRelativePos(new_proxy, currcanv.width(), currcanv.height()));
                }

                //need to convert rectangles/ellipses to paths before updating datastring
                currentInkController.get_trans_shape_data();
                datastr = currentInkController.update_datastring();
                datastr += currentInkController.getBoundingShapes(); //save the rect/ellipse data in case we need to edit again

                var oldDataStr = track.getInkPath();

                var command = LADS.TourAuthoring.Command({
                    execute: function () {
                        track.setInkPath(datastr);
                        timeline.onUpdate(true);
                    },
                    unexecute: function () {
                        track.setInkPath(oldDataStr);
                        timeline.onUpdate(true);
                    },
                });

                track.setIsVisible(true);

                undoManager.logCommand(command);
                command.execute();

                currentInkController.remove_all();
                removeInkCanv();
                inkEditTransparency.hide();

                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);
                playbackControls.undoButton.on(&quot;click&quot;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&quot;click&quot;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                if (inkAuthoring){
                    inkAuthoring.getInkUndoManager().clear();
                    undoManager.greyOutBtn();
                }
            }
            that.saveTrans = saveTrans;

            hideAll(transEditArray);

            var inkdiv = createInkCanv();
            var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
            $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
            inkAuthoring = p1;
            p1.set_mode(LADS.TourAuthoring.InkMode.shapes); //shape manipulation mode
            p1.set_editable();
            p1.setMarqueeFillOpacity(p1.get_attr(datastring, &#x27;opac&#x27;, &#x27;f&#x27;));
            if (linked) {
                //get the inkController set to load ink in the correct position
                p1.setInitKeyframeData(initKeyframe);
                p1.setArtName(artname);
                cw = $(&quot;#inkCanv&quot;).width();
                ch = $(&quot;#inkCanv&quot;).height();
                p1.retrieveOrigDims();
                p1.setEID(track.getTitle());
            }
            var currentMode =datastring.split(&quot;mode&quot;)[1].split(&quot;[&quot;)[0].replace(&quot;]&quot;, &quot;&quot;);
            p1.setTransMode(trans_type);
            p1.load_transparency_bounding_shapes(datastring);
            if (currentMode === &#x27;isolate&#x27;) {
                isolateEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                blockEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                transparencyEditMode = &#x27;isolate&#x27;;
                transEditModeLabel1.text(&quot;Isolate&quot;);
                p1.setTransMode(&quot;isolate&quot;);
            }
            if (currentMode === &#x27;block&#x27;) {
                isolateEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                blockEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                transparencyEditMode = &#x27;block&#x27;;
                transEditModeLabel1.text(&quot;Block&quot;);
                p1.setTransMode(&quot;block&quot;);
            }
            if (linked) {
                //now adjust viewbox so art is at the proper coordinates
                var real_kfw = p1.origPaperW / kfvw;
                var real_kfh = real_kfw * proxy_h / proxy_w;
                var real_kfx = -kfvx * real_kfw;
                var real_kfy = -kfvy * real_kfw;
                p1.update_datastring();
                p1.setOldOpac(1);
                p1.adjustViewBoxDiv({ x: proxy.x, y: proxy.y, width: proxy.w, height: proxy.h });
            }
            currentInkController = p1;
            var currOpacity = currentInkController.getMarqueeFillOpacity();
            opacityEditTransparencyLabel1.text(Math.round(100 * currOpacity) + &quot;%&quot;);
            opacityEditTransparencyLabel.append(opacityEditTransparencyLabel1);
            opacityEditTransparencySliderPoint.css(&quot;left&quot;, currOpacity * (opacityEditTransparencySlider.offset().left + opacityEditTransparencySlider.width()) / 1.28 + &#x27;px&#x27;);

            //call onUpdate to remove the existing ink before reloading it in edit mode
            timeline.onUpdate(true);
            timeline.showEditorOverlay();
        }
        that.showEditTransparency = showEditTransparency;

        /**
         * Method called when &quot;Edit Ink&quot; is clicked on a text-type ink track.
         * See comments for showEditDraw.
         * @param track        the ink track in question
         * @param datastring   the track&#x27;s ink datastring
         */
        var myEditTextPicker = null;
        function showEditText(track, datastring, dims) {
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
            var cw, ch, initKeyframe, rap, artname, proxy,
                linked = track.getInkEnabled(),
                linkedTrack = track.getInkLink();

            if (linked) {
                initKeyframe = track.getInkInitKeyframe();
                artname = linkedTrack.getTitle();

                var proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;);
                proxy = {
                    x: proxy_div.data(&quot;x&quot;),
                    y: proxy_div.data(&quot;y&quot;),
                    w: proxy_div.data(&quot;w&quot;),
                    h: proxy_div.data(&quot;h&quot;)
                };

                var keyframe = viewer.captureKeyframe(artname);
                if (!keyframe) {
                    track.setIsVisible(true);
                    creationError(&quot;The track this ink is attached to must be fully on screen in order to edit this ink. Please seek to a location where the track is visible.&quot;);
                    return false;
                }

                var kfvx, kfvy, kfvw, kfvh,
                    linkType = linkedTrack.getType();
                if (linkType === LADS.TourAuthoring.TrackType.artwork) {
                    kfvx = keyframe.state.viewport.region.center.x;
                    kfvy = keyframe.state.viewport.region.center.y;
                    kfvw = keyframe.state.viewport.region.span.x;
                    kfvh = keyframe.state.viewport.region.span.y;
                }
                else if (linkType === LADS.TourAuthoring.TrackType.image) {
                    kfvw = 1.0 / keyframe.state.viewport.region.span.x;
                    var rw = keyframe.state.viewport.region.span.x * $(&quot;#rinplayer&quot;).width();
                    kfvh = keyframe.state.viewport.region.span.y; // not used
                    kfvx = -keyframe.state.viewport.region.center.x * kfvw;
                    kfvy = -($(&quot;#rinplayer&quot;).height() / rw) * keyframe.state.viewport.region.center.y;
                }
            }
            
            hideInkControls();
            inkEditText.show();

            //var newHeight = functionsPanel.parent().height() - addComponentLabel.offset().top - 10;
            var raTop = $(&quot;#resizableArea&quot;).offset().top;
            var raHeight = $(&quot;#resizableArea&quot;).height();
            inkEditText.css({
                &quot;height&quot;: raTop + raHeight - inkEditText.offset().top - 10
            });
            

            fontEditLabel.text(&quot;Font: &quot;);
            fontEditLabel1.text(&quot;Times New Roman&quot;);
            fontEditLabel.append(fontEditLabel1);
            textEditSliderPoint.css(&quot;left&quot;, &quot;0px&quot;);
            textEditSizeLabel.text(&quot;Text Size: &quot;);
            hideAll(textEditArray);

            cancelEditTextButton.off(&quot;click&quot;);
            cancelEditTextButton.on(&quot;click&quot;, function () {
                track.setIsVisible(true);
                timeline.onUpdate(true);
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
                timeline.hideEditorOverlay();
                currentInkController.resetText();
                currentInkController.remove_all();
                removeInkCanv();
                inkEditText.hide();

                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);

                playbackControls.undoButton.on(&quot;click&quot;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&quot;click&quot;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);
            });

            saveTextButton.off(&quot;click&quot;);
            saveTextButton.on(&quot;click&quot;, function () {
                saveText();
                textEditArea.val(&quot;&quot;);
                textEditBodyLabel1.text(&quot;&quot;);
                timeline.hideEditorOverlay();
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
            });

            function saveText() {
                //first, check if the ink is empty
                if (currentInkController.isTextboxEmpty()) {
                    var confirmationBox = LADS.Util.UI.PopUpConfirmation(function () {
                        //delete track
                        track.setIsVisible(true);
                        var command = LADS.TourAuthoring.Command({
                            execute: function () {
                                timeline.removeTrack(track);
                            },
                            unexecute: function () {
                                track.reloadTrack();
                            }
                        });
                        undoManager.logCommand(command);
                        command.execute();

                        //hide ink controls and removeinkcanv
                        inkEditText.hide();
                        removeInkCanv();

                        //change the undomanager back fron ink only
                        playbackControls.undoButton.off(&#x27;click&#x27;); //reset undo/redo buttons to global undo/redo functionality
                        playbackControls.redoButton.off(&#x27;click&#x27;);
                        playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                            undoManager.undo();
                        });
                        playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                            undoManager.redo();
                        });
                        playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                    }, &quot;You have created an empty ink. Would you like to delete ink track or go back to editing?&quot;, &quot;Delete Track&quot;, true);
                    root.append(confirmationBox);
                    $(confirmationBox).show();
                    return;
                }
                if (linked) {
                    var currcanv = $(&#x27;#inkCanv&#x27;);

                    var new_proxy_div = $(&quot;[data-proxy=&#x27;&quot; + escape(artname) + &quot;&#x27;]&quot;); //proxy for the artwork -- keeps track of dimensions
                    var new_proxy = {
                        x: new_proxy_div.data(&quot;x&quot;),
                        y: new_proxy_div.data(&quot;y&quot;),
                        w: new_proxy_div.data(&quot;w&quot;),
                        h: new_proxy_div.data(&quot;h&quot;)
                    };

                    var new_keyframe = viewer.captureKeyframe(artname);

                    if (!new_keyframe) {
                        creationError(&quot;The track this ink is attached to must be fully on screen in order to save this ink. Please seek to a location where the track is visible.&quot;);
                        return false;
                    }
                    var new_kfvx, new_kfvy, new_kfvw, new_kfvh,
                        linkType = linkedTrack.getType();
                    if (linkType === LADS.TourAuthoring.TrackType.artwork) {
                        new_kfvx = new_keyframe.state.viewport.region.center.x;
                        new_kfvy = new_keyframe.state.viewport.region.center.y;
                        new_kfvw = new_keyframe.state.viewport.region.span.x;
                        new_kfvh = new_keyframe.state.viewport.region.span.y;
                    }
                    else if (linkType === LADS.TourAuthoring.TrackType.image) {
                        new_kfvw = 1.0 / new_keyframe.state.viewport.region.span.x;
                        var rw = new_keyframe.state.viewport.region.span.x * currcanv.width();
                        new_kfvh = new_keyframe.state.viewport.region.span.y; // not used
                        new_kfvx = -new_keyframe.state.viewport.region.center.x * new_kfvw;
                        new_kfvy = -(currcanv.height() / rw) * new_keyframe.state.viewport.region.center.y;
                    }
                    track.setInkInitKeyframe({ &quot;x&quot;: new_kfvx, &quot;y&quot;: new_kfvy, &quot;w&quot;: new_kfvw, &quot;h&quot;: new_kfvh });
                    track.setInkRelativeArtPos(currentInkController.getArtRelativePos(new_proxy, currcanv.width(), currcanv.height()));
                }

                track.setInkPath(currentInkController.update_datastring()); //======== can call currentInkController.update_datastring here to get the most recent ink path (getDatastring assumes it&#x27;s already been called)
                removeInkCanv();
                inkEditText.hide();

                track.setIsVisible(true);

                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);

                playbackControls.undoButton.on(&quot;click&quot;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&quot;click&quot;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                colorTextLabel1.text(&quot;#FFFFFF&quot;);
                $(&#x27;#textColorToggle&#x27;).attr(&#x27;value&#x27;, &quot;FFFFFF&quot;);

                if (inkAuthoring) {
                    inkAuthoring.getInkUndoManager().clear();
                    undoManager.greyOutBtn();
                }
                timeline.onUpdate();
            }
            that.saveText = saveText;

            var inkdiv = createInkCanv();
            var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
            $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
            inkAuthoring = p1;
            cw = $(&quot;#inkCanv&quot;).width();
            ch = $(&quot;#inkCanv&quot;).height();
            p1.set_mode(LADS.TourAuthoring.InkMode.text);
            p1.set_editable();

            var fontsize, line_breaks, num_lines;
            fontsize = p1.get_attr(datastring, &quot;fontsize&quot;, &#x27;f&#x27;) * ch;
            p1.setFontSize(fontsize);
            maxFontSize = Math.max(48, fontsize);
            var str = p1.get_attr(datastring, &#x27;str&#x27;, &#x27;s&#x27;);
            textEditArea.val(str);
            textEditBodyLabel1.text(str);
            
            var scaleFactor = dims.fontsize / fontsize;

            var w, h;
            try {
                w = p1.get_attr(datastring, &#x27;w&#x27;, &#x27;f&#x27;);
                w = linked ? w * scaleFactor : w;
                h = p1.get_attr(datastring, &#x27;h&#x27;, &#x27;f&#x27;);
                h = linked ? h * scaleFactor : h;
            } catch (err) {
                w = null;
                h = null;
            }

            if (linked) {
                p1.setInitKeyframeData(initKeyframe);
                p1.setArtName(artname);
                p1.retrieveOrigDims();
                p1.setEID(track.getTitle());
                p1.loadInk(datastring);
                p1.adjustViewBoxDiv({ x: proxy.x, y: proxy.y, width: proxy.w, height: proxy.h });
            }
            var textX = p1.getPannedPos().x || p1.get_attr(datastring, &quot;x&quot;, &quot;f&quot;) * cw;
            var textY = p1.getPannedPos().y || p1.get_attr(datastring, &quot;y&quot;, &quot;f&quot;) * ch;
            p1.setFontFamily(p1.get_attr(datastring, &quot;font&quot;, &#x27;s&#x27;));
            p1.setFontColor(p1.get_attr(datastring, &quot;color&quot;, &#x27;s&#x27;));
            p1.add_text_box(textX, textY, w, h, str); // 5px seems to be standard textarea padding
            var svgText = p1.getSVGText();
            
            currentFontSize = fontsize;
            textEditSizeLabel1.text(Math.round(fontsize) + &quot;px&quot;);
            textEditSizeLabel.append(textEditSizeLabel1);
            var pointvalue = (fontsize - 8) / (maxFontSize - 8);
            textEditSizeSlider.attr(&quot;value&quot;, Math.round(fontsize) + &quot;px&quot;);
            //console.log(pointleft);
            var currentcolor = p1.get_attr(datastring, &quot;color&quot;, &#x27;s&#x27;); //update the current color
            colorEditTextLabel1.text(currentcolor);
            
            //myPicker = new jscolor.color(itemEditText, {});
            myEditTextPicker.fromString(currentcolor);
            currentInkController = p1;
            firstUpdate();
            updateToggle(textEditArray, textEditArea);

            timeline.onUpdate(true);
            timeline.showEditorOverlay();

        }
        that.showEditText = showEditText;

        functionsPanel.attr(&#x27;id&#x27;, &#x27;component-controls&#x27;);
        functionsPanel.css({
            &quot;background-color&quot;: &quot;rgb(219,218,199)&quot;, &quot;height&quot;: &quot;48px&quot;, &quot;width&quot;: &quot;20%&quot;, &#x27;top&#x27;: &#x27;15px&#x27;,
            &#x27;left&#x27;: &#x27;0%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;, &#x27;float&#x27;: &#x27;left&#x27;,
        }); // Had to do tops and heights as CSS to prevent overlap on small screens

        /** Drop Down icon
         *  Modified By: Hak
         */
        var addDropDownIconComponent = $(document.createElement(&#x27;img&#x27;));
        addDropDownIconComponent.attr(&#x27;id&#x27;, &#x27;addDropDownIconComponent&#x27;);
        addDropDownIconComponent.attr(&#x27;src&#x27;, &#x27;images/icons/Down.png&#x27;);
        addDropDownIconComponent.css({ &#x27;width&#x27;: &#x27;10%&#x27;, &#x27;margin-left&#x27;: &#x27;35%&#x27;, &#x27;height&#x27;: &#x27;10%&#x27; });

        /**
         * Add parts of function panel
         */
        // Add Component menu - main button
        var menuOffsetL = &#x27;13%&#x27;;
        var addComponentLabel = $(document.createElement(&#x27;label&#x27;));
        addComponentLabel.text(&quot;Add Track&quot;);
        addComponentLabel.attr(&#x27;id&#x27;, &#x27;addComponentLabel&#x27;);
        addComponentLabel.css({
            &quot;left&quot;: menuOffsetL, &quot;top&quot;: &quot;5%&quot;, &quot;position&quot;: &quot;relative&quot;,
            &quot;font-size&quot;: LADS.Util.getFontSize(200), &quot;color&quot;: &quot;rgb(256, 256, 256)&quot;,
            //Using the current background color value multiplied by the ( 1- alpha value )
            &#x27;background-color&#x27;: &quot;rgb(63, 55, 53)&quot;,
            &#x27;padding&#x27;: &#x27;3% 2% 4% 2%&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;,
            &#x27;float&#x27;: &#x27;left&#x27;,
        });
        addComponentLabel.append(addDropDownIconComponent);
        functionsPanel.append(addComponentLabel);

        //fade overlay appears when AddComponent is opened -- allows addComponent to be closed when clicking away
        var fade = $(document.createElement(&#x27;div&#x27;));
        fade.css({
            width: &quot;100%&quot;,
            height: &quot;100%&quot;,
            position: &quot;fixed&quot;,
            top: &#x27;0px&#x27;,
            left: &#x27;0px&#x27;,
            //&#x27;background-color&#x27;: &#x27;rgba(0,0,0,.5)&#x27;,
            &#x27;z-index&#x27;: LADS.TourAuthoring.Constants.aboveRinZIndex + 18
        });
        fade.attr(&quot;class&quot;, &quot;fade&quot;);
        functionsPanel.append(fade);
        fade.hide();

        //fades &quot;Add Component&quot; menus away when click happens outside the menus
        fade.on(&#x27;mousedown&#x27;, function (evt) {
            fade.hide();
            componentDropDown = false;
            addDropDownIconComponent.css({ &#x27;transform&#x27;: &#x27;scaleY(1)&#x27;, &#x27;margin-bottom&#x27;: &#x27;2%&#x27; });
            dropInk.hide();
            dropFile.hide();
            dropMain.hide();
        });

        // Dropdown menus:
        // Main section
        var dropMain = $(document.createElement(&#x27;div&#x27;));
        dropMain.css({
            &quot;left&quot;: menuOffsetL,
            &quot;position&quot;: &quot;relative&quot;,
            &quot;color&quot;: &quot;rgb(256, 256, 256)&quot;,
            &#x27;width&#x27;: &#x27;74%&#x27;,
            &#x27;background-color&#x27;: &#x27;rgba(0,0,0,0.95)&#x27;,
            &#x27;float&#x27;: &#x27;left&#x27;,
            &#x27;clear&#x27;: &#x27;left&#x27;,
            &#x27;z-index&#x27;: LADS.TourAuthoring.Constants.aboveRinZIndex + 19
        });
        functionsPanel.append(dropMain);
        dropMain.hide();

        // create the buttons to add various components
        var artButton = _createAddComponentButton(&quot;Artwork&quot;, dropMain);
        var assetButton = _createAddComponentButton(&quot;Associated Media&quot;, dropMain);
        var fileButton = _createAddComponentButton(&quot;From File&quot;, dropMain);
        var inkButton = _createAddComponentButton(&quot;Annotate&quot;, dropMain);

        //File uploading subsection -Xiaoyi
        var dropFile = $(document.createElement(&#x27;div&#x27;));
        dropFile.css({
            &quot;left&quot;: &#x27;87%&#x27;,
            &#x27;margin-top&#x27;: &#x27;-33%&#x27;,
            &quot;position&quot;: &quot;relative&quot;,
            &quot;color&quot;: &quot;rgb(256, 256, 256)&quot;,
            &#x27;width&#x27;: &#x27;74%&#x27;,
            &#x27;background-color&#x27;: &#x27;rgba(0,0,0,0.95)&#x27;,
            &#x27;float&#x27;: &#x27;left&#x27;,
            &#x27;z-index&#x27;: LADS.TourAuthoring.Constants.aboveRinZIndex + 19
        }); 
        functionsPanel.append(dropFile);
        dropFile.hide();

        var audioButton = _createAddComponentButton(&quot;Audio (MP3)&quot;, dropFile);
        var videoButton = _createAddComponentButton(&quot;Video (MP4)&quot;, dropFile);
        var imageButton = _createAddComponentButton(&quot;Image&quot;, dropFile);

        function exitInk() {
            removeInkCanv();
            hideInkControls();
            // set undo/redo buttons back to global undo/redo functionality
            playbackControls.undoButton.off(&quot;click&quot;);
            playbackControls.redoButton.off(&quot;click&quot;);
            playbackControls.undoButton.on(&quot;click&quot;, function () {
                undoManager.undo();
            });
            playbackControls.redoButton.on(&quot;click&quot;, function () {
                undoManager.redo();
            });
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;none&#x27; });
        }

        /**
         * Opens the correct file picker based on the file type
         */
        function pickFile() {
            var type, names = [],
                title = $(this).text(),
                initLoc = timeManager.getCurrentPx(),
                mediaLengths = [], i, upldr;

            isUploading = true;
            // Get music properties
            function getMusicPropertiesHelper(file) {
                file.properties.getMusicPropertiesAsync().done(function (musicProperties) {
                    mediaLengths.push(musicProperties.duration / 1000); // get duration in seconds
                },

                  // Handle errors with an error function
                function (error) {
                    console.log(error);
                });
            }

            if (title === &quot;Audio (MP3)&quot;) {
                upldr = LADS.Authoring.FileUploader(root, LADS.Authoring.FileUploadTypes.Standard,
                function (files) {
                    var file;
                    for (i = 0; i &lt; files.length; i++) {
                        file = files[i];
                        names.push(file.displayName);
                        if (file.fileType === &#x27;.mp3&#x27;) {
                            type = LADS.TourAuthoring.TrackType.audio;
                            getMusicPropertiesHelper(file);
                        }
                    }

                   
                },
                function (urls) {
                    var url, name, mediaLength;
                    for (i = 0; i &lt; urls.length; i++) {
                        url = urls[i];
                        name = names[i];
                        mediaLength = mediaLengths[i];
                        var track = timeline.addAudioTrack(url, name, null, mediaLength);

                        // update tour length if necessary
                        //if (timeManager.getDuration().end &lt; mediaLength + timeManager.pxToTime(initLoc)) {
                        //    timeManager.setEnd(mediaLength + timeManager.pxToTime(initLoc));
                        //}

                        //// add a display to the track
                        //track.addDisplay(initLoc, mediaLength);

                        var positionX = initLoc;
                        var displayLength = mediaLength;
                        //track.addDisplay(positionX, displayLength);
                        if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                        }
                        var diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                        var newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                             track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                             track.addDisplay(positionX, Math.min(diff, displayLength));
                        
                        if (timeline.getTracks().length &gt; 0) {
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                    }
                    undoManager.combineLast(2 * urls.length);
                    isUploading = false;
                    timeline.getDataHolder().mapTracks(function (container, i) {
                        container.track.updatePos(i);
                    });
                },
                [&#x27;.mp3&#x27;],
                false,
                function () {
                    root.append(LADS.Util.UI.popUpMessage(null, &quot;There was an error uploading the file. Please try again later.&quot;));
                },
                true);
                upldr.setMaxDuration(LADS.TourAuthoring.Constants.maxTourLength);
                upldr.setMinDuration(LADS.TourAuthoring.Constants.minMediaLength);
            }

            function getAudioPropertiesHelper(file) {
                file.properties.getVideoPropertiesAsync().done(function (VideoProperties) {
                    mediaLengths.push(VideoProperties.duration / 1000); // get duration in seconds
                },
                function (error) {
                    console.log(error);
                });
            }

            if (title === &quot;Video (MP4)&quot;) {
                upldr = LADS.Authoring.FileUploader(root, LADS.Authoring.FileUploadTypes.Standard,
                function (files) {
                    var file;
                    for (i = 0; i &lt; files.length; i++) {
                        file = files[i];
                        names.push(file.displayName);
                        if (file.fileType === &#x27;.mp4&#x27; || file.type === &#x27;.ogg&#x27;) {
                            type = LADS.TourAuthoring.TrackType.video;
                            getAudioPropertiesHelper(file);
                        }
                    }
                },
                function (urls) {
                    var url, name, mediaLength;
                    for (i = 0; i &lt; urls.length; i++) {
                        url = urls[i];
                        name = names[i];
                        mediaLength = mediaLengths[i];
                        var track = timeline.addVideoTrack(url, name, null, mediaLength);
                        //console.log(&quot;mediaLength = &quot;+mediaLength);
                        //if (timeManager.getDuration().end &lt; mediaLength + timeManager.pxToTime(initLoc)) {
                        //    timeManager.setEnd(mediaLength + timeManager.pxToTime(initLoc));
                        //}

                        //track.addDisplay(initLoc, mediaLength);

                        var positionX = initLoc;
                        var displayLength = mediaLength;
                        //track.addDisplay(positionX, displayLength);
                        if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                        }
                        var diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                        var newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                             track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                             track.addDisplay(positionX, Math.min(diff, displayLength));
                        
                        if (timeline.getTracks().length &gt; 0) {
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                    }
                    undoManager.combineLast(2 * urls.length);
                    isUploading = false;
                    timeline.getDataHolder().mapTracks(function (container, i) {
                        container.track.updatePos(i);
                    });
                },
                [&#x27;.mp4&#x27;],
                false,
                function () {
                    root.append(LADS.Util.UI.popUpMessage(null, &quot;There was an error uploading the file.  Please try again later.&quot;));
                },
                true);
                upldr.setMaxDuration(LADS.TourAuthoring.Constants.maxTourLength);
                upldr.setMinDuration(LADS.TourAuthoring.Constants.minMediaLength);
            }
            if (title === &quot;Image&quot;) {
                LADS.Authoring.FileUploader(root, LADS.Authoring.FileUploadTypes.Standard,
                function (files) {
                    for (i = 0; i &lt; files.length; i++) {
                        names.push(files[i].displayName);
                    }
                },
                function (urls) {
                    for (i = 0; i &lt; urls.length; i++) {
                        var track = timeline.addImageTrack(urls[i], names[i].replace(/\&#x27;/, &#x27;&#x27;).replace(/\&quot;/, &#x27;&#x27;));
                        var dispLen = Math.min(5, timeManager.getDuration().end - timeManager.pxToTime(initLoc));
                        var newDisplay = (dispLen &lt; LADS.TourAuthoring.Constants.displayEpsilon) ? track.addDisplay(timeManager.timeToPx(timeManager.getDuration().end - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) : track.addDisplay(initLoc, dispLen);
                        if (dispLen &lt; 1.5 &amp;&amp; dispLen &gt;= LADS.TourAuthoring.Constants.displayEpsilon) {
                            newDisplay.setIn(0);
                            newDisplay.setOut(0);
                            newDisplay.setMain(dispLen);
                        }
                        
                        if (timeline.getTracks().length &gt; 0) { // reload tour?
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                    }
                    undoManager.combineLast(2 * urls.length);
                    isUploading = false;
                    timeline.getDataHolder().mapTracks(function (container, i) {
                        container.track.updatePos(i);
                    });
                },
                [&#x27;.jpg&#x27;, &#x27;.png&#x27;, &#x27;.gif&#x27;],
                false,
                function () {
                    root.append(LADS.Util.UI.popUpMessage(null, &quot;There was an error uploading the file.  Please try again later.&quot;));
                },
                true);
            }

        }

        // Ink subsection
        var dropInk = $(document.createElement(&#x27;div&#x27;));
        dropInk.css({
            &quot;left&quot;: &#x27;87%&#x27;,
            &#x27;margin-top&#x27;: &#x27;-16.5%&#x27;,
            &quot;position&quot;: &quot;relative&quot;,
            &quot;color&quot;: &quot;rgb(256, 256, 256)&quot;,
            &#x27;width&#x27;: &#x27;74%&#x27;,
            &#x27;background-color&#x27;: &#x27;rgba(0,0,0,0.95)&#x27;,
            &#x27;float&#x27;: &#x27;left&#x27;,
            &#x27;z-index&#x27;: LADS.TourAuthoring.Constants.aboveRinZIndex + 19
        });
        functionsPanel.append(dropInk);
        dropInk.hide();

        // create ink buttons
        _createAddComponentButton(&quot;Write&quot;, dropInk);
        _createAddComponentButton(&quot;Draw&quot;, dropInk);
        _createAddComponentButton(&quot;Highlight&quot;, dropInk);

        /**
         * Creates component menu buttons
         * @param title         Name of button
         * @param component     DOM element to add button to
         *@return addComponentButton     the button created.
         */
        function _createAddComponentButton(title, component) {
            var addComponentButton = $(document.createElement(&#x27;label&#x27;));
            if (title === &quot;From File&quot;)
                addComponentButton.addClass(&#x27;clickable &#x27; + &#x27;files&#x27;);
            else
                addComponentButton.addClass(&#x27;clickable &#x27; + title);
            addComponentButton.text(title);
            addComponentButton.css({
                &quot;left&quot;: &quot;0%&quot;,
                &quot;position&quot;: &quot;relative&quot;,
                &quot;font-size&quot;: LADS.Util.getFontSize(190),
                &quot;color&quot;: &quot;rgb(256, 256, 256)&quot;,
                &quot;display&quot;: &quot;block&quot;,
                &#x27;padding&#x27;: &#x27;4% 0 5% 0&#x27;,
                &#x27;text-indent&#x27;: &#x27;4%&#x27;,
                &#x27;z-index&#x27;: LADS.TourAuthoring.Constants.aboveRinZIndex + 19
            });

            addComponentButton.on(&#x27;mouseenter&#x27;, function () {
                var self = $(this);
                self.css({ &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;color&#x27;: &#x27;black&#x27; });

                switch (self.text()) {
                    case &quot;Artwork&quot;:
                    case &quot;Associated Media&quot;:
                        dropInk.hide();
                        dropFile.hide();
                        break;
                    case &quot;From File&quot;:
                        dropFile.show();
                        dropInk.hide();
                        break;
                    case &quot;Audio (MP3)&quot;:
                    case &quot;Video (MP4)&quot;:
                    case &quot;Image&quot;:
                        isInFileSubMenu = true;
                        break;
                    case &quot;Annotate&quot;:
                        if (allowInk) {
                            dropInk.show();
                            dropFile.hide();
                            //$(assetButton).data(&#x27;selected&#x27;, false);
                        }
                        else {
                            self.css({
                                &#x27;background-color&#x27;: &#x27;transparent&#x27;,
                                &#x27;color&#x27;: &#x27;gray&#x27;
                            });
                        }
                        break;
                    case &quot;Write&quot;:
                    case &quot;Draw&quot;:
                    case &quot;Highlight&quot;:
                        isInInkSubMenu = true;
                        break;
                }
            });

            addComponentButton.on(&#x27;mouseleave&#x27;, function () {
                var self = $(this);

                self.css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;white&#x27; });

                if (self.text() === &quot;Annotate&quot; &amp;&amp; !allowInk) {
                    self.css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;gray&#x27; });
                }

                if (fileClick || inkClick || isInFileSubMenu || isInInkSubMenu) {
                    return;
                }

                dropFile.hide();
                dropInk.hide();
            });

            addComponentButton.on(&#x27;mousedown&#x27;, function (evt) {
                evt.stopImmediatePropagation();
            });

            addComponentButton.on(&#x27;click&#x27;, function (evt) {
                if (timeline.getEditInkOn() === true) {
                    var messageBox = LADS.Util.UI.popUpMessage(null, &quot;An ink is already being edited.&quot;, null);
                    $(messageBox).css(&#x27;z-index&#x27;, LADS.TourAuthoring.Constants.aboveRinZIndex + 2000000);
                    $(&quot;#resizableArea&quot;).parent().parent().append(messageBox);
                    closeComponentMenu();
                    $(messageBox).fadeIn(500);
                    return;
                }

                evt.stopImmediatePropagation();

                var self = $(this);
                // reset css of any previously selected menu items
                for (var i = 0; i &lt; prevSelected.length; i++) {
                    if (self !== $(prevSelected[i])) {
                        ($(prevSelected[i])).css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;white&#x27; });
                    }
                }
                prevSelected[prevSelected.length] = this;

                //for being able to close addComponent by clicking away (only the following two have submenus)
                switch (self.text()) {
                    case &quot;Artwork&quot;: // change these to not check by title of the button! changing the button title will break this
                        exitInk();
                        self.css({
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;
                        });
                        hideInkControls();
                        removeInkCanv();
                        closeComponentMenu();
                        _catalogPick();
                    break;

                    case &quot;Associated Media&quot;:
                        exitInk();
                        self.css({
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;
                        });
                        inkButton.data(&#x27;selected&#x27;, false);
                        hideInkControls();
                        removeInkCanv();
                        closeComponentMenu();
                        _associatedMediaPick();
                        break;

                    case &quot;From File&quot;:
                        self.css({
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;
                        });
                        dropFile.show();
                        dropInk.hide();
                        assetButton.data(&#x27;selected&#x27;, false);
                        fileClick = true;
                        break;

                    case &quot;Audio (MP3)&quot;:
                    case &quot;Video (MP4)&quot;:
                    case &quot;Image&quot;:
                        closeComponentMenu();
                        exitInk();
                        hideInkControls();
                        removeInkCanv();
                        isInFileSubMenu = true;
                        // use call b/c this needs to be set in pickFile
                        pickFile.call(addComponentButton);
                        break;

                    case &quot;Annotate&quot;:
                        if (allowInk) {
                            self.css({
                                &#x27;background-color&#x27;: &#x27;white&#x27;,
                                &#x27;color&#x27;: &#x27;black&#x27;
                            });
                            dropInk.show();
                            dropFile.hide();
                            $(assetButton).data(&#x27;selected&#x27;, false);
                            inkClick = true;
                        }
                        break;

                    case &quot;Write&quot;:
                        $(&#x27;.undoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        $(&#x27;.redoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        self.css({
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;
                        });
                        inkButton.data(&#x27;selected&#x27;, false);
                        playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
                        closeComponentMenu();
                        hideInkControls();
                        inkTextControls.show();
                        var newHeight = $(&quot;#resizableArea&quot;).offset().top + $(&quot;#resizableArea&quot;).height() - inkTextControls.offset().top - 10;
                        inkTextControls.css({ &#x27;height&#x27;: newHeight});
                        initText();

                        //create an ink canvas and inkController
                        var inkdiv = createInkCanv();
                        var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
                        $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
                        inkAuthoring = p1;
                        p1.resetText();
                        p1.add_text_box();
                        p1.setFontColor(&quot;FFFFFF&quot;);
                        p1.setFontFamily(&quot;Times New Roman, serif&quot;);
                        p1.setFontSize(&quot;12&quot;);
                        p1.set_mode(LADS.TourAuthoring.InkMode.text);
                        p1.set_editable(); //in this case, we&#x27;re just making sure that the artwork can&#x27;t be manipulated
                        currentInkController = p1;
                        textArea.val(&quot;&quot;);
                        textBodyLabel1.text(&quot;&quot;);
                        colorTextLabel1.text(&quot;#FFFFFF&quot;);
                        $(&#x27;#textColorToggle&#x27;).attr(&#x27;value&#x27;, &quot;FFFFFF&quot;);
                        myPicker.fromString(&quot;FFFFFF&quot;);
                        $(&#x27;.changeColor&#x27;)[0].innerHTML = &quot;#&quot; + $(&quot;#textColorToggle&quot;).attr(&#x27;value&#x27;);
                        updateToggle(textArray, textArea);
                        timeline.setEditInkOn(true);
                        break;

                    case &quot;Draw&quot;:
                        $(&#x27;.undoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        $(&#x27;.redoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        self.css({ &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;color&#x27;: &#x27;black&#x27; });
                        playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
                        inkButton.data(&#x27;selected&#x27;, false);
                        closeComponentMenu();
                        hideInkControls();
                        inkDrawControls.css({ &#x27;display&#x27;: &#x27;block&#x27; });

                        // here, we set the initial height of the ink draw controls, so they can be resized appropriately
                        var raTop = $(&quot;#resizableArea&quot;).offset().top;
                        var raHeight = $(&quot;#resizableArea&quot;).height();
                        inkDrawControls.css(&quot;height&quot;, raTop + raHeight - inkDrawControls.offset().top - 10);

                        initDraw();
                        colorLabel1.text(&quot;#000000&quot;);
                        myPicker.fromString(&quot;000000&quot;); //jscolor picker

                        //create ink canvas and inkController
                        var inkdiv = createInkCanv();
                        var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
                        $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
                        inkAuthoring = p1;
                        p1.set_mode(LADS.TourAuthoring.InkMode.draw);
                        p1.set_editable(); // give the canvas pointer events
                        p1.updatePenWidth(&quot;brushSlider&quot;);
                        p1.updatePenColor(&quot;brushColorToggle&quot;);
                        p1.updatePenOpacity(&quot;opacitySlider&quot;);
                        currentInkController = p1;
                        timeline.setEditInkOn(true);

                        break;

                    case &quot;Highlight&quot;:
                        $(&#x27;.undoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        $(&#x27;.redoButton&#x27;).css({ &#x27;opacity&#x27;: &#x27;0.4&#x27; });
                        self.css({ &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;color&#x27;: &#x27;black&#x27; });
                        playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;inline-block&#x27; });
                        inkButton.data(&#x27;selected&#x27;, false);
                        closeComponentMenu();
                        hideInkControls();
                        inkTransparencyControls.show();
                        var newHeight = $(&quot;#resizableArea&quot;).offset().top + $(&quot;#resizableArea&quot;).height() - inkTransparencyControls.offset().top - 10;
                        inkTransparencyControls.css({ &#x27;height&#x27;: newHeight });
                        initTrans();

                        //create an ink canvas and inkController
                        var inkdiv = createInkCanv();
                        var p1 = new LADS.TourAuthoring.InkAuthoring(&quot;inkCanv&quot;, null, &quot;componentControls&quot;, spec);
                        $(&#x27;#inkCanv&#x27;).css(&quot;background&quot;, &quot;rgba(0,0,0,0.01)&quot;);
                        inkAuthoring = p1;
                        p1.set_mode(LADS.TourAuthoring.InkMode.shapes);
                        p1.set_editable(); //in this case, we&#x27;re just making sure that the artwork can&#x27;t be manipulated
                        currentInkController = p1;
                        timeline.setEditInkOn(true);
                        break;
                }

                // if this is already selected, unselect it -- this &#x27;selected&#x27; stuff might be unnecessary
                var selected = self.data(&#x27;selected&#x27;);
                if (selected) {
                    self.css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;white&#x27; });
                }
                self.data(&#x27;selected&#x27;, !selected);
                if (!allowInk) {
                    inkButton.css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;gray&#x27; });
                }
            });

            component.append(addComponentButton);
            return addComponentButton;
        }

        var prevSelected = [];
        var allowInk = false;
        var componentDropDown = false;
        var currentInkController;
        /**
         * Called when all artworks/images are deleted; disables ink functionality by graying out &quot;Ink&quot; button
         */
        function disableInk() {
            allowInk = false;
            inkButton.css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;gray&#x27; });
            dropInk.hide();
            inkTransparencyControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkTextControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkDrawControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkEditDraw.css({ &#x27;display&#x27;: &#x27;none&#x27;, });
            inkEditTransparency.css(&#x27;display&#x27;, &#x27;none&#x27;);
            inkEditText.css(&#x27;display&#x27;, &#x27;none&#x27;);
            timeline.setEditInkOn(false);
            timeline.setModifyingInk(false);
            //if ink is currently being edited but is unattached, remove it if there are no artworks left
            removeInkCanv();
        }
        that.disableInk = disableInk;

        function closeComponentMenu() {
            // set componentDropDown state to true
            // to force close
            componentDropDown = true;
            addComponentLabel.click();
        }

        addComponentLabel.on(&#x27;mousedown&#x27;, function (evt) {
            evt.stopImmediatePropagation();
        });

        /**
         * &quot;Add Component&quot; button click handler.
         * Allows user to drop menus and exit out of menus by clicking elsewhere.
         */
        addComponentLabel.click(function (evt) {
            if (timeline.getEditInkOn() === true) {
                return;
            }
            var i, prev,
                closeFunc = timeline.getCloseMenu();
            if (closeFunc &amp;&amp; closeFunc !== closeComponentMenu) {
                closeFunc();
            }

            //console.log(&#x27;addcomponent click&#x27;);

            evt.stopImmediatePropagation();

            // flip state
            componentDropDown = !componentDropDown;

            // hide submenus
            dropInk.hide();
            dropFile.hide();

            // close --&gt; open
            if (componentDropDown) {
                dropMain.show();

                root.on(&#x27;mousedown.componentMenu&#x27;, closeComponentMenu);

                timeline.setisMenuOpen(true);
                timeline.setCloseMenu(closeComponentMenu);

                timeManager.stop();

                addDropDownIconComponent.css({
                    &#x27;transform&#x27;: &#x27;scaleY(-1)&#x27;,
                    &#x27;margin-bottom&#x27;: &#x27;2%&#x27;
                });

                //reseting all menu items to normal font thickness
                $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });

                // Reset any selected menu items to regular CSS
                // and unselected state
                for (i = 0; i &lt; prevSelected.length; i++) {
                    prev = $(prevSelected[i]);
                    prev.css({
                        &#x27;background-color&#x27;: &#x27;transparent&#x27;,
                        &#x27;color&#x27;: &#x27;white&#x27;
                    });
                    prev.data(&#x27;selected&#x27;, false);
                }

                // check to see if ink can be added
                // (only allow ink if there are artworks or images)
                if (!timeline.checkForArtworks(0)) {
                    allowInk = false;
                    inkButton.css({
                        &#x27;background-color&#x27;: &#x27;transparent&#x27;,
                        &#x27;color&#x27;: &#x27;gray&#x27;
                    });
                }
                else {
                    allowInk = true;
                    inkButton.css({
                        &#x27;background-color&#x27;: &#x27;transparent&#x27;,
                        &#x27;color&#x27;: &#x27;white&#x27;
                    });
                }
            }

            // open --&gt; close
            else {
                dropMain.hide();

                root.off(&#x27;mousedown.componentMenu&#x27;);
                timeline.setCloseMenu(null);
                timeline.setisMenuOpen(false);

                addDropDownIconComponent.css({
                    &#x27;transform&#x27;: &#x27;scaleY(1)&#x27;,
                    &#x27;margin-bottom&#x27;: &#x27;0%&#x27;
                });
            }
        });

        /**
         * Hover colors for &quot;Add Component&quot; menu items
         */
        var isInFileSubMenu = false;
        var isInInkSubMenu = false;
        var fileClick = true;
        var inkClick = true;

        /**
         * Creates catalog picker for associated media related to the artwork already imported into the tour (Jessica Fu)
         */
        // picker
        associatedMediaPicker.addClass(&quot;associatedMediaPicker&quot;);
        associatedMediaPicker.css({
            position: &#x27;absolute&#x27;,
            width: &#x27;49%&#x27;,
            height: &#x27;49%&#x27;,
            padding: &#x27;1%&#x27;,
            &#x27;background-color&#x27;: &#x27;black&#x27;,
            &#x27;border&#x27;: &#x27;3px double white&#x27;,
            top: &#x27;25%&#x27;,
            left: &#x27;25%&#x27;,
        });
        $(associatedMediaPickerOverlay).append(associatedMediaPicker);

        // heading
        var associatedMediaPickerHeader = document.createElement(&#x27;div&#x27;);
        $(associatedMediaPickerHeader).addClass(&#x27;associatedMediaPickerInfo&#x27;);
        $(associatedMediaPickerHeader).text(&quot;Select media to import&quot;);
        $(associatedMediaPickerHeader).css({
            &#x27;font-size&#x27;: &#x27;200%&#x27;,
        });
        var associatedsearchbar = $(document.createElement(&#x27;input&#x27;));
        associatedsearchbar.attr(&#x27;type&#x27;, &#x27;text&#x27;);
        $(associatedsearchbar).css({
            &#x27;float&#x27;: &#x27;right&#x27;,
            &#x27;margin-right&#x27;: &#x27;3%&#x27;,
            &#x27;margin-top&#x27;: &#x27;0.75%&#x27;,
            &#x27;width&#x27;: &#x27;38%&#x27;
        });
        $(associatedsearchbar).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });
        associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
        associatedsearchbar.val(&quot;&quot;);
        //LADS.Util.defaultVal(PICKER_SEARCH_TEXT, associatedsearchbar, true, IGNORE_IN_SEARCH);
        associatedsearchbar.keyup(function () {
            LADS.Util.searchData(associatedsearchbar.val(), &#x27;.mediaHolder&#x27;, IGNORE_IN_SEARCH);
        });
        associatedsearchbar.change(function () {
            LADS.Util.searchData(associatedsearchbar.val(), &#x27;.mediaHolder&#x27;, IGNORE_IN_SEARCH);
        });
        $(associatedMediaPickerHeader).append(associatedsearchbar);

        associatedMediaPicker.append(associatedMediaPickerHeader);

        // list of artworks in tour that have associated media
        var associatedMediaPickerArtwork = document.createElement(&#x27;div&#x27;);
        $(associatedMediaPickerArtwork).addClass(&#x27;associatedMediaPickerArtwork&#x27;);
        $(associatedMediaPickerArtwork).css({
            position: &#x27;absolute&#x27;,
            &#x27;border-right&#x27;: &#x27;1px solid white&#x27;,
            top: &#x27;15%&#x27;,
            padding: &#x27;1%&#x27;,
            height: &#x27;72%&#x27;,
            width: &#x27;28%&#x27;,
            overflow: &#x27;auto&#x27;,
        });
        associatedMediaPicker.append(associatedMediaPickerArtwork);

        // list of associated media
        var associatedMediaPickerMedia = document.createElement(&#x27;div&#x27;);
        $(associatedMediaPickerMedia).addClass(&#x27;associatedMediaPickerMedia&#x27;);
        $(associatedMediaPickerMedia).css({
            position: &#x27;absolute&#x27;,
            left: &#x27;33%&#x27;,
            top: &#x27;15%&#x27;,
            padding: &#x27;1%&#x27;,
            height: &#x27;72%&#x27;,
            width: &#x27;62%&#x27;,
            overflow: &#x27;auto&#x27;,
        });
        associatedMediaPicker.append(associatedMediaPickerMedia);

        /**
         * Get associated media for all artworks in the tour from the server.
         * Creates the media picker dom elements.
         */
        var selectedArtworks = [];
        var artworkIndicesViaURL = [];
        var selectedArtworksUrls = {};
        function _associatedMediaPick() {
            selectedArtworks = [];
            artworkIndicesViaURL = [];
            selectedArtworksUrls = {};
            isUploading = true;
            $(associatedMediaPickerOverlay).fadeIn();
            mediaQueue.clear();

            //create a loading circle(to be displayed while artworks are loading)
            var loading = $(document.createElement(&#x27;div&#x27;));
            loading.css({
                &#x27;display&#x27;: &#x27;inline-block&#x27;,
                &#x27;position&#x27;: &#x27;absolute&#x27;,
                &#x27;left&#x27;: &#x27;3%&#x27;,
                &#x27;bottom&#x27;: &#x27;2%&#x27;,
            });
            loading.text(&#x27;Loading...&#x27;);
            loading.attr(&#x27;id&#x27;, &#x27;associatedLoadingLabel&#x27;);

            var circle = $(document.createElement(&#x27;img&#x27;));
            circle.attr(&#x27;src&#x27;, &#x27;images/icons/progress-circle.gif&#x27;);
            circle.css({
                &#x27;height&#x27;: &#x27;12px&#x27;,
                &#x27;width&#x27;: &#x27;auto&#x27;,
                &#x27;margin-left&#x27;: &#x27;20px&#x27;,
                &#x27;float&#x27;: &#x27;right&#x27;,
            });
            loading.append(circle);

            associatedMediaPicker.append(loading);


            var myArtwork = timeline.getRelatedArtworks();


            // draw &quot;All Associated Media&quot; Label
            var allAssociatedMediaHolder = document.createElement(&#x27;div&#x27;);
            $(allAssociatedMediaHolder).addClass(&#x27;allAssociatedMediaHolder&#x27;);
            $(allAssociatedMediaHolder).css({
                width: &#x27;100%&#x27;,
                height: &#x27;9%&#x27;,
                margin: &#x27;1px 0px 1px 0px&#x27;,
                background: &#x27;#999&#x27;,
                &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                &#x27;padding-top&#x27;: &#x27;3%&#x27;,
            });
            $(allAssociatedMediaHolder).text(&#x27;All Associated Media&#x27;);
            $(associatedMediaPickerArtwork).append(allAssociatedMediaHolder);

            var mediaCache = {};

            // draw artwork name labels
            var myFilteredArtwork = [];
            var unique;
            for (var i = 0; i &lt; myArtwork.length ; i++) {
                unique = true;
                for (var j = 0; j &lt; i; j++) {
                    if (myArtwork[j] === myArtwork[i]) {
                        unique = false;
                        break;
                    }
                }
                //unique ? myFilteredArtwork.push(myArtwork[i]) : {};
                if (unique) {
                    myFilteredArtwork.push(myArtwork[i]);
                }
            }
            for (var k = 0; k &lt; myFilteredArtwork.length; k++) {
                getArt(k);
            }

            loading.hide(); //hides the loading circle once art is recieved

            //single clicking on associated media selects it, to be imported
            function mediasingleClick(e, mediaHolder) {
                if (mediaHolder) {
                    var index;
                    //$(&quot;.mediaHolder&quot;).css(&#x27;background&#x27;, &#x27;#222&#x27;);
                    if (mediaHolder.data(&quot;selected&quot;)) {
                        mediaHolder.data(&quot;selected&quot;, false);
                        mediaHolder.css(&#x27;background&#x27;, &#x27;#222&#x27;);
                        index = artworkIndicesViaURL.indexOf(mediaHolder.data(&#x27;url&#x27;));
                        selectedArtworks.splice(index, 1);
                        artworkIndicesViaURL.splice(index, 1);
                        selectedArtworksUrls[mediaHolder.data(&#x27;url&#x27;)] = false;
                        associatedMediaPickerImport.disabled = selectedArtworks.length ? false : true;
                    }
                    else {
                        mediaHolder.data({
                            &quot;selected&quot;: true
                        });
                        mediaHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                        selectedArtworks.push({ &#x27;url&#x27;: mediaHolder.data(&#x27;url&#x27;), &#x27;name&#x27;: mediaHolder.data(&#x27;name&#x27;), &#x27;id&#x27;: mediaHolder.attr(&#x27;id&#x27;), &#x27;type&#x27;: mediaHolder.data(&#x27;type&#x27;), &#x27;duration&#x27;: mediaHolder.data(&#x27;duration&#x27;) });
                        artworkIndicesViaURL.push(mediaHolder.data(&#x27;url&#x27;));
                        selectedArtworksUrls[mediaHolder.data(&#x27;url&#x27;)] = true;
                        associatedMediaPickerImport.disabled = false;
                    }
                }
            }

            //double clicking on associated media will import all selected media
            function mediadoubleClick(e,mediaHolder) {
                if (mediaHolder) {
                    var i, selectedArt, track, positionX, displayLength, newDisplay, diff;
                    mediaHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                    
                    if (mediaHolder.data(&#x27;selected&#x27;) !== true) {
                        selectedArtworks.push({ &#x27;url&#x27;: mediaHolder.data(&#x27;url&#x27;), &#x27;name&#x27;: mediaHolder.data(&#x27;name&#x27;), &#x27;id&#x27;: mediaHolder.attr(&#x27;id&#x27;), &#x27;type&#x27;: mediaHolder.data(&#x27;type&#x27;), &#x27;duration&#x27;: mediaHolder.data(&#x27;duration&#x27;) });
                        mediaHolder.data({
                        &quot;selected&quot;: true
                    });}
                    _clearAssMedia(); // interesting name....
                    $(associatedMediaPickerOverlay).fadeOut();
                    //console.log(selectedArt.type);
                    associatedMediaPickerImport.disabled = true;
                    associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                    if (selectedArtworks &amp;&amp; selectedArtworks.length) {
                        for (i = 0; i &lt; selectedArtworks.length; i++) {
                            selectedArt = selectedArtworks[i];
                            if (selectedArt.type === &quot;Video&quot;) {
                                track = timeline.addVideoTrack(selectedArt.url, selectedArt.name, null, selectedArt.duration);
                                positionX = timeManager.getCurrentPx();
                                displayLength = parseFloat(selectedArt.duration);
                                // track.addDisplay(positionX, displayLength);
                                if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                                    timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                                }
                                diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                                newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                                     track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                                     track.addDisplay(positionX, Math.min(diff, displayLength));
                                if (timeline.getTracks().length &gt; 0) {
                                    timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                                }
                            } else if (selectedArt.type === &quot;Image&quot;) {
                                track = timeline.addImageTrack(selectedArt.url, selectedArt.name);
                                positionX = timeManager.getCurrentPx();
                                displayLength = 5;
                                var dispLen = Math.min(displayLength, timeManager.getDuration().end - timeManager.pxToTime(positionX));
                                newDisplay = (dispLen &lt; LADS.TourAuthoring.Constants.displayEpsilon) ? track.addDisplay(timeManager.timeToPx(timeManager.getDuration().end - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) : track.addDisplay(positionX, dispLen);
                                if (dispLen &lt; 1.5 &amp;&amp; dispLen &gt;= LADS.TourAuthoring.Constants.displayEpsilon) {
                                    newDisplay.setIn(0);
                                    newDisplay.setOut(0);
                                    newDisplay.setMain(dispLen);
                                }
                                if (timeline.getTracks().length &gt; 0) {
                                    timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                                }
                            } else if (selectedArt.type === &quot;Audio&quot;) {
                                track = timeline.addAudioTrack(selectedArt.url, selectedArt.name, null, selectedArt.duration);
                                positionX = timeManager.getCurrentPx();
                                displayLength = parseFloat(selectedArt.duration);
                                //if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                                //    timeManager.setEnd(displayLength + timeManager.pxToTime(positionX));
                                //}
                                //track.addDisplay(positionX, displayLength);
                                if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                                    timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                                }
                                diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                                newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                                     track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                                     track.addDisplay(positionX, Math.min(diff, displayLength));
                                if (timeline.getTracks().length &gt; 0) {
                                    timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                                }
                            } else {
                                console.log(&#x27;Unrecognized file type imported!!!???&#x27;);
                            }
                        }
                        undoManager.combineLast(2 * selectedArtworks.length);
                    }
                }
                associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                associatedsearchbar.val(&quot;&quot;);
                isUploading = false;
                timeline.getDataHolder().mapTracks(function (container, i) {
                    container.track.updatePos(i);
                });
            }

            //this handles discriminating between the double and single clicks for importing media
            //cleans up bugs where both click events were firing and media would import twice
            function assMediasingleDoubleclick(mediaHolder) {
                mediaHolder.click(function (e) {
                    var that = this;
                    setTimeout(function () {
                        var dblclick = parseInt($(that).data(&#x27;double&#x27;), 10);
                        if (dblclick &gt; 0) {
                            $(that).data(&#x27;double&#x27;, dblclick - 1);
                        } else {
                            mediasingleClick.call(that, e, mediaHolder);
                        }
                    }, 300);
                }).dblclick(function (e) {
                    $(this).data(&#x27;double&#x27;, 2);
                    mediadoubleClick.call(this, e, mediaHolder);
                });
            }
            
            function getArt(i) {
                // get associated media and cache them in array associated with the guid of each artwork
                LADS.Worktop.Database.getAssocMediaTo(myFilteredArtwork[i], function (doqs) {
                    doqs.sort(function (a, b) {
                        return a.Name.toLowerCase() &lt; b.Name.toLowerCase() ? -1 : 1;
                    });
                    var mediaArray = [];
                    if (doqs) {
                        var k = 0;
                        var doq;
                        for (var j = 0; j &lt; doqs.length; j++) {
                            //var hotspotDoqID = linqs[j].Targets.BubbleRef[1].BubbleContentID;
                            k++;
                            doq = doqs[j];
                            var c1 = (doq.Metadata.ContentType === &#x27;Video&#x27; || doq.Metadata.ContentType === &#x27;Audio&#x27;);
                            var c2 = (doq.Metadata.Duration &lt;= LADS.TourAuthoring.Constants.maxTourLength &amp;&amp; doq.Metadata.Duration &gt;= LADS.TourAuthoring.Constants.minMediaLength);
                            var c3 = (c2 || doq.Metadata.Duration === undefined);
                            if ((c1 &amp;&amp; c3) || doq.Metadata.ContentType === &#x27;Image&#x27;) {//make sure no text associated media for now
                                mediaArray.push(doq);
                            }
                            if (k === doqs.length) { // just put this outside loop
                                mediaCache[myFilteredArtwork[i]] = mediaArray;
                                if (mediaArray.length &gt; 0) { //only shows artworks with at least one associated media
                                    var mediaHolderDocfrag = document.createDocumentFragment();
                                    drawAssociatedMedia(mediaCache[myFilteredArtwork[i]], assMediasingleDoubleclick, mediaHolderDocfrag);// create dom elements for this artwork&#x27;s associated media
                                    // retrieve titles of artworks that have at least one associated media, create divs for them in the artwork list
                                    LADS.Worktop.Database.getDoq(myFilteredArtwork[i], function (nextArt) {
                                        var name;
   
                                        if (nextArt.Name.length &gt; 15) {
                                            var hasSpace = false;
                                            var scanLength = Math.min(nextArt.Name.length, 25);
                                            for (var j = 14; j &lt; scanLength ; j++) {
                                                if (nextArt.Name[j] === &quot; &quot; &amp;&amp; !hasSpace) {
                                                    name = nextArt.Name.substr(0, j) + &quot;...&quot;;
                                                    hasSpace = true;
                                                } else if (nextArt.Name[j] === &quot;-&quot; &amp;&amp; j !== (scanLength - 1) &amp;&amp; !hasSpace) {
                                                    if (nextArt.Name[j + 1] === &quot; &quot;) {
                                                        name = nextArt.Name.substr(0, j) + &quot;...&quot;;
                                                        hasSpace = true;
                                                    }
                                                }
                                            }
                                            if (!hasSpace) {
                                                name = nextArt.Name.substr(0, 25) + &quot;...&quot;;
                                            }
                                        } else {
                                            name = nextArt.Name;
                                        }

                                        var artworkHolder = document.createElement(&#x27;div&#x27;);
                                        $(artworkHolder).addClass(&#x27;artworkHolder&#x27;);
                                        $(artworkHolder).attr(&#x27;id&#x27;, nextArt.Identifier);
                                        $(artworkHolder).css({
                                            width: &#x27;100%&#x27;,
                                            height: &#x27;9%&#x27;,
                                            margin: &#x27;1px 0px 1px 0px&#x27;,
                                            &#x27;font-size&#x27;: &#x27;100%&#x27;,
                                            &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                                            &#x27;padding-top&#x27;: &#x27;3%&#x27;,
                                        });
                                        $(artworkHolder).text(name);
                                        $(associatedMediaPickerArtwork).append(artworkHolder);
                                        artworkHolderClick($(artworkHolder));
                                    });
                                }
                            }
                        }
                    }
                });
            }

            // &quot;All Associated Media&quot; button click handler
            $(allAssociatedMediaHolder).click(function () {
                $(&quot;.artworkHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                $(allAssociatedMediaHolder).css(&#x27;background&#x27;, &#x27;#999&#x27;);
                $(&quot;.mediaHolder&quot;).detach();
                for (var i = 0; i &lt; myArtwork.length; i++) {
                    var allAMDocfrag = document.createDocumentFragment();
                    drawAssociatedMedia(mediaCache[myFilteredArtwork[i]], assMediasingleDoubleclick, allAMDocfrag);
                }
                associatedMediaPickerImport.disabled = selectedArtworks.length ? false : true;
                LADS.Util.searchData(associatedsearchbar.val(), &#x27;.mediaHolder&#x27;, IGNORE_IN_SEARCH);
            });

            // click handlers for all artwork name buttons
            function artworkHolderClick(artworkHolder) {
                
                artworkHolder.off(&#x27;click&#x27;);
                artworkHolder.on(&#x27;click&#x27;, function () {
                    mediaQueue.clear();
                    $(&quot;.allAssociatedMediaHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                    $(&quot;.artworkHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                    artworkHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                    var selected = artworkHolder.attr(&#x27;id&#x27;);
                    $(&quot;.mediaHolder&quot;).detach();
                    var artworkAMDocfrag = document.createDocumentFragment();
                    drawAssociatedMedia(mediaCache[selected], assMediasingleDoubleclick, artworkAMDocfrag);
                    associatedMediaPickerImport.disabled = selectedArtworks.length ? false : true;
                    LADS.Util.searchData(associatedsearchbar.val(), &#x27;.mediaHolder&#x27;, IGNORE_IN_SEARCH);
                });
            }

            // create import button
            var associatedMediaPickerImport = document.createElement(&#x27;button&#x27;);
            associatedMediaPickerImport.disabled = true;
            $(associatedMediaPickerImport).text(&quot;Import&quot;);
            $(associatedMediaPickerImport).css({
                position: &#x27;absolute&#x27;,
                bottom: &#x27;1%&#x27;,
                right: &#x27;22%&#x27;,
            });

            // click handler for import button -- perform the import using selectedArtworks.*
            $(associatedMediaPickerImport).click(function () {
                var selectedArt, i, track, positionX, newDisplay, dispLen, displayLength, diff;
                _clearAssMedia(); // interesting name....
                $(associatedMediaPickerOverlay).fadeOut();
                //console.log(selectedArt.type);
                associatedMediaPickerImport.disabled = true;
                associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                if (selectedArtworks &amp;&amp; selectedArtworks.length) {
                    for (i = 0; i &lt; selectedArtworks.length; i++) {
                        selectedArt = selectedArtworks[i];
                        if (selectedArt.type === &quot;Video&quot;) {
                            track = timeline.addVideoTrack(selectedArt.url, selectedArt.name,null,selectedArt.duration);
                            positionX = timeManager.getCurrentPx();
                            displayLength = parseFloat(selectedArt.duration);
                            //if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            //    timeManager.setEnd(displayLength + timeManager.pxToTime(positionX));
                            //}
                            //track.addDisplay(positionX, displayLength);
                            //track.addDisplay(positionX, displayLength);
                            if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                                timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                            }
                            diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                            newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                                 track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                                 track.addDisplay(positionX, Math.min(diff, displayLength));
                            if (timeline.getTracks().length &gt; 0) {
                                timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                            }
                        } else if (selectedArt.type === &quot;Image&quot;) {
                            track = timeline.addImageTrack(selectedArt.url, selectedArt.name);
                            positionX = timeManager.getCurrentPx();
                            displayLength = 5;
                            dispLen = Math.min(displayLength, timeManager.getDuration().end - timeManager.pxToTime(positionX));
                            newDisplay = (dispLen &lt; LADS.TourAuthoring.Constants.displayEpsilon) ? track.addDisplay(timeManager.timeToPx(timeManager.getDuration().end - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) : track.addDisplay(positionX, dispLen);
                            if (dispLen &lt; 1.5 &amp;&amp; dispLen &gt;= LADS.TourAuthoring.Constants.displayEpsilon) {
                                newDisplay.setIn(0);
                                newDisplay.setOut(0);
                                newDisplay.setMain(dispLen);
                            }
                            if (timeline.getTracks().length &gt; 0) {
                                timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                            }
                        } else if (selectedArt.type === &quot;Audio&quot;) {
                            track = timeline.addAudioTrack(selectedArt.url, selectedArt.name,null,selectedArt.duration);
                            positionX = timeManager.getCurrentPx();
                            displayLength = parseFloat(selectedArt.duration);
                            //if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            //    timeManager.setEnd(displayLength + timeManager.pxToTime(positionX));
                            //}
                            //track.addDisplay(positionX, displayLength);
                            //track.addDisplay(positionX, displayLength);
                            if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                                timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                            }
                            diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                            newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                                 track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                                 track.addDisplay(positionX, Math.min(diff, displayLength));
                            if (timeline.getTracks().length &gt; 0) {
                                timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                            }
                        } else {
                            console.log(&#x27;Unrecognized file type imported!!!???&#x27;);
                        }
                    }
                    undoManager.combineLast(2 * selectedArtworks.length);
                }
                associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                associatedsearchbar.val(&quot;&quot;);
                isUploading = false;
                timeline.getDataHolder().mapTracks(function (container, i) {
                    container.track.updatePos(i);
                });
            });
            associatedMediaPicker.append(associatedMediaPickerImport);


            // cancel button
            var associatedMediaPickerCancel = document.createElement(&#x27;button&#x27;);
            $(associatedMediaPickerCancel).text(&quot;Cancel&quot;);
            $(associatedMediaPickerCancel).css({
                position: &#x27;absolute&#x27;,
                bottom: &#x27;1%&#x27;,
                right: &#x27;5%&#x27;//$(&#x27;button&#x27;).width() + 15,
            });

            // cancel button click handler
            $(associatedMediaPickerCancel).click(function () {
                _clearAssMedia();
                $(associatedMediaPickerOverlay).fadeOut();
                associatedMediaPickerImport.disabled = true;
                associatedsearchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                associatedsearchbar.val(&quot;&quot;);
                return undefined;
            });
            associatedMediaPicker.append(associatedMediaPickerCancel);

            // detach picker elements
            function _clearAssMedia() {
                $(&quot;.mediaHolder&quot;).detach();
                $(&quot;.artworkHolder&quot;).detach();
                $(&quot;.allAssociatedMediaHolder&quot;).detach();
                $(&#x27;#associatedLoadingLabel&#x27;).detach();
            }
        }

        /** 
         * Creates the media panel for the media associated to a given artwork. Each is given a .mediaHolder-class container.
         * @param mediaArray   the list of media to appear in the panel
         */
        function drawAssociatedMedia(mediaArray, applyClick, docfrag) {
            //mediaQueue.clear();
            if (mediaArray) {
                for (var i = 0; i &lt; mediaArray.length; i++) {
                    mediaQueue.add(createMediaHolder(mediaArray[i], applyClick));
                }
            }
            //$(associatedMediaPickerMedia).append(docfrag);
        }

        function createMediaHolder(media, applyClick) {
            return function () {
                var mediaHolder = $(document.createElement(&#x27;div&#x27;));
                mediaHolder.addClass(&quot;mediaHolder&quot;);
                mediaHolder.attr(&#x27;id&#x27;, media.Identifier); // unique identifier for this media
                mediaHolder.data(&#x27;type&#x27;, media.Metadata.ContentType);
                mediaHolder.data(&#x27;url&#x27;, media.Metadata.Source); // store url as data
                mediaHolder.data(&#x27;name&#x27;, media.Name);
                mediaHolder.data(&#x27;duration&#x27;, media.Metadata.Duration);
                var isSelected = selectedArtworksUrls[media.Metadata.Source] ? true : false;
                mediaHolder.data(&#x27;selected&#x27;, isSelected);
                mediaHolder.css({
                    float: &#x27;left&#x27;,
                    background: isSelected ? &#x27;#999&#x27; : &#x27;#222&#x27;,
                    width: &#x27;48%&#x27;,
                    height: &#x27;25%&#x27;,
                    padding: &#x27;2px&#x27;,
                    margin: &#x27;1px&#x27;,
                });
                $(associatedMediaPickerMedia).append(mediaHolder);
                //docfrag.appendChild(mediaHolder);
                //create holder for thumbnails
                var mediaHolderImageHolder = $(document.createElement(&#x27;div&#x27;));
                mediaHolderImageHolder.addClass(&#x27;mediaHolderImageHolder&#x27;);
                mediaHolderImageHolder.css({
                    float: &#x27;left&#x27;,
                    width: &#x27;40%&#x27;,
                    margin: &#x27;3.5%&#x27;,
                    height: &#x27;80%&#x27;,
                    &#x27;overflow&#x27;: &#x27;hidden&#x27;
                });
                mediaHolder.append(mediaHolderImageHolder);


                // create the thumbnail to show in the media holder
                var mediaHolderImage = $(document.createElement(&#x27;img&#x27;));
                mediaHolderImage.addClass(&#x27;mediaHolderImage&#x27;);
                if (media.Metadata.ContentType === &#x27;Audio&#x27;) {
                    mediaHolderImage.attr(&#x27;src&#x27;, &#x27;images/audio_icon.svg&#x27;);
                }
                else if (media.Metadata.ContentType === &#x27;Video&#x27;) {
                    mediaHolderImage.attr(&#x27;src&#x27;, (media.Metadata.Thumbnail &amp;&amp; !media.Metadata.Thumbnail.match(/.mp4/)) ? LADS.Worktop.Database.fixPath(media.Metadata.Thumbnail) : &#x27;images/video_icon.svg&#x27;);
                }
                else if (media.Metadata.ContentType === &#x27;Image&#x27;) {
                    mediaHolderImage.attr(&#x27;src&#x27;, media.Metadata.Thumbnail ? LADS.Worktop.Database.fixPath(media.Metadata.Thumbnail) : &#x27;images/image_icon.svg&#x27;);
                }
                else {//text associated media without any media...
                    mediaHolderImage.attr(&#x27;src&#x27;, &#x27;images/text_icon.svg&#x27;);
                }
                mediaHolderImage.css({
                    float: &#x27;left&#x27;,
                    &#x27;height&#x27;: &#x27;100%&#x27;,
                    &#x27;max-height&#x27;: &#x27;100%&#x27;,
                    &#x27;text-align&#x27;: &#x27;center&#x27;
                });
                mediaHolderImage.removeAttr(&#x27;width&#x27;);
                mediaHolderImageHolder.append(mediaHolderImage);

                // create the text to show in the media holder
                var mediaHolderText = $(document.createElement(&#x27;div&#x27;));
                mediaHolderText.addClass(&#x27;mediaHolderText&#x27;);
                //trims off long names
                var name;

                var name = media.Name;
                if (name.length &gt; 15) {
                    var hasSpace = false;
                    var scanLength = Math.min(name.length, 24);
                    for (var i = 14; i &lt; scanLength ; i++) {
                        if (name[i] === &quot; &quot; &amp;&amp; !hasSpace) {
                            name = name.substr(0, i) + &quot;...&quot;;
                            hasSpace = true;
                        } else if (name[i] === &quot;-&quot; &amp;&amp; i !== (scanLength - 1) &amp;&amp; !hasSpace) {
                            if (name[i + 1] === &quot; &quot;) {
                                name = name.substr(0, i) + &quot;...&quot;;
                                hasSpace = true;
                            }
                        }
                    }
                    if (!hasSpace) {
                        name = name.substr(0, 16) + &quot;...&quot;;
                    }
                }
                mediaHolderText.text(name);
                mediaHolderText.css({
                    floar: &#x27;left&#x27;,
                    &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                    &#x27;padding-right&#x27;: &#x27;4.5%&#x27;,
                    &#x27;font-size&#x27;: &#x27;100%&#x27;,
                    &#x27;margin&#x27;: &#x27;5% 0 5% 2%&#x27;,
                    &#x27;overflow&#x27;: &#x27;hidden&#x27;,
                    &#x27;word-wrap&#x27;: &#x27;break-word&#x27;,
                });
                mediaHolder.append(mediaHolderText);
                applyClick(mediaHolder);
            }
        }

        // creates catalogPicker for artwork import
        catalogPicker.addClass(&quot;catalogPicker&quot;);
        catalogPicker.css({
            position: &#x27;absolute&#x27;,
            width: &#x27;49%&#x27;,
            height: &#x27;49%&#x27;,
            padding: &#x27;1%&#x27;,
            &#x27;background-color&#x27;: &#x27;black&#x27;,
            &#x27;border&#x27;: &#x27;3px double white&#x27;,
            top: &#x27;25%&#x27;,
            left: &#x27;25%&#x27;,
        });
        $(catalogPickerOverlay).append(catalogPicker);


        // creates the header for the artwork catalog picker
        var catalogPickerHeader = document.createElement(&#x27;div&#x27;);
        $(catalogPickerHeader).addClass(&#x27;catalogPickerInfo&#x27;);
        $(catalogPickerHeader).text(&quot;Select artwork to import&quot;);
        $(catalogPickerHeader).css({
            &#x27;font-size&#x27;: &#x27;200%&#x27;,
            &#x27;float&#x27;: &#x27;left&#x27;,
        });
        catalogPicker.append(catalogPickerHeader);

        var searchbar = $(document.createElement(&#x27;input&#x27;));
        searchbar.attr(&#x27;type&#x27;, &#x27;text&#x27;);
        $(searchbar).css({
            &#x27;float&#x27;: &#x27;right&#x27;,
            &#x27;margin-right&#x27;: &#x27;3%&#x27;,
            &#x27;margin-top&#x27;: &#x27;0.75%&#x27;,
            &#x27;width&#x27;: &#x27;38%&#x27;
        });
        $(searchbar).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });

        searchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
        //LADS.Util.defaultVal(PICKER_SEARCH_TEXT, searchbar, true, IGNORE_IN_SEARCH);
        searchbar.keyup(function () {
            LADS.Util.searchData(searchbar.val(), &#x27;.artButton&#x27;, IGNORE_IN_SEARCH);
        });
        searchbar.change(function () {
            LADS.Util.searchData(searchbar.val(), &#x27;.artButton&#x27;, IGNORE_IN_SEARCH);
        });
        catalogPicker.append(searchbar);

        // creates the exhibitions panel in the artwork catalog picker
        var catalogPickerExhibitions = document.createElement(&#x27;div&#x27;);
        $(catalogPickerExhibitions).addClass(&#x27;catalogPickerExhibitions&#x27;);
        $(catalogPickerExhibitions).css({
            position: &#x27;absolute&#x27;,
            &#x27;border-right&#x27;: &#x27;1px solid white&#x27;,
            top: &#x27;13%&#x27;,
            padding: &#x27;1%&#x27;,
            height: &#x27;73%&#x27;,
            width: &#x27;28%&#x27;,
            overflow: &#x27;auto&#x27;,
        });
        catalogPicker.append(catalogPickerExhibitions);

        // creates the artwork panel in the artwork catalog picker
        var catalogPickerArtworks = document.createElement(&#x27;div&#x27;);
        $(catalogPickerArtworks).addClass(&#x27;catalogPickerArtworks&#x27;);
        $(catalogPickerArtworks).css({
            position: &#x27;absolute&#x27;,
            left: &#x27;33%&#x27;,
            top: &#x27;13%&#x27;,
            padding: &#x27;1%&#x27;,
            height: &#x27;73%&#x27;,
            width: &#x27;62%&#x27;,
            overflow: &#x27;auto&#x27;,
        });
        catalogPicker.append(catalogPickerArtworks);

        /**
         * Gets artwork from server, displays catalogPicker
         * @return artwork id
         */
        function _catalogPick() {
            selectedArtworks = [];
            selectedArtworksUrls = {};
            artworkIndicesViaURL = [];
            isUploading = true;
            var selectedExhib;
            artQueue.clear();
            //var artworks = [];//LADS.Worktop.Database.getAllArtworks(); // there is a try/catch in Worktop.Database.js to help with xml errors
            //var exhibitions = [];//LADS.Worktop.Database.getExhibitions(); // check Worktop.Database.js if any server response problems come up

            // draw &quot;All Artworks&quot; exhibition container
            var allArtworksHolder = document.createElement(&#x27;div&#x27;);
            $(allArtworksHolder).addClass(&#x27;allArtworksHolder&#x27;);
            $(allArtworksHolder).css({
                width: &#x27;100%&#x27;,
                height: &#x27;9%&#x27;,
                margin: &#x27;1px 0px 1px 0px&#x27;,
                background: &#x27;#999&#x27;,
                &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                &#x27;padding-top&#x27;: &#x27;3%&#x27;,
            });
            $(allArtworksHolder).text(&#x27;All Artworks&#x27;);
            $(catalogPickerExhibitions).append(allArtworksHolder);

            var loading = $(document.createElement(&#x27;div&#x27;));
            loading.css({
                &#x27;display&#x27;: &#x27;inline-block&#x27;,
                &#x27;position&#x27;: &#x27;absolute&#x27;,
                &#x27;left&#x27;: &#x27;3%&#x27;,
                &#x27;bottom&#x27;: &#x27;2%&#x27;,
            });
            loading.text(&#x27;Loading...&#x27;);
            loading.attr(&#x27;id&#x27;, &#x27;loadingLabel&#x27;);

            var circle = $(document.createElement(&#x27;img&#x27;));
            circle.attr(&#x27;src&#x27;, &#x27;images/icons/progress-circle.gif&#x27;);
            circle.css({
                &#x27;height&#x27;: &#x27;12px&#x27;,
                &#x27;width&#x27;: &#x27;auto&#x27;,
                &#x27;margin-left&#x27;: &#x27;20px&#x27;,
                &#x27;float&#x27;: &#x27;right&#x27;,
            });
            loading.append(circle);

            LADS.Worktop.Database.getExhibitions(function (exhibitions) {
                // draw exhibition holders for each exhibition
                for (var i = 0; i &lt; exhibitions.length; i++) {
                    
                    var origName = exhibitions[i].Name;
                    var name;

                    if (origName.length &gt; 15) {
                        var hasSpace = false;
                        var scanLength = Math.min(origName.length, 25);
                        for (var j = 14; j &lt; scanLength ; j++) {
                            if (origName[j] === &quot; &quot; &amp;&amp; !hasSpace) {
                                name = origName.substr(0, j) + &quot;...&quot;;
                                hasSpace = true;
                            } else if (origName[j] === &quot;-&quot; &amp;&amp; j !== (scanLength - 1) &amp;&amp; !hasSpace) {
                                if (origName[j + 1] === &quot; &quot;) {
                                    name = origName.substr(0, j) + &quot;...&quot;;
                                    hasSpace = true;
                                }
                            }
                        }
                        if (!hasSpace) {
                            name = origName.substr(0, 25) + &quot;...&quot;;
                        }
                    } else {
                        name = exhibitions[i].Name;
                    }



                    var exhibHolder = $(document.createElement(&#x27;div&#x27;));
                    exhibHolder.addClass(&#x27;exhibHolder&#x27;);
                    exhibHolder.attr(&#x27;id&#x27;, exhibitions[i].Identifier);
                    exhibHolder.css({
                        width: &#x27;100%&#x27;,
                        height: &#x27;9%&#x27;,
                        &#x27;text-overflow&#x27;: &#x27;ellipsis&#x27;,
                        margin: &#x27;1px 0px 1px 0px&#x27;,
                        &#x27;font-size&#x27;: &#x27;100%&#x27;,
                        &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                        &#x27;padding-top&#x27;: &#x27;3%&#x27;,
                    });
                    exhibHolder.text(name);
                    $(catalogPickerExhibitions).append(exhibHolder);
                    // click handler for general exhibition button
                    makeExhibClickable(exhibHolder);
                }

                function makeExhibClickable(exhibHolder) {
                    exhibHolder.click(function () {
                        $(&quot;.allArtworksHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                        $(&quot;.exhibHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                        exhibHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                        var selected = exhibHolder.attr(&#x27;id&#x27;);
                        selectedExhib = selected;
                        $(&#x27;.catalogPickerArtworks&#x27;).empty();
                        catalogPickerImport.disabled = selectedArtworks.length ? false : true;
                        $(&#x27;.artButton&#x27;).hide().data(&#x27;visible&#x27;, false);
                        $(&#x27;.&#x27; + selected).show().data(&#x27;visible&#x27;, true);
                        LADS.Util.searchData(searchbar.val(), &#x27;.artButton&#x27;, IGNORE_IN_SEARCH);
                        LADS.Worktop.Database.getArtworksIn(exhibHolder.attr(&#x27;id&#x27;),loadInArtworks, function () {
                            console.log(&quot;error&quot;);
                        }, function () {
                            console.log(&quot;error2&quot;);
                        });


                    });
                }

                LADS.Worktop.Database.getArtworks(loadInArtworks, function () {
                    console.log(&quot;error&quot;);
                }, function () {
                    console.log(&quot;error2&quot;);
                });
            });


            function loadInArtworks(artworks) {
                var i;
                for (i = 0; i &lt; artworks.length; i++) {
                    if (artworks[i].Type === &#x27;Empty&#x27;) {
                        artworks.splice(i, 1);
                        i--;
                    }
                }
                //allArtworks = artworks;
                // sort all artworks alphabetically
                artworks.sort(function (a, b) {
                    return a.Name.toLowerCase() &lt; b.Name.toLowerCase() ? -1 : 1;
                });

                // using docfrag
                //var artworkListDocfrag = document.createDocumentFragment();
                // create holders for all artworks (since we start in the &quot;all artworks&quot; exhibition)
                $.each(artworks, function (i, artwork) {
                    artQueue.add(function () {
                        var artHolder = document.createElement(&#x27;div&#x27;);
                        var exhibits = [];
                        var ids = &quot;&quot;;
                        if (selectedExhib)
                            $(artHolder).hide().data(&#x27;visible&#x27;, false);
                        for (var j = 0; j &lt; artwork._Folders.FolderData.length; j++) {
                            exhibits.push(artwork._Folders.FolderData[j]);
                            if (selectedExhib === artwork._Folders.FolderData[j].FolderId)
                                $(artHolder).show().data(&#x27;visible&#x27;, true);
                            ids += artwork._Folders.FolderData[j].FolderId + &quot; &quot;;
                        }
                        $(artHolder).attr(&#x27;class&#x27;, &#x27;artButton &#x27; + ids);
                        $(artHolder).data({
                            name: artwork.Name,
                            artist: artwork.Metadata.Artist,
                            year: artwork.Metadata.Year,
                        });
                        $(artHolder).data(&#x27;exhibits&#x27;, exhibits);
                        $(artHolder).addClass(&quot;artHolder&quot;);
                        $(artHolder).attr(&#x27;id&#x27;, artwork.Identifier); // unique artwork identifier
                        //$(artHolder).data(&#x27;url&#x27;, artwork.Metadata.DeepZoom); // store url as data
                        $(artHolder).data(&#x27;name&#x27;, artwork.Name);
                        $(artHolder).data(&#x27;type&#x27;, artwork.Metadata.Type);

                        if (artwork.Metadata.Duration) { //for videos
                            $(artHolder).data(&#x27;duration&#x27;, artwork.Metadata.Duration);
                            $(artHolder).data(&#x27;url&#x27;, artwork.Metadata.Source);
                        } else {
                            $(artHolder).data(&#x27;url&#x27;, artwork.Metadata.DeepZoom);
                        }
                        $(artHolder).css({
                            float: &#x27;left&#x27;,
                            background: &#x27;#222&#x27;,
                            width: &#x27;48%&#x27;,
                            height: &#x27;25%&#x27;,
                            padding: &#x27;2px&#x27;,
                            margin: &#x27;1px&#x27;,
                        });
                        $(catalogPickerArtworks).append(artHolder);
                        //artworkListDocfrag.appendChild(artHolder);
                        LADS.Util.searchData(searchbar.val(), &#x27;.artButton&#x27;, IGNORE_IN_SEARCH);

                        //create holder for image
                        var artHolderImageHolder = document.createElement(&#x27;div&#x27;);
                        $(artHolderImageHolder).addClass(&#x27;artHolderImageHolder&#x27;);
                        $(artHolderImageHolder).css({
                            float: &#x27;left&#x27;,
                            width: &#x27;40%&#x27;,
                            margin: &#x27;3.5%&#x27;,
                            height: &#x27;80%&#x27;,
                            &#x27;overflow&#x27;: &#x27;hidden&#x27;,
                        });
                        $(artHolder).append(artHolderImageHolder);

                        // create image for artwork holder
                        var artHolderImage = document.createElement(&#x27;img&#x27;);
                        $(artHolderImage).addClass(&#x27;artHolderImage&#x27;);
                        $(artHolderImage).attr(&#x27;src&#x27;, LADS.Worktop.Database.fixPath(artwork.Metadata.Thumbnail));
                        $(artHolderImage).css({
                            width: &#x27;100%&#x27;,
                            height: &#x27;100%&#x27;,
                            &#x27;max-height&#x27;: &#x27;100%&#x27;,
                        });
                        $(artHolderImageHolder).append(artHolderImage);
                            
                        // create text for artwork holder
                        var artHolderText = document.createElement(&#x27;div&#x27;);
                        $(artHolderText).addClass(&#x27;artHolderText&#x27;);
                        /*
                        var maxlength = 33; // trim off long names
                        var name;
                        if (artwork.Name.length &gt; maxlength) {
                            name = artwork.Name.slice(0, maxlength) + &quot;...&quot;;
                        } else {
                            name = artwork.Name;
                        }
                        */
                        // intelligent truncate + ellipses insertion (bleveque: use text-overflow:ellipsis instead... TODO)
                        var name = artwork.Name;
                        if (name.length &gt; 23) {
                            var hasSpace = false;
                            var scanLength = Math.min(name.length, 35);
                            for (var i = 20; i &lt; scanLength ; i++) {
                                if (name[i] === &quot; &quot; &amp;&amp; !hasSpace) {
                                    name = name.substr(0, i) + &quot;...&quot;;
                                    hasSpace = true;
                                } else if (name[i] === &quot;-&quot; &amp;&amp; i !== (scanLength - 1) &amp;&amp; !hasSpace) {
                                    if (name[i + 1] === &quot; &quot;) {
                                        name = name.substr(0, i) + &quot;...&quot;;
                                        hasSpace = true;
                                    }
                                }
                            }
                            if (!hasSpace) {
                                name = name.substr(0, 24) + &quot;...&quot;;
                            }
                        }
                             
                        $(artHolderText).text(name);
                        $(artHolderText).css({
                            floar: &#x27;left&#x27;,
                            &#x27;padding-left&#x27;: &#x27;3%&#x27;,
                            &#x27;padding-right&#x27;: &#x27;4.5%&#x27;,
                            &#x27;font-size&#x27;: &#x27;100%&#x27;,
                            &#x27;margin&#x27;: &#x27;5% 0 5% 2%&#x27;,
                            &#x27;overflow&#x27;: &#x27;hidden&#x27;,
                            &#x27;word-wrap&#x27;: &#x27;break-word&#x27;,
                        });
                        $(artHolder).append(artHolderText);
                        singleDoubleclick($(artHolder));
                    });
                });
                artQueue.add(function () {
                    loading.hide();
                });
                // append docfrag at end
                //artQueue.add(function () { $(catalogPickerArtworks).append(artworkListDocfrag); });
            }

            //single clicking selects/deselects artworks to be imported
            function singleClick(e,artHolder) {
                var index, urlindex;
                if (artHolder.data(&#x27;selected&#x27;)) {
                    artHolder.css(&#x27;background&#x27;, &#x27;#222&#x27;);
                    artHolder.data(&#x27;selected&#x27;, false);
                    urlindex = artworkIndicesViaURL.indexOf(artHolder.data(&#x27;url&#x27;));
                    //index = selectedArtworks.indexOf(artHolder.data(&#x27;url&#x27;));
                    selectedArtworks.splice(urlindex, 1);
                    artworkIndicesViaURL.splice(urlindex, 1);
                    selectedArtworksUrls[artHolder.data(&#x27;url&#x27;)] = false;
                    catalogPickerImport.disabled = selectedArtworks.length ? false : true;
                    //console.log(selectedArtworks.length);
                }
                else {
                    artHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                    artHolder.data({
                        &#x27;selected&#x27;: true
                    }); // else, artHolder.removeClass(&#x27;selected&#x27;)
                    if (artworkIndicesViaURL.indexOf(artHolder.data(&#x27;url&#x27;)) === -1) {
                        selectedArtworks.push({ &#x27;url&#x27;: artHolder.data(&#x27;url&#x27;), &#x27;name&#x27;: artHolder.data(&#x27;name&#x27;), &#x27;id&#x27;: artHolder.attr(&#x27;id&#x27;), &#x27;type&#x27;: artHolder.data(&#x27;type&#x27;), &#x27;duration&#x27;: artHolder.data(&#x27;duration&#x27;) });
                        artworkIndicesViaURL.push(artHolder.data(&#x27;url&#x27;));
                        selectedArtworksUrls[artHolder.data(&#x27;url&#x27;)] = true;
                    }
                    catalogPickerImport.disabled = false;
                }
            }

            //double clicking will import all selected artworks
            function doubleClick(e,artHolder) {
                var i, selectedArt;
                // get artwork selected
                catalogPickerImport.disabled = false;
                //$(&quot;.artHolder .unSelected&quot;).css(&#x27;background&#x27;, &#x27;#222&#x27;); /// noooooo
                artHolder.css(&#x27;background&#x27;, &#x27;#999&#x27;);
                if (!selectedArtworksUrls[artHolder.data(&#x27;url&#x27;)] &amp;&amp; artHolder.data(&#x27;selected&#x27;) !== true) {
                    selectedArtworks.push({ &#x27;url&#x27;: artHolder.data(&#x27;url&#x27;), &#x27;name&#x27;: artHolder.data(&#x27;name&#x27;), &#x27;id&#x27;: artHolder.attr(&#x27;id&#x27;),&#x27;type&#x27;: artHolder.data(&#x27;type&#x27;), &#x27;duration&#x27;: artHolder.data(&#x27;duration&#x27;) });
                    selectedArtworksUrls[artHolder.data(&#x27;url&#x27;)] = true;
                    artHolder.data({
                        &#x27;selected&#x27;: true
                    });
                }
                $(catalogPickerOverlay).fadeOut();
                _clearCatalog();
                searchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                searchbar.val(&quot;&quot;);
                // add the artwork track to the timeline
                for (i = 0; i &lt; selectedArtworks.length; i++) {
                    selectedArt = selectedArtworks[i];
                    var track;
                    if (selectedArt.type === &quot;VideoArtwork&quot;) {
                        track = timeline.addVideoTrack(selectedArt.url, selectedArt.name,null,selectedArt.duration);
                        var positionX = timeManager.getCurrentPx();
                        var displayLength = parseFloat(selectedArt.duration);
                        //if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                        //    timeManager.setEnd(displayLength + timeManager.pxToTime(positionX));
                        //}
                        //track.addDisplay(positionX, displayLength);
                        //track.addDisplay(positionX, displayLength);
                        if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                        }
                        var diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                        var newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                             track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                             track.addDisplay(positionX, Math.min(diff, displayLength));
                        if (timeline.getTracks().length &gt; 0) {
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                     } else {
                            track = timeline.addArtworkTrack(selectedArt.url, selectedArt.name, selectedArt.id, selectedArt.type);
                                       
                            var positionX = timeManager.getCurrentPx();
                            var displayLength = 5;
                            var dispLen = Math.min(displayLength, timeManager.getDuration().end - timeManager.pxToTime(positionX));
                            var newDisplay = (dispLen &lt; LADS.TourAuthoring.Constants.displayEpsilon) ? track.addDisplay(timeManager.timeToPx(timeManager.getDuration().end - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) : track.addDisplay(positionX, dispLen);
                            if (dispLen &lt; 1.5 &amp;&amp; dispLen &gt;= LADS.TourAuthoring.Constants.displayEpsilon) {
                                newDisplay.setIn(0);
                                newDisplay.setOut(0);
                                newDisplay.setMain(dispLen);
                            }

                            // forcing a tour reload? probably easiest to use timeline.onUpdate()
                            if (timeline.getTracks().length &gt; 0) {
                                timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                            }
                        }
                }
                undoManager.combineLast(2 * selectedArtworks.length); // allow undo/redo to perform both actions (addTrack, addDisplay) at once
                isUploading = false;
                timeline.getDataHolder().mapTracks(function (container, i) {
                    container.track.updatePos(i);
                });
                
            }

            //this handles discriminating between the double and single clicks for importing artworks
            //cleans up bugs where both click events were firing and artworks would import twice
            function singleDoubleclick(artHolder) {
                artHolder.click(function (e) {
                    var that = this;
                    setTimeout(function () {
                        var dblclick = parseInt($(that).data(&#x27;double&#x27;), 10);
                        if (dblclick &gt; 0) {
                            $(that).data(&#x27;double&#x27;, dblclick - 1);
                        } else {
                            singleClick.call(that, e,artHolder);
                        }
                    }, 300);
                }).dblclick(function (e) {
                    $(this).data(&#x27;double&#x27;, 2);
                    doubleClick.call(this, e, artHolder);
                });
            }


            // click handler for the &quot;all artworks&quot; button
            $(allArtworksHolder).on(&#x27;click&#x27;, function () {
                $(&quot;.exhibHolder&quot;).css(&#x27;background&#x27;, &#x27;black&#x27;);
                $(this).css(&#x27;background&#x27;, &#x27;#999&#x27;);
                catalogPickerImport.disabled = selectedArtworks.length ? false : true;
                $(&#x27;.catalogPickerArtworks&#x27;).empty();
                $(&#x27;.artButton&#x27;).show().data(&#x27;visible&#x27;, true);
                LADS.Util.searchData(searchbar.val(), &#x27;.artButton&#x27;, IGNORE_IN_SEARCH);
                selectedExhib = null;
                if (allArtworks) {
                    loadInArtworks(allArtworks);
                } else {
                    LADS.Worktop.Database.getArtworks(loadInArtworks, function () {
                        console.log(&quot;error&quot;);
                    }, function () {
                        console.log(&quot;error2&quot;);
                    });
                }
            });



            $(catalogPickerOverlay).fadeIn();

            catalogPicker.append(loading);

            // create artwork import button
            var catalogPickerImport = document.createElement(&#x27;button&#x27;);
            catalogPickerImport.disabled = true;
            $(catalogPickerImport).text(&quot;Import&quot;);
            $(catalogPickerImport).css({
                position: &#x27;absolute&#x27;,
                bottom: &#x27;2%&#x27;,
                right: &#x27;22%&#x27;,
            });

            // in here, deal with multiple selected artworks
            // artwork import button click handler
            $(catalogPickerImport).click(function () {
                var i;
                // if an artwork is selected, add an artwork track and a display (and combine these commands in undo manager)
                catalogPickerImport.disabled = true;
                function importHelper(j) {
                    var selectedArt = selectedArtworks[j];
                    //artQueue.add(function () {
                    var track;
                    var positionX = timeManager.getCurrentPx();
                    var displayLength;
                    if (selectedArt.type === &quot;VideoArtwork&quot;) {
                        track = timeline.addVideoTrack(selectedArt.url, selectedArt.name, null, selectedArt.duration);
                        displayLength = parseFloat(selectedArt.duration);
                        if (timeManager.getDuration().end &lt; displayLength + timeManager.pxToTime(positionX)) {
                            timeManager.setEnd(Math.min(LADS.TourAuthoring.Constants.maxTourLength, displayLength + timeManager.pxToTime(positionX)));
                        }
                        var diff = LADS.TourAuthoring.Constants.maxTourLength - timeManager.pxToTime(positionX);
                        var newDisplay = (diff &lt; LADS.TourAuthoring.Constants.displayEpsilon) ?
                                             track.addDisplay(timeManager.timeToPx(LADS.TourAuthoring.Constants.maxTourLength - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) :
                                             track.addDisplay(positionX, Math.min(diff, displayLength));
                        if (timeline.getTracks().length &gt; 0) {
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                    } else {
                        track = timeline.addArtworkTrack(selectedArt.url, selectedArt.name, selectedArt.id);
                        displayLength = 5;
                        var dispLen = Math.min(displayLength, timeManager.getDuration().end - timeManager.pxToTime(positionX));
                        var newDisplay = (dispLen &lt; LADS.TourAuthoring.Constants.displayEpsilon) ? track.addDisplay(timeManager.timeToPx(timeManager.getDuration().end - LADS.TourAuthoring.Constants.displayEpsilon), LADS.TourAuthoring.Constants.displayEpsilon) : track.addDisplay(positionX, dispLen);
                        if (dispLen &lt; 1.5 &amp;&amp; dispLen &gt;= LADS.TourAuthoring.Constants.displayEpsilon) {
                            newDisplay.setIn(0);
                            newDisplay.setOut(0);
                            newDisplay.setMain(dispLen);
                        }
                        // force a tour reload? easiest to use timeline.onUpdate()
                        if (timeline.getTracks().length &gt; 0) {
                            timeline.getTracks()[0].leftAndRight({ translation: { x: 0 } }, false);
                        }
                    }
                }
                if (selectedArtworks &amp;&amp; selectedArtworks.length) {
                    artQueue.clear();
                    loading.text(&#x27;Importing...&#x27;);
                    loading.show();
                    $(catalogPickerImport).hide();
                    $(catalogPickerCancel).hide();
                    for (i = 0; i &lt; selectedArtworks.length; i++) {
                        importHelper(i);
                    }
                    undoManager.combineLast(2 * selectedArtworks.length);
                    //artQueue.add(function () {
                        //allow ink annotations
                    $(inkButton).css({ &#x27;background-color&#x27;: &#x27;transparent&#x27;, &#x27;color&#x27;: &#x27;white&#x27; });
                    allowInk = true;
                    _clearCatalog();
                    $(catalogPickerOverlay).fadeOut();
                    //});
                } else {
                    _clearCatalog();
                    $(catalogPickerOverlay).fadeOut();
                }
                searchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                searchbar.val(&quot;&quot;);
                isUploading = false;
                timeline.getDataHolder().mapTracks(function (container, i) {
                    container.track.updatePos(i);
                });
            });
            catalogPicker.append(catalogPickerImport);

            // cancel button
            var catalogPickerCancel = document.createElement(&#x27;button&#x27;);
            $(catalogPickerCancel).text(&quot;Cancel&quot;);
            $(catalogPickerCancel).css({
                position: &#x27;absolute&#x27;,
                bottom: &#x27;2%&#x27;,
                right: &#x27;5%&#x27;,
            });

            // cancel button click handler
            $(catalogPickerCancel).click(function () {
                $(catalogPickerOverlay).fadeOut();
                _clearCatalog();
                catalogPickerImport.disabled = true;
                searchbar.attr(&#x27;placeholder&#x27;, PICKER_SEARCH_TEXT);
                searchbar.val(&quot;&quot;);
                return undefined;
            });
            catalogPicker.append(catalogPickerCancel);
        }

        // Checks if a string &#x27;val&#x27; contains &#x27;str
        // If &#x27;val&#x27; is the default search text it will always return true
        // Case insensitive
        function searchString(str, val) { // could use regex instead...
            if (val === PICKER_SEARCH_TEXT) val = &#x27;&#x27;;
            return str.toLowerCase().indexOf(val.toLowerCase()) !== -1;
        }

        /**
         * Detach catalog dom elements
         */
        function _clearCatalog() {
            $(&quot;.artHolder&quot;).detach();
            $(&quot;.exhibHolder&quot;).detach();
            $(&quot;.allArtworksHolder&quot;).detach();
            $(&#x27;#loadingLabel&#x27;).detach();
            artQueue.clear();
        }

        
        /**
         * Below are the ink UI controls. They are separated into draw, text, and transparency controls.
         */

        var numInkTracks = 0;
        
        /**
         * Ink text UI controls (initial text creation, not edit mode)
         */

        // text UI control panel
        var inkTextDocfrag = document.createDocumentFragment();
        inkTextControls = $(document.createElement(&#x27;div&#x27;));
        inkTextControls.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-x&#x27;: &#x27;none&#x27;, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27; });
        inkTextControls.attr(&#x27;id&#x27;, &#x27;inkTextControls&#x27;);
        inkTextDocfrag.appendChild(inkTextControls[0]);
        inkTextControls.css({ &quot;display&quot;: &quot;none&quot; });

        // cancel text button
        var cancelTextButton = $(document.createElement(&#x27;button&#x27;));
        cancelTextButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, /*&#x27;width&#x27;: &#x27;25%&#x27;*/ &#x27;width&#x27;: &#x27;80%&#x27; });
        cancelTextButton.get(0).innerHTML = &quot;Cancel&quot;;
        cancelTextButton.click(function () {
            removeInkCanv();
            inkTextControls.hide();
            timeline.setModifyingInk(false);
            timeline.setEditInkOn(false);

            inkAuthoring.getInkUndoManager().clear();
            undoManager.greyOutBtn();
            // set undo/redo buttons back to global undo/redo functionality
            playbackControls.undoButton.off(&quot;click&quot;);
            playbackControls.redoButton.off(&quot;click&quot;);
            playbackControls.undoButton.on(&quot;click&quot;, function () {
                undoManager.undo();
            });
            playbackControls.redoButton.on(&quot;click&quot;, function () {
                undoManager.redo();
            });
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;none&#x27; });
        });
        inkTextControls.append(cancelTextButton);

        // CREATING NEW TEXT INK
        var textArray = []; // array of text UI controls
        
        var textBodyLabel = $(document.createElement(&#x27;div&#x27;));
        textBodyLabel.addClass(&#x27;thicknessLabel&#x27;);
        var textBodyLabel1 = $(document.createElement(&#x27;div&#x27;));
        textBodyLabel.text(&quot;Text:&quot;);
        textBodyLabel.append(textBodyLabel1);
        inkTextControls.append(textBodyLabel);
        textBodyLabel1.css({
            &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;top&#x27;: &#x27;2px&#x27;,
            &#x27;width&#x27;: &#x27;65%&#x27;,
            &#x27;color&#x27;: &#x27;green&#x27;,
            &#x27;display&#x27;: &#x27;inline-block&#x27;,
            &#x27;margin-left&#x27;: &#x27;2%&#x27;,
            &#x27;text-overflow&#x27;: &#x27;ellipsis&#x27;,
            &#x27;overflow&#x27;: &#x27;hidden&#x27;,
            &#x27;white-space&#x27;: &#x27;nowrap&#x27;,
            &#x27;margin-bottom&#x27;: &#x27;0&#x27;,
        });
        textBodyLabel.css({
            &#x27;font-size&#x27;: &#x27;130%&#x27;,
            &#x27;color&#x27;: &#x27;black&#x27;,
            &#x27;margin-left&#x27;: &#x27;8%&#x27;,
            &#x27;font-weight&#x27;: &#x27;normal&#x27;,
            &#x27;margin-top&#x27;: &#x27;3%&#x27;,
            &#x27;margin-right&#x27;: &#x27;12%&#x27;,
            &#x27;margin-bottom&#x27;: &#x27;1%&#x27;,
            &#x27;display&#x27;: &#x27;inline-block&#x27;,
            &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;,
            &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;,
            &#x27;border-bottom-color&#x27;: &#x27;white&#x27;,
            &#x27;width&#x27;: &#x27;80%&#x27;,
        });

        var textArea = $(document.createElement(&#x27;textarea&#x27;));
        textArea.css({
            &#x27;width&#x27;: &quot;72%&quot;,
            &#x27;min-width&#x27;: &#x27;0px&#x27;,
            &#x27;margin-left&#x27;: &#x27;8%&#x27;,
            &#x27;margin-top&#x27;: &#x27;2%&#x27;,
            &#x27;overflow-x&#x27;: &#x27;hidden&#x27;,
            &#x27;position&#x27;: &#x27;relative&#x27;,
        });
        textArray.push(textArea);
        textArea.autoSize();
        inkTextControls.append(textArea);

        function updateAreaText() {
            var text = currentInkController.getSVGText();
            textBodyLabel1.text(textArea.val()); // or .text()
            text.attr(&#x27;text&#x27;, textArea.val());
            text.data(&#x27;str&#x27;, textArea.val());
        }

        var lastText = &quot;&quot;;
        textArea.on(&quot;keyup&quot;, function (evt) { //use onpropertychange

            var code = evt.keyCode;
            if (code === 32) {
            evt.stopPropagation();
            }
          
            var undoRedo = $.debounce(500, false, undoRedoText(evt));
            if (code !== 37 &amp;&amp; code !== 38 &amp;&amp; code !== 39 &amp;&amp; code !== 40 &amp;&amp; evt.keyCode !== 90 &amp;&amp; !evt.ctrlKey &amp;&amp; evt.keyCode !== 89) { // exclude arrow/ctrl/etc keys
                undoRedo();
            }
            updateAreaText();
        });

        function undoRedoText(evt) {
            return function () {
                var currText = textArea.val();
                var oldText = lastText;
                if (currText === lastText || evt.which === 17) {
                    return;
                }
                var undoMgr = currentInkController.getInkUndoManager();
                var command = LADS.TourAuthoring.Command({
                    execute: function () {
                        textArea.val(currText);
                        updateAreaText();
                    },
                    unexecute: function () {
                        textArea.val(oldText);
                        updateAreaText();
                    }
                });
                undoMgr.logCommand(command);
                lastText = textArea.val();
            };
        }

        textBodyLabel.click(function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            textBodyLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textArray, textArea);
        });

        // show current font label
        var fontLabel = $(document.createElement(&#x27;div&#x27;));
        fontLabel.addClass(&#x27;thicknessLabel&#x27;);
        var fontLabel1 = $(document.createElement(&#x27;div&#x27;));
        fontLabel.text(&quot;Font:&quot;);
        fontLabel1.text(&quot;Times New Roman&quot;);
        fontLabel.append(fontLabel1);
        inkTextControls.append(fontLabel);

        fontLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        fontLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // dropdown font selector
        var fontSelector = $(document.createElement(&quot;select&quot;));
        fontSelector.addClass(&#x27;fontSelector&#x27;);
        fontSelector.css({ color: &quot;white&quot;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &quot;border&quot;: &quot;solid 3px rgba(255,255,255,1)&quot;, width: &quot;72%&quot;,  &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;2%&#x27;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        textArray.push(fontSelector);
        inkTextControls.append(fontSelector);

        
        // create font options for the selector -- on click, set the font family of the current ink and reset fontLabel1.text
        var timesOption = $(document.createElement(&quot;option&quot;));
        timesOption.text(&quot;Times New Roman&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        timesOption.on(&#x27;click&#x27;, function () {
            currentInkController.setFontFamily(&quot;Times New Roman, serif&quot;);
            fontLabel1.text(&quot;Times New Roman&quot;);
        });
        var georgiaOption = $(document.createElement(&quot;option&quot;));
        georgiaOption.text(&quot;Georgia&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        georgiaOption.on(&#x27;click&#x27;, function () {
            currentInkController.setFontFamily(&quot;Georgia, serif&quot;);
            fontLabel1.text(&quot;Georgia&quot;);
        });
        var verdanaOption = $(document.createElement(&quot;option&quot;));
        verdanaOption.text(&quot;Verdana&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        verdanaOption.on(&#x27;click&#x27;, function () {
            currentInkController.setFontFamily(&quot;Verdana, Geneva, sans-serif&quot;);
            fontLabel1.text(&quot;Verdana&quot;);
        });
        var courierOption = $(document.createElement(&quot;option&quot;));
        courierOption.text(&quot;Courier&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        courierOption.on(&#x27;click&#x27;, function () {
            currentInkController.setFontFamily(&quot;&#x27;Courier New&#x27;, Courier, monospace&quot;);
            fontLabel1.text(&quot;Courier&quot;);
        });

        fontSelector.append(timesOption);
        fontSelector.append(georgiaOption);
        fontSelector.append(verdanaOption);
        fontSelector.append(courierOption);

        // font label click handler (needs to be after the font selector is created)
        fontLabel.click(function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            fontLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textArray, fontSelector);
        });

        // show current font color label
        var colorTextLabel = $(document.createElement(&#x27;div&#x27;));
        colorTextLabel.addClass(&#x27;thicknessLabel&#x27;);
        var colorTextLabel1 = $(document.createElement(&#x27;div&#x27;));
        colorTextLabel1.addClass(&#x27;changeColor&#x27;);
        colorTextLabel.text(&quot;Color: &quot;);
        colorTextLabel1.text(&quot;#FFFFFF&quot;);
        colorTextLabel.append(colorTextLabel1);
        inkTextControls.append(colorTextLabel);

        colorTextLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        colorTextLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });

        // create div containing the color picker
        var colorTextDiv = $(document.createElement(&#x27;div&#x27;));
        colorTextDiv.attr(&quot;id&quot;, &quot;colorTextDiv&quot;);
        colorTextDiv.css(&#x27;display&#x27;, &#x27;none&#x27;);
        inkTextControls.append(colorTextDiv);
        textArray.push(colorTextDiv);

        //click handler to open the color picker when we click on the color label
        colorTextLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            colorTextLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textArray, colorTextDiv);

        });

        // create input box for color picker
        var itemText = document.createElement(&#x27;input&#x27;);
        $(itemText).attr(&#x27;id&#x27;, &#x27;textColorToggle&#x27;);
        $(itemText).attr(&#x27;readonly&#x27;, &#x27;readonly&#x27;);
        $(itemText).css({ &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;40%&#x27; });
        $(itemText).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });

        if (itemText.addEventListener) {
            itemText.addEventListener(&#x27;DOMNodeInserted&#x27;, function () {
                // initialize colorpicker object on current element
                myPicker = new jscolor.color(itemText, {});
                myPicker.fromString(&quot;FFFFFF&quot;);
                myPicker.onImmediateChange = function () {
                    currentInkController.setFontColor(&quot;#&quot;+$(&quot;#textColorToggle&quot;).attr(&#x27;value&#x27;));
                    $(&#x27;.changeColor&#x27;)[0].innerHTML = &quot;#&quot;+$(&quot;#textColorToggle&quot;).attr(&#x27;value&#x27;);
                };
            }, false);
        }
        colorTextDiv.append(itemText);

        // show font size label 
        var textSizeLabel = $(document.createElement(&#x27;div&#x27;));
        textSizeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var textSizeLabel1 = $(document.createElement(&#x27;div&#x27;));
        textSizeLabel.text(&quot;Text Size: &quot;);
        textSizeLabel1.text(&quot;12px&quot;);
        textSizeLabel.append(textSizeLabel1);
        inkTextControls.append(textSizeLabel);
        textSizeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        textSizeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // create slider for font size
        var textSizeSlider = $(document.createElement(&#x27;div&#x27;));
        textSizeSlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;, &#x27;float&#x27;: &#x27;left&#x27;
        });
        var textSliderPoint = $(document.createElement(&#x27;div&#x27;));
        textSliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &quot;margin-top&quot;: &quot;-0.57%&quot;, &quot;left&quot;: &quot;50px&quot;,
        });
        textSizeSlider.append(textSliderPoint);
        textSizeSlider.attr(&quot;value&quot;, &quot;12px&quot;);
        inkTextControls.append(textSizeSlider);
        
        // drag functionality for font size slider point
        textSliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                textSliderPoint.value = textSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;) / (textSizeSlider.offset().left + textSizeSlider.width()) * 1.28;
                //console.log(textSliderPoint.value);
                textSizeSlider.attr(&quot;value&quot;, (textSliderPoint.value * 39 + 8) + &quot;px&quot;);
                var val = Math.round(textSliderPoint.value * 39) + 8;
                textSizeLabel1.text( val + &quot;px&quot;);
                currentInkController.setFontSize(textSizeSlider.attr(&quot;value&quot;));
            },
            appendTo: &#x27;body&#x27;
        });

        textArray.push(textSizeSlider);

        // click handler for text size label -- opens slider
        textSizeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            textSizeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textArray, textSizeSlider);
        });

        // attach buttons for text
        var linkTextDiv = getAttachDiv(inkTextControls, &quot;Write&quot;);
        inkTextControls.append(linkTextDiv);
        functionsPanel.append(inkTextDocfrag);

        /**
         * Edit ink text UI controls -- we can probably compress some of this by reusing the inkTextControls
         */

        // edit text control panel
        var textEditDocfrag = document.createDocumentFragment();
        inkEditText = $(document.createElement(&#x27;div&#x27;));
        inkEditText.attr(&quot;id&quot;, &quot;inkEditText&quot;);
        inkEditText.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27; });
        //functionsPanel.append(inkEditText);
        textEditDocfrag.appendChild(inkEditText[0]);
        inkEditText.css({ &quot;display&quot;: &quot;none&quot; });

        var cancelEditTextButton = $(document.createElement(&#x27;button&#x27;));
        cancelEditTextButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, /*&#x27;width&#x27;: &#x27;25%&#x27;*/ &#x27;width&#x27;:&#x27;80%&#x27; });
        cancelEditTextButton.get(0).innerHTML = &quot;Cancel&quot;;
        inkEditText.append(cancelEditTextButton);

        // EDITING OLD TEXT INK
        var textEditArray = []; // array of edit text controls
        
        var textEditBodyLabel = $(document.createElement(&#x27;div&#x27;));
        textEditBodyLabel.addClass(&#x27;thicknessLabel&#x27;);
        var textEditBodyLabel1 = $(document.createElement(&#x27;div&#x27;));
        textEditBodyLabel.text(&quot;Text:&quot;);
        textEditBodyLabel.append(textEditBodyLabel1);
        inkEditText.append(textEditBodyLabel);
        textEditBodyLabel1.css({
            &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;top&#x27;: &#x27;2px&#x27;,
            &#x27;width&#x27;: &#x27;65%&#x27;,
            &#x27;color&#x27;: &#x27;green&#x27;,
            &#x27;display&#x27;: &#x27;inline-block&#x27;,
            &#x27;margin-left&#x27;: &#x27;2%&#x27;,
            &#x27;text-overflow&#x27;: &#x27;ellipsis&#x27;,
            &#x27;overflow&#x27;: &#x27;hidden&#x27;,
            &#x27;white-space&#x27;: &#x27;nowrap&#x27;,
            &#x27;margin-bottom&#x27;: &#x27;0&#x27;,
        });
        textEditBodyLabel.css({
            &#x27;font-size&#x27;: &#x27;130%&#x27;,
            &#x27;color&#x27;: &#x27;black&#x27;,
            &#x27;margin-left&#x27;: &#x27;8%&#x27;,
            &#x27;font-weight&#x27;: &#x27;normal&#x27;,
            &#x27;margin-top&#x27;: &#x27;3%&#x27;,
            &#x27;margin-right&#x27;: &#x27;12%&#x27;,
            &#x27;margin-bottom&#x27;: &#x27;1%&#x27;,
            &#x27;display&#x27;: &#x27;inline-block&#x27;,
            &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;,
            &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;,
            &#x27;border-bottom-color&#x27;: &#x27;white&#x27;,
            &#x27;width&#x27;: &#x27;80%&#x27;,
        });

        var textEditArea = $(document.createElement(&#x27;textarea&#x27;));
        textEditArea.css({
            &#x27;width&#x27;: &quot;72%&quot;,
            &#x27;min-width&#x27;: &#x27;0px&#x27;,
            &#x27;margin-left&#x27;: &#x27;8%&#x27;,
            &#x27;margin-top&#x27;: &#x27;2%&#x27;,
            &#x27;overflow-x&#x27;: &#x27;hidden&#x27;,
            &#x27;position&#x27;: &#x27;relative&#x27;,
        });
        textEditArray.push(textEditArea);
        textEditArea.autoSize();
        inkEditText.append(textEditArea);

        var textA;
        function updateEditAreaText() {
            textA = currentInkController.getSVGText();
            textEditBodyLabel1.text(textEditArea.val()); // or .text()
            currentInkController.remove_all();
            currentInkController.add_text_box(textA.attrs.x, textA.attrs.y, -1, -1, textEditArea.val(), true);
            textA = currentInkController.getSVGText();
            textA.data(&#x27;str&#x27;, textEditArea.val());
        }
        var lastEditText;
        function firstUpdate() {
            textA = currentInkController.getSVGText();
            textEditBodyLabel1.text(textEditArea.val()); // or .text()
            currentInkController.remove_all();
            lastEditText = textEditArea.val();
            switch (textA.attr(&#x27;font-family&#x27;)) {
                case &quot;&#x27;Courier New&#x27;, Courier, monospace&quot;:
                    courierEditOption.prop(&#x27;selected&#x27;, true);
                    currentInkController.setFontFamily(&quot;&#x27;Courier New&#x27;, Courier, monospace&quot;);
                    fontEditLabel1.text(&quot;Courier&quot;);
                    break;
                case &quot;Verdana, Geneva, sans-serif&quot;:
                    verdanaEditOption.prop(&#x27;selected&#x27;, true);
                    currentInkController.setFontFamily(&quot;Verdana, Geneva, sans-serif&quot;);
                    fontEditLabel1.text(&quot;Verdana&quot;);
                    break;
                case &quot;Georgia, serif&quot;:
                    georgiaEditOption.prop(&#x27;selected&#x27;, true);
                    currentInkController.setFontFamily(&quot;Georgia, serif&quot;);
                    fontEditLabel1.text(&quot;Georgia&quot;);
                    break;
                case &quot;Times New Roman, serif&quot;:
                    timesEditOption.prop(&#x27;selected&#x27;, true);
                    currentInkController.setFontFamily(&quot;Times New Roman, serif&quot;);
                    fontEditLabel1.text(&quot;Times New Roman&quot;);
                    break;
                default:
                    break;
            
            }
            currentInkController.add_text_box(textA.attrs.x, textA.attrs.y, -1, -1, textEditArea.val(), true);
            textA = currentInkController.getSVGText();
            textA.data(&#x27;str&#x27;, textEditArea.val());
        }

        
        textEditArea.on(&quot;keyup&quot;, function (evt) { //use onpropertychange

            var code = evt.keyCode;

            if (code == 32) {
            evt.stopPropagation();
            }
            var undoRedoEdit = $.debounce(500, false, undoRedoEditText(evt));
            if (code !== 37 &amp;&amp; code !== 38 &amp;&amp; code !== 39 &amp;&amp; code !== 40 &amp;&amp; !evt.ctrlKey) { // exclude arrow keys
                undoRedoEdit();
            }
            updateEditAreaText();
        });

       
        function undoRedoEditText(evt) {
            return function () {
                var currEditText = textEditArea.val();
                var oldEditText = lastEditText;
                if (currEditText === lastEditText || evt.which === 17) {
                    return;
                }
                var undoMgr = currentInkController.getInkUndoManager();
                var command = LADS.TourAuthoring.Command({
                    execute: function () {
                        textEditArea.val(currEditText);
                        updateEditAreaText();
                    },
                    unexecute: function () {
                        textEditArea.val(oldEditText);
                        updateEditAreaText();
                    }
                });
                undoMgr.logCommand(command);
                lastEditText = currEditText;
            };
        }

        textEditBodyLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            textEditBodyLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textEditArray, textEditArea);
        });

        // show font family label
        var fontEditLabel = $(document.createElement(&#x27;div&#x27;));
        fontEditLabel.addClass(&#x27;thicknessLabel&#x27;);
        var fontEditLabel1 = $(document.createElement(&#x27;div&#x27;));
        fontEditLabel.text(&quot;Font:&quot;);
        fontEditLabel1.text(&quot;Times New Roman&quot;);
        fontEditLabel.append(fontEditLabel1);
        inkEditText.append(fontEditLabel);

        fontEditLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        fontEditLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // font selection dropdown
        var fontEditSelector = $(document.createElement(&quot;select&quot;));
        fontEditSelector.addClass(&#x27;fontSelector&#x27;);
        fontEditSelector.css({ color: &quot;white&quot;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &quot;border&quot;: &quot;solid 3px rgba(255,255,255,1)&quot;, width: &quot;72%&quot;,  &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;2%&#x27;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        textEditArray.push(fontEditSelector);
        inkEditText.append(fontEditSelector);

        // font options in dropdown
        var timesEditOption = $(document.createElement(&quot;option&quot;));
        timesEditOption.text(&quot;Times New Roman&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        timesEditOption.click(function () {
            currentInkController.setFontFamily(&quot;Times New Roman, serif&quot;);
            fontEditLabel1.text(&quot;Times New Roman&quot;);
        });
        var georgiaEditOption = $(document.createElement(&quot;option&quot;));
        georgiaEditOption.text(&quot;Georgia&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        georgiaEditOption.click(function () {
            currentInkController.setFontFamily(&quot;Georgia, serif&quot;);
            fontEditLabel1.text(&quot;Georgia&quot;);
        });
        var verdanaEditOption = $(document.createElement(&quot;option&quot;));
        verdanaEditOption.text(&quot;Verdana&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        verdanaEditOption.click(function () {
            currentInkController.setFontFamily(&quot;Verdana, Geneva, sans-serif&quot;);
            fontEditLabel1.text(&quot;Verdana&quot;);
        });
        var courierEditOption = $(document.createElement(&quot;option&quot;));
        courierEditOption.text(&quot;Courier&quot;).css({ color: &quot;white&quot;, &quot;border-color&quot;: &quot;rgba(0,0,0,0.5)&quot;, overflow: &quot;hidden&quot;, background: &quot;no-repeat scroll&quot;, &quot;background-color&quot;: &#x27;rgba(0,0,0,0.5)&#x27; });
        courierEditOption.click(function () {
            currentInkController.setFontFamily(&quot;&#x27;Courier New&#x27;, Courier, monospace&quot;);
            fontEditLabel1.text(&quot;Courier&quot;);
        });

        fontEditSelector.append(timesEditOption);
        fontEditSelector.append(georgiaEditOption);
        fontEditSelector.append(verdanaEditOption);
        fontEditSelector.append(courierEditOption);

        // font label click handler -- opens dropdown
        fontEditLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            fontEditLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textEditArray, fontEditSelector);
        });

        // font color label for editing ink text
        var colorEditTextLabel = $(document.createElement(&#x27;div&#x27;));
        colorEditTextLabel.addClass(&#x27;thicknessLabel&#x27;);
        var colorEditTextLabel1 = $(document.createElement(&#x27;div&#x27;));
        colorEditTextLabel1.addClass(&#x27;changeColorEdit&#x27;);
        colorEditTextLabel.text(&quot;Color: &quot;);
        colorEditTextLabel1.text(&quot;#FFFFFF&quot;);
        colorEditTextLabel.append(colorEditTextLabel1);
        inkEditText.append(colorEditTextLabel);
        colorEditTextLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        colorEditTextLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });

        // div to contain color picker
        var colorEditTextDiv = $(document.createElement(&#x27;div&#x27;));
        colorEditTextDiv.css(&#x27;display&#x27;, &#x27;none&#x27;);
        inkEditText.append(colorEditTextDiv);
        textEditArray.push(colorEditTextDiv);

        // click handler to open color picker
        colorEditTextLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            colorEditTextLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textEditArray, colorEditTextDiv);

        });

        // color picker input box for editing ink Text
        var itemEditText = document.createElement(&#x27;input&#x27;);
        $(itemEditText).attr(&#x27;id&#x27;, &#x27;textEditColorToggle&#x27;);
        $(itemEditText).attr(&#x27;readonly&#x27;, &#x27;readonly&#x27;);
        $(itemEditText).css({ &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;40%&#x27; });
        $(itemEditText).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });

        if (itemEditText.addEventListener) {
            itemEditText.addEventListener(&#x27;DOMNodeInserted&#x27;, function () {
                // initialize colorpicker object on current element
                myEditTextPicker = new jscolor.color(itemEditText, {});
                myEditTextPicker.fromString(&quot;FFFFFF&quot;);
                myEditTextPicker.onImmediateChange = function () {
                    currentInkController.setFontColor(&quot;#&quot; + $(&quot;#textEditColorToggle&quot;).attr(&#x27;value&#x27;));
                    $(&#x27;.changeColorEdit&#x27;)[0].innerHTML = &quot;#&quot; + $(&quot;#textEditColorToggle&quot;).attr(&#x27;value&#x27;);
                };
            }, false);
        }
        colorEditTextDiv.append(itemEditText);

        // font size label for editing
        var textEditSizeLabel = $(document.createElement(&#x27;div&#x27;));
        textEditSizeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var textEditSizeLabel1 = $(document.createElement(&#x27;div&#x27;));
        textEditSizeLabel.text(&quot;Text Size: &quot;);
        textEditSizeLabel1.text(&quot;8px&quot;);
        textEditSizeLabel.append(textEditSizeLabel1);
        inkEditText.append(textEditSizeLabel);
        textEditSizeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        textEditSizeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // font size slider for editing
        var textEditSizeSlider = $(document.createElement(&#x27;div&#x27;));
        textEditSizeSlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        });
        inkEditText.append(textEditSizeSlider);
        var textEditSliderPoint = $(document.createElement(&#x27;div&#x27;));
        textEditSliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &quot;margin-top&quot;: &quot;-0.57%&quot;
        });
        textEditSizeSlider.append(textEditSliderPoint);
        textEditSizeSlider.attr(&quot;value&quot;, &quot;8px&quot;);
        
        // drag handler for font size slider point
        textEditSliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event, ui) {
                //console.log(ui.position.left);
                textEditSliderPoint.value = ui.position.left / (textEditSizeSlider.width() - textEditSliderPoint.width());
                //console.log(textEditSliderPoint.value);
                textEditSizeSlider.attr(&quot;value&quot;, (textEditSliderPoint.value * (maxFontSize - 8) + 8) + &quot;px&quot;); // font size goes from 12-43 (maybe the slider point goes past 1.0?)
                var val = Math.round(textEditSliderPoint.value * (maxFontSize - 8)) + 8;
                currentFontSize = val;
                textEditSizeLabel1.text(val + &quot;px&quot;);
                currentInkController.setFontSize(textEditSizeSlider.attr(&quot;value&quot;));
            },
            appendTo: &#x27;body&#x27;
        });
        textEditArray.push(textEditSizeSlider);

        // click handler for font size label -- opens size slider
        textEditSizeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            textEditSizeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(textEditArray, textEditSizeSlider);
            var pointvalue = (currentFontSize - 8) / (maxFontSize - 8);
            var pointleft = pointvalue * (textEditSizeSlider.width() - textEditSliderPoint.width());
            textEditSliderPoint.css(&quot;left&quot;, pointleft + &quot;px&quot;);
        });

        // save edited ink button
        var saveTextButton = $(document.createElement(&#x27;button&#x27;));
        saveTextButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;80%&#x27; });
        saveTextButton.get(0).innerHTML = &quot;Save&quot;;
        inkEditText.append(saveTextButton);

        functionsPanel.append(textEditDocfrag);


        /**
         * Ink draw UI controls (for initial draw authoring, not editing mode)
         */

        // draw control panel
        var inkDrawDocfrag = document.createDocumentFragment();
        inkDrawControls = $(document.createElement(&#x27;div&#x27;));
        inkDrawControls.attr(&quot;id&quot;, &quot;inkDrawControls&quot;);
        inkDrawControls.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27; });
        inkDrawDocfrag.appendChild(inkDrawControls[0]);
        inkDrawControls.css({ &quot;display&quot;: &quot;none&quot; });

        // draw cancel button
        var cancelDrawButton = $(document.createElement(&#x27;button&#x27;));
        cancelDrawButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, /*&#x27;width&#x27;: &#x27;25%&#x27;*/ &#x27;width&#x27;: &#x27;80%&#x27; });
        cancelDrawButton.get(0).innerHTML = &quot;Cancel&quot;;
        cancelDrawButton.click(function () {
            brushSliderPoint.attr(&#x27;value&#x27;, 7.0);
            currentInkController.updatePenWidth(&quot;brushSlider&quot;);
            removeInkCanv();
            inkDrawControls.hide();
            timeline.setModifyingInk(false);
            timeline.setEditInkOn(false);

            inkAuthoring.getInkUndoManager().clear();
            undoManager.greyOutBtn();
            // reset undo/redo buttons to global undo/redo functionality
            playbackControls.undoButton.off(&quot;click&quot;);
            playbackControls.redoButton.off(&quot;click&quot;);

            playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                undoManager.undo();
            });
            playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                undoManager.redo();
            });
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;none&#x27; });
        });
        inkDrawControls.append(cancelDrawButton);

        var drawArray = []; // array of draw controls

        /////////////////////////////////////

        // draw mode div (contains draw and eraser labels)
        var drawModeDiv = $(document.createElement(&#x27;div&#x27;));
        drawModeDiv.css({ &quot;height&quot;: &#x27;10%&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;display&#x27;: &#x27;none&#x27; });

        // draw mode label
        var drawModeLabel = $(document.createElement(&#x27;div&#x27;));
        drawModeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var drawModeLabel1 = $(document.createElement(&#x27;div&#x27;));
        drawModeLabel.text(&quot;Mode: &quot;);
        drawModeLabel1.text(&quot;Draw&quot;);
        drawModeLabel.append(drawModeLabel1);
        drawModeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        drawModeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        inkDrawControls.append(drawModeLabel);
        inkDrawControls.append(drawModeDiv);
        drawArray.push(drawModeDiv);

        // draw mode label click handler
        drawModeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            drawModeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawArray, drawModeDiv);
        });

        // draw label
        var drawMode = &#x27;draw&#x27;;
        var drawLabel = $(document.createElement(&#x27;label&#x27;));
        drawLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27; });
        drawLabel.text(&quot;Draw&quot;);
        drawModeDiv.append(drawLabel);

        // draw label click handler
        drawLabel.on(&#x27;click&#x27;, function () {
            if (drawMode === &#x27;erase&#x27;) {
                drawLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                eraseLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                drawMode = &#x27;draw&#x27;;
                drawModeLabel1.text(&quot;Draw&quot;);
                currentInkController.set_mode(1); // draw mode
            }
        });

        // erase label
        var eraseLabel = $(document.createElement(&#x27;label&#x27;));
        eraseLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;gray&#x27;, &#x27;margin-right&#x27;: &#x27;9%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;right&#x27; });
        eraseLabel.text(&quot;Erase&quot;);
        drawModeDiv.append(eraseLabel);

        // block label click handler
        eraseLabel.on(&#x27;click&#x27;, function () {
            if (drawMode === &#x27;draw&#x27;) {
                drawLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                eraseLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                drawMode = &#x27;erase&#x27;;
                drawModeLabel1.text(&quot;Erase&quot;);
                currentInkController.set_mode(2); // erase mode
            }
        });

        /////////////////////////////////////



        // brush width label
        var brushLabel = $(document.createElement(&#x27;div&#x27;));
        brushLabel.addClass(&#x27;thicknessLabel&#x27;);
        var brushLabel1 = $(document.createElement(&#x27;div&#x27;));
        brushLabel.text(&quot;Width: &quot;);
        brushLabel1.text(&quot;7px&quot;);
        brushLabel.append(brushLabel1);
        inkDrawControls.append(brushLabel);
        brushLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, /*&#x27;float&#x27;: &#x27;right&#x27;,*/ &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        brushLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // brush width slider
        var brushSlider = $(document.createElement(&#x27;div&#x27;));
        brushSlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        });
        inkDrawControls.append(brushSlider);
        drawArray.push(brushSlider);
        var brushSliderPoint = $(document.createElement(&#x27;div&#x27;));
        brushSliderPoint.attr(&#x27;id&#x27;, &#x27;brushSlider&#x27;);
        brushSliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &quot;relative&quot;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;
        });
        brushSliderPoint.attr(&#x27;value&#x27;, 7.0);
        brushSlider.append(brushSliderPoint);

        // brush width label click handler -- opens brush width slider
        brushLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            brushLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawArray, brushSlider);
            //currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
        });
        
        // brush width slider drag handler
        brushSliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                brushSliderPoint.attr(&#x27;value&#x27;, (brushSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;) / (brushSlider.offset().left + brushSlider.width()) * 60 + 1) + 6); // get values in the right range
                if (brushSliderPoint.value &lt; 7) {
                    brushSliderPoint.attr(&#x27;value&#x27;, 7.0);
                }
                currentInkController.updatePenWidth(&quot;brushSlider&quot;);
                currentInkController.setEraserWidth(brushSliderPoint.attr(&#x27;value&#x27;));
                //currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
                brushLabel1.text(Math.round(brushSliderPoint.attr(&#x27;value&#x27;)) + &quot;px&quot;);
            },
            appendTo: &#x27;body&#x27;
        });
        
        // brush color label
        var colorLabel = $(document.createElement(&#x27;div&#x27;));
        colorLabel.addClass(&#x27;thicknessLabel&#x27;);
        var colorLabel1 = $(document.createElement(&#x27;div&#x27;));
        colorLabel1.addClass(&#x27;changeColor1&#x27;);
        colorLabel.text(&quot;Color: &quot;);
        colorLabel1.text(&quot;#000000&quot;);
        colorLabel.append(colorLabel1);
        inkDrawControls.append(colorLabel);
        colorLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        colorLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });

        // div to contain color picker
        var colorDiv = $(document.createElement(&#x27;div&#x27;));
        colorDiv.css(&#x27;display&#x27;, &#x27;none&#x27;);
        inkDrawControls.append(colorDiv);
        drawArray.push(colorDiv);

        // color label click handler
        colorLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            colorLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawArray, colorDiv);
            currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
            drawLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawMode = &#x27;draw&#x27;;
            drawModeLabel1.text(&quot;Draw&quot;);
        });

        // input element for color picker
        var item = document.createElement(&#x27;input&#x27;);
        $(item).attr(&#x27;id&#x27;, &#x27;brushColorToggle&#x27;);
        $(item).attr(&#x27;readonly&#x27;, &#x27;readonly&#x27;);
        $(item).css({ &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;40%&#x27;});
        item.onfocus = function () {
            currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
        };
        $(item).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });
        if (item.addEventListener) {
            item.addEventListener(&#x27;DOMNodeInserted&#x27;, function () {
                //initialize colorpicker object on current element
                myPicker = new jscolor.color(item, {});
                myPicker.fromString(&quot;000000&quot;);
                myPicker.onImmediateChange = function () {
                    currentInkController.updatePenColor(&quot;brushColorToggle&quot;);
                    currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
                    $(&#x27;.changeColor1&#x27;)[0].innerHTML = &quot;#&quot;+$(&quot;#brushColorToggle&quot;).attr(&quot;value&quot;);
                };
            }, false);
        }
        colorDiv.append(item);

        //// eraser width label
        //var eraserLabel = $(document.createElement(&#x27;div&#x27;));
        //eraserLabel.addClass(&#x27;thicknessLabel&#x27;);
        //var eraserLabel1 = $(document.createElement(&#x27;div&#x27;));
        //eraserLabel.text(&quot;Eraser: &quot;);
        //eraserLabel1.text(&quot;7px&quot;);
        //eraserLabel.append(eraserLabel1);
        //inkDrawControls.append(eraserLabel);
        //eraserLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        //eraserLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        //// eraser width slider
        //var eraserSlider = $(document.createElement(&#x27;div&#x27;));
        //eraserSlider.css({
        //    &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
        //    &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        //});
        //inkDrawControls.append(eraserSlider);
        //drawArray.push(eraserSlider);

        //// eraser label click handler
        //eraserLabel.on(&#x27;click&#x27;, function () {
        //    $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
        //    eraserLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
        //    updateToggle(drawArray, eraserSlider);
        //    currentInkController.set_mode(LADS.TourAuthoring.InkMode.erase);
        //});
        //var eraserSliderPoint = $(document.createElement(&#x27;div&#x27;));
        //eraserSliderPoint.attr(&#x27;id&#x27;, &#x27;eraserSlider&#x27;);
        //eraserSliderPoint.css({
        //    &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
        //    &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;
        //});
        //eraserSliderPoint.attr(&#x27;value&#x27;, 7.0);
        //eraserSlider.append(eraserSliderPoint);

        //// eraser width slider drag handler
        //eraserSliderPoint.draggable({
        //    axis: &quot;x&quot;, containment: &quot;parent&quot;,
        //    scroll: false,
        //    drag: function (event) {
        //        eraserSliderPoint.attr(&#x27;value&#x27;, (parseFloat(eraserSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;)) / parseFloat(eraserSlider.offset().left + eraserSlider.width()) * 60 + 1) + 6);// * 24.33 + 1;
        //        if (eraserSliderPoint.value &lt; 7) {
        //            eraserSliderPoint.attr(&#x27;value&#x27;, 7.0);
        //        }
        //        currentInkController.setEraserWidth(eraserSliderPoint.attr(&#x27;value&#x27;));
        //        eraserLabel1.text(Math.round(eraserSliderPoint.attr(&#x27;value&#x27;)) + &quot;px&quot;);
        //    },
        //    appendTo: &#x27;body&#x27;
        //});

        // draw opacity label
        var opacityLabel = $(document.createElement(&#x27;div&#x27;));
        opacityLabel.addClass(&#x27;thicknessLabel&#x27;);
        var opacityLabel1 = $(document.createElement(&#x27;div&#x27;));
        opacityLabel.text(&quot;Opacity: &quot;);
        opacityLabel1.text(&quot;100%&quot;);
        opacityLabel.append(opacityLabel1);
        inkDrawControls.append(opacityLabel);
        opacityLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        opacityLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // draw opacity slider
        var opacitySlider = $(document.createElement(&#x27;div&#x27;));
        opacitySlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        });
        inkDrawControls.append(opacitySlider);
        drawArray.push(opacitySlider);
        var opacitySliderPoint = $(document.createElement(&#x27;div&#x27;));
        opacitySliderPoint.attr(&#x27;id&#x27;, &#x27;opacitySlider&#x27;);
        opacitySliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &quot;margin-top&quot;: &quot;-0.57%&quot;
        });
        opacitySliderPoint.attr(&quot;value&quot;, 1.0);
        opacitySlider.append(opacitySliderPoint);

        // opacity label click handler
        opacityLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            opacityLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawArray, opacitySlider);
            currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
            drawLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawMode = &#x27;draw&#x27;;
            drawModeLabel1.text(&quot;Draw&quot;);
        });

        // opacity slider drag handler
        opacitySliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                opacitySliderPoint.attr(&#x27;value&#x27;, (parseFloat(opacitySliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;)) / (parseFloat(opacitySlider.offset().left) + parseFloat(opacitySlider.width())) * 1.28));
                if (opacitySliderPoint[0].value &gt; 0.99) {
                    opacitySliderPoint.attr(&#x27;value&#x27;, 1.0);
                }
                else if (opacitySliderPoint[0].value &lt; 0) {
                    opacitySliderPoint.attr(&#x27;value&#x27;, 0.0);
                }
                currentInkController.updatePenOpacity(&quot;opacitySlider&quot;);
                opacityLabel1.text(Math.round(100 * opacitySliderPoint.attr(&quot;value&quot;)) + &quot;%&quot;);
            },
            appendTo: &#x27;body&#x27;
        });
        
        // draw attach buttons
        var linkDrawDiv = getAttachDiv(inkDrawControls);
        inkDrawControls.append(linkDrawDiv);
        functionsPanel.append(inkDrawDocfrag);

        /**
         * Edit draw controls (edit mode)
         */

        // edit draw control panel
        var editDrawDocfrag = document.createDocumentFragment();
        inkEditDraw = $(document.createElement(&#x27;div&#x27;));
        inkEditDraw.attr(&quot;id&quot;, &quot;inkEditDraw&quot;);
        inkEditDraw.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27;, });
        editDrawDocfrag.appendChild(inkEditDraw[0]);
        inkEditDraw.css(&#x27;display&#x27;, &#x27;none&#x27;);

        // cancel edit draw button
        var cancelEditDrawButton = $(document.createElement(&#x27;button&#x27;));
        cancelEditDrawButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;80%&#x27; });
        cancelEditDrawButton.get(0).innerHTML = &quot;Cancel&quot;;
        inkEditDraw.append(cancelEditDrawButton);

        var drawEditArray = []; // array of draw controls

        /////////////////////////////////////

        // draw mode div (contains draw and eraser labels)
        var drawEditModeDiv = $(document.createElement(&#x27;div&#x27;));
        drawEditModeDiv.css({ &quot;height&quot;: &#x27;10%&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;display&#x27;: &#x27;none&#x27; });

        // draw mode label
        var drawEditModeLabel = $(document.createElement(&#x27;div&#x27;));
        drawEditModeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var drawEditModeLabel1 = $(document.createElement(&#x27;div&#x27;));
        drawEditModeLabel.text(&quot;Mode: &quot;);
        drawEditModeLabel1.text(&quot;Draw&quot;);
        drawEditModeLabel.append(drawEditModeLabel1);
        drawEditModeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        drawEditModeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        inkEditDraw.append(drawEditModeLabel);
        inkEditDraw.append(drawEditModeDiv);
        drawEditArray.push(drawEditModeDiv);

        // draw mode label click handler
        drawEditModeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            drawEditModeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawEditArray, drawEditModeDiv);
        });

        // draw label
        var drawEditMode = &#x27;draw&#x27;;
        var drawEditLabel = $(document.createElement(&#x27;label&#x27;));
        drawEditLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27; });
        drawEditLabel.text(&quot;Draw&quot;);
        drawEditModeDiv.append(drawEditLabel);

        // draw label click handler
        drawEditLabel.on(&#x27;click&#x27;, function () {
            if (drawEditMode === &#x27;erase&#x27;) {
                drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                drawEditMode = &#x27;draw&#x27;;
                drawEditModeLabel1.text(&quot;Draw&quot;);
                currentInkController.set_mode(1); // draw mode
            }
        });

        // erase label
        var eraseEditLabel = $(document.createElement(&#x27;label&#x27;));
        eraseEditLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;gray&#x27;, &#x27;margin-right&#x27;: &#x27;9%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;right&#x27; });
        eraseEditLabel.text(&quot;Erase&quot;);
        drawEditModeDiv.append(eraseEditLabel);

        // block label click handler
        eraseEditLabel.on(&#x27;click&#x27;, function () {
            if (drawEditMode === &#x27;draw&#x27;) {
                drawEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                eraseEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                drawEditMode = &#x27;erase&#x27;;
                drawEditModeLabel1.text(&quot;Erase&quot;);
                currentInkController.set_mode(2); // erase mode
            }
        });

        /////////////////////////////////////

        // brush width label
        var brushEditLabel = $(document.createElement(&#x27;div&#x27;));
        brushEditLabel.addClass(&#x27;thicknessLabel&#x27;);
        var brushEditLabel1 = $(document.createElement(&#x27;div&#x27;));
        brushEditLabel.text(&quot;Width: &quot;);
        brushEditLabel1.text(&quot;7px&quot;);
        brushEditLabel.append(brushEditLabel1);
        inkEditDraw.append(brushEditLabel);
        brushEditLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        brushEditLabel.css({ &#x27;-ms-touch-action&#x27;: &#x27;none&#x27;, &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // brush width slider
        var brushEditSlider = $(document.createElement(&#x27;div&#x27;));
        brushEditSlider.addClass(&quot;brushEditSlider&quot;);
        brushEditSlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;, &#x27;float&#x27;: &#x27;left&#x27;
        });
        inkEditDraw.append(brushEditSlider);
        drawEditArray.push(brushEditSlider);
        var brushEditSliderPoint = $(document.createElement(&#x27;div&#x27;));
        brushEditSliderPoint.attr(&#x27;id&#x27;, &#x27;brushEditSlider&#x27;);
        brushEditSliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &quot;relative&quot;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;
        });
        brushEditSliderPoint.attr(&#x27;value&#x27;, 7.0);
        brushEditSlider.append(brushEditSliderPoint);

        // brush width label click handler
        brushEditLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            brushEditLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawEditArray, brushEditSlider);
            //currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
        });

        // brush width slider drag handler
        brushEditSliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                brushEditSliderPoint.attr(&#x27;value&#x27;, (brushEditSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;) / (brushEditSlider.offset().left + brushEditSlider.width()) * 60 + 1) + 6);// * 24.33 + 1;
                if (brushEditSliderPoint.value &lt; 7) {
                    brushEditSliderPoint.attr(&#x27;value&#x27;, 7.0);
                }
                currentInkController.updatePenWidth(&quot;brushEditSlider&quot;);
                //currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
                brushEditLabel1.text(Math.round(brushEditSliderPoint.attr(&#x27;value&#x27;)) + &quot;px&quot;);
            },
            appendTo: &#x27;body&#x27;
        });

        // brush color label
        var colorEditLabel = $(document.createElement(&#x27;div&#x27;));
        colorEditLabel.addClass(&#x27;thicknessLabel&#x27;);
        var colorEditLabel1 = $(document.createElement(&#x27;div&#x27;));
        colorEditLabel1.addClass(&#x27;changeColor1Edit&#x27;);
        colorEditLabel.text(&quot;Color: &quot;);
        colorEditLabel1.text(&quot;#000000&quot;);
        colorEditLabel.append(colorEditLabel1);
        inkEditDraw.append(colorEditLabel);
        colorEditLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        colorEditLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });

        // div containing color picker
        var colorEditDiv = $(document.createElement(&#x27;div&#x27;));
        colorEditDiv.css(&#x27;display&#x27;, &#x27;none&#x27;);
        inkEditDraw.append(colorEditDiv);
        drawEditArray.push(colorEditDiv);

        // color label click handler
        colorEditLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            colorEditLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawEditArray, colorEditDiv);
            currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
            drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawEditMode = &#x27;draw&#x27;;
            drawEditModeLabel1.text(&quot;Draw&quot;);
        });

        // input element for color picker
        var itemEdit = document.createElement(&#x27;input&#x27;);
        $(itemEdit).attr(&#x27;id&#x27;, &#x27;brushEditColorToggle&#x27;);
        $(itemEdit).attr(&#x27;readonly&#x27;, &#x27;readonly&#x27;);
        $(itemEdit).css({ &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;40%&#x27; });
        itemEdit.onfocus = function () {
            currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
            drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawEditMode = &#x27;draw&#x27;;
            drawEditModeLabel1.text(&quot;Draw&quot;);
        };
        $(itemEdit).on(&#x27;keyup&#x27;, function (event) {
            event.stopPropagation();
        });
        if (itemEdit.addEventListener) {
            itemEdit.addEventListener(&#x27;DOMNodeInserted&#x27;, function () {
                //initialize colorpicker object on current element
                myEditDrawPicker = new jscolor.color(itemEdit, {});
                myEditDrawPicker.fromString(&quot;000000&quot;);
                myEditDrawPicker.onImmediateChange = function () {
                    currentInkController.updatePenColor(&quot;brushEditColorToggle&quot;);
                    currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
                    drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                    eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                    drawEditMode = &#x27;draw&#x27;;
                    drawEditModeLabel1.text(&quot;Draw&quot;);
                    $(&#x27;.changeColor1Edit&#x27;)[0].innerHTML = currentInkController.getPenColor();
                };
            }, false);
        }
        colorEditDiv.append(itemEdit);
        
        //// eraser width label
        //var eraserEditLabel = $(document.createElement(&#x27;div&#x27;));
        //eraserEditLabel.addClass(&#x27;thicknessLabel&#x27;);
        //var eraserEditLabel1 = $(document.createElement(&#x27;div&#x27;));
        //eraserEditLabel.text(&quot;eraser: &quot;);
        //eraserEditLabel1.text(&quot;7px&quot;);
        //eraserEditLabel.append(eraserEditLabel1);
        //inkEditDraw.append(eraserEditLabel);
        //eraserEditLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        //eraserEditLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        //// eraser width slider
        //var eraserEditSlider = $(document.createElement(&#x27;div&#x27;));
        //eraserEditSlider.css({
        //    &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
        //    &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        //});
        //inkEditDraw.append(eraserEditSlider);
        //drawEditArray.push(eraserEditSlider);

        //// eraser width label click handler
        //eraserEditLabel.on(&#x27;click&#x27;, function () {
        //    $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
        //    eraserEditLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
        //    updateToggle(drawEditArray, eraserEditSlider);
        //    currentInkController.set_mode(LADS.TourAuthoring.InkMode.erase);
        //});
        //var eraserEditSliderPoint = $(document.createElement(&#x27;div&#x27;));
        //eraserEditSliderPoint.attr(&#x27;id&#x27;, &#x27;eraserEditSlider&#x27;);
        //eraserEditSliderPoint.css({
        //    &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
        //    &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;
        //});
        //eraserEditSliderPoint.attr(&#x27;value&#x27;, 7.0);
        //eraserEditSlider.append(eraserEditSliderPoint);

        //// eraser width slider drag handler
        //eraserEditSliderPoint.draggable({
        //    axis: &quot;x&quot;, containment: &quot;parent&quot;,
        //    scroll: false,
        //    drag: function (event) {
        //        eraserEditSliderPoint.attr(&#x27;value&#x27;, (eraserEditSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;) / (eraserEditSlider.offset().left + eraserEditSlider.width()) * 60 + 1) + 6);// * 24.33 + 1;
        //        if (eraserEditSliderPoint.value &lt; 7) {
        //            eraserEditSliderPoint.attr(&#x27;value&#x27;, 7.0);
        //        }
        //        currentInkController.updateEraserWidth(&quot;eraserEditSlider&quot;);
        //        eraserEditLabel1.text(Math.round(eraserEditSliderPoint.attr(&#x27;value&#x27;)) + &quot;px&quot;);
        //    },
        //    appendTo: &#x27;body&#x27;
        //});

        // draw opacity label
        var opacityEditLabel = $(document.createElement(&#x27;div&#x27;));
        opacityEditLabel.addClass(&#x27;thicknessLabel&#x27;);
        var opacityEditLabel1 = $(document.createElement(&#x27;div&#x27;));
        opacityEditLabel.text(&quot;opacity: &quot;);
        opacityEditLabel1.text(&quot;100%&quot;);
        opacityEditLabel.append(opacityEditLabel1);
        inkEditDraw.append(opacityEditLabel);
        opacityEditLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        opacityEditLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // draw opacity slider
        var opacityEditSlider = $(document.createElement(&#x27;div&#x27;));
        opacityEditSlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;
        });
        inkEditDraw.append(opacityEditSlider);
        drawEditArray.push(opacityEditSlider);
        var opacityEditSliderPoint = $(document.createElement(&#x27;div&#x27;));
        opacityEditSliderPoint.attr(&#x27;id&#x27;, &#x27;opacityEditSlider&#x27;);
        opacityEditSliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &#x27;left&#x27;: &#x27;87%&#x27;, &quot;margin-top&quot;: &quot;-0.57%&quot;
        });
        opacityEditSliderPoint.attr(&quot;value&quot;, 1.0);
        opacityEditSlider.append(opacityEditSliderPoint);

        // draw opacity label click handler
        opacityEditLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            opacityEditLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(drawEditArray, opacityEditSlider);
            currentInkController.set_mode(1);
            drawEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawEditMode = &#x27;draw&#x27;;
            drawEditModeLabel1.text(&quot;Draw&quot;);
        });

        // draw opacity slider drag handler
        opacityEditSliderPoint.draggable({
             axis: &quot;x&quot;, containment: &quot;parent&quot;,
             scroll: false,
             drag: function (event) {
                 opacityEditSliderPoint.attr(&#x27;value&#x27;, (parseFloat(opacityEditSliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;)) / (parseFloat(opacityEditSlider.offset().left) + parseFloat(opacityEditSlider.width())) * 1.28));
                 if (opacityEditSliderPoint[0].value &gt; 0.99) {
                     opacityEditSliderPoint.attr(&#x27;value&#x27;, 1.0);
                 }
                 else if (opacityEditSliderPoint[0].value &lt; 0) {
                     opacityEditSliderPoint.attr(&#x27;value&#x27;, 0.0);
                 }
                 currentInkController.updatePenOpacity(&quot;opacityEditSlider&quot;);
                 opacityEditLabel1.text(Math.round(100 * opacityEditSliderPoint.attr(&quot;value&quot;)) + &quot;%&quot;);
             },
             appendTo: &#x27;body&#x27;
         });
        

        // edit draw save button
        var saveDrawButton = $(document.createElement(&#x27;button&#x27;));
        saveDrawButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;80%&#x27; });
        saveDrawButton.get(0).innerHTML = &quot;Save&quot;;
        inkEditDraw.append(saveDrawButton);

        functionsPanel.append(editDrawDocfrag);

        /**
         * Ink transparency controls (initial authoring, not editing mode)
         */

        // transparency control panel
        var inkTransparencyDocfrag = document.createDocumentFragment();
        inkTransparencyControls = $(document.createElement(&#x27;div&#x27;));
        inkTransparencyControls.attr(&quot;id&quot;,&quot;inkTransControls&quot;);
        inkTransparencyControls.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27; });
        inkTransparencyDocfrag.appendChild(inkTransparencyControls[0]);
        inkTransparencyControls.css({ &quot;display&quot;: &quot;none&quot; });

        // trans cancel button
        var cancelTransButton = $(document.createElement(&#x27;button&#x27;));
        cancelTransButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, /*&#x27;width&#x27;: &#x27;25%&#x27;*/ &#x27;width&#x27;: &#x27;80%&#x27; });
        cancelTransButton.get(0).innerHTML = &quot;Cancel&quot;;
        cancelTransButton.on(&#x27;click&#x27;, function () {
            removeInkCanv();
            inkTransparencyControls.hide();
            timeline.setModifyingInk(false);
            timeline.setEditInkOn(false);

            inkAuthoring.getInkUndoManager().clear();
            undoManager.greyOutBtn();
            // revert undo/redo buttons to global undo/redo functionality
            playbackControls.undoButton.off(&quot;click&quot;);
            playbackControls.redoButton.off(&quot;click&quot;);
            playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                undoManager.undo();
            });
            playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                undoManager.redo();
            });
            //console.log(&quot;reseting undo-redo buttons to global&quot;);
            playbackControls.undoRedoInkOnly.css({ &#x27;display&#x27;: &#x27;none&#x27; });
        });
        inkTransparencyControls.append(cancelTransButton);

        var transArray = []; // array of transparency controls
        
        // add ellipse bounding shape button
        var addEllipseButton = $(document.createElement(&#x27;button&#x27;));
        addEllipseButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27; });
        addEllipseButton.get(0).innerHTML = &quot;Add Ellipse&quot;;
        addEllipseButton.on(&#x27;click&#x27;, function () {
            currentInkController.add_ellipse();
        });
        inkTransparencyControls.append(addEllipseButton);

        // add rectangle bounding shape button
        var addRectButton = $(document.createElement(&#x27;button&#x27;));
        addRectButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27; });
        addRectButton.get(0).innerHTML = &quot;Add Rectangle&quot;;
        addRectButton.on(&#x27;click&#x27;, function () {
            currentInkController.add_rectangle();
        });
        inkTransparencyControls.append(addRectButton);

        // trans mode div (contains isolate and block labels)
        var transModeDiv = $(document.createElement(&#x27;div&#x27;));
        transModeDiv.css({ &quot;height&quot;: &#x27;10%&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;display&#x27;: &#x27;none&#x27; });

        // trans mode label
        var transModeLabel = $(document.createElement(&#x27;div&#x27;));
        transModeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var transModeLabel1 = $(document.createElement(&#x27;div&#x27;));
        transModeLabel.text(&quot;Mode: &quot;);
        transModeLabel1.text(&quot;Isolate&quot;);
        transModeLabel.append(transModeLabel1);
        transModeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        transModeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        inkTransparencyControls.append(transModeLabel);
        inkTransparencyControls.append(transModeDiv);
        transArray.push(transModeDiv);

        // trans mode label click handler
        transModeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            transModeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(transArray, transModeDiv);
        });

        // isolate label
        var transparencyMode = &#x27;isolate&#x27;;
        var isolateLabel = $(document.createElement(&#x27;label&#x27;));
        isolateLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27; });
        isolateLabel.text(&quot;Isolate&quot;);
        transModeDiv.append(isolateLabel);

        // isolate label click handler
        isolateLabel.on(&#x27;click&#x27;, function () {
            if (transparencyMode === &#x27;block&#x27;) {
                isolateLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                blockLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                transparencyMode = &#x27;isolate&#x27;;
                transModeLabel1.text(&quot;Isolate&quot;);
                currentInkController.setTransMode(&quot;isolate&quot;);         
            }
        });

        // block label
        var blockLabel = $(document.createElement(&#x27;label&#x27;));
        blockLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;gray&#x27;, &#x27;margin-right&#x27;: &#x27;9%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;right&#x27; });
        blockLabel.text(&quot;Block&quot;);
        transModeDiv.append(blockLabel);

        // block label click handler
        blockLabel.on(&#x27;click&#x27;, function () {
            if (transparencyMode === &#x27;isolate&#x27;) {
                isolateLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                blockLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                transparencyMode = &#x27;block&#x27;;
                transModeLabel1.text(&quot;Block&quot;);
                currentInkController.setTransMode(&quot;block&quot;);
            }
        });

        // trans opacity label
        var opacityTransparencyLabel = $(document.createElement(&#x27;div&#x27;));
        opacityTransparencyLabel.addClass(&#x27;thicknessLabel&#x27;);
        var opacityTransparencyLabel1 = $(document.createElement(&#x27;div&#x27;));
        opacityTransparencyLabel.text(&quot;Opacity: &quot;);
        opacityTransparencyLabel1.text(&quot;80%&quot;);
        opacityTransparencyLabel.append(opacityTransparencyLabel1);
        inkTransparencyControls.append(opacityTransparencyLabel);
        opacityTransparencyLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        opacityTransparencyLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // trans opacity slider
        var opacityTransparencySlider = $(document.createElement(&#x27;div&#x27;));
        opacityTransparencySlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;/*, &#x27;float&#x27;: &#x27;left&#x27;*/

        });
        var opacityTransparencySliderPoint = $(document.createElement(&#x27;div&#x27;));
        opacityTransparencySliderPoint.attr(&quot;id&quot;, &quot;opacityTransparencySliderPoint&quot;);
        opacityTransparencySliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &quot;margin-top&quot;: &quot;-0.57%&quot;
        });
        opacityTransparencySlider.append(opacityTransparencySliderPoint);
        inkTransparencyControls.append(opacityTransparencySlider);

        // trans opacity label click handler
        opacityTransparencyLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            opacityTransparencyLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(transArray, opacityTransparencySlider);
        });

        // trans opacity slider drag handler
        opacityTransparencySliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                opacityTransparencySliderPoint.attr(&#x27;value&#x27;, (parseFloat(opacityTransparencySliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;)) / (parseFloat(opacityTransparencySlider.offset().left) + parseFloat(opacityTransparencySlider.width())) * 1.28));
                if (opacityTransparencySliderPoint[0].value &gt; 0.99) {
                    opacityTransparencySliderPoint.attr(&#x27;value&#x27;, 1.0);
                }
                else if (opacityTransparencySliderPoint[0].value &lt; 0) {
                    opacityTransparencySliderPoint.attr(&#x27;value&#x27;, 0.0);
                }
                currentInkController.setMarqueeFillOpacity(parseFloat(opacityTransparencySliderPoint.attr(&quot;value&quot;)));
                opacityTransparencyLabel1.text(Math.round(100 * opacityTransparencySliderPoint.attr(&quot;value&quot;)) + &quot;%&quot;);
            },
            appendTo: &#x27;body&#x27;
        });
        transArray.push(opacityTransparencySlider);

        // trans attach buttons
        var linkTransDiv = getAttachDiv(inkTransparencyControls, 0, &quot;trans&quot;);
        inkTransparencyControls.append(linkTransDiv);
        functionsPanel.append(inkTransparencyDocfrag);

        /**
         * Edit transparency controls (edit mode)
         */

        // edit trans control panel
        var editTransparencyDocfrag = document.createDocumentFragment();
        inkEditTransparency = $(document.createElement(&#x27;div&#x27;));
        inkEditTransparency.attr(&quot;id&quot;, &quot;inkEditTransparency&quot;);
        inkEditTransparency.css({ &#x27;height&#x27;: &#x27;425%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;, top: &#x27;130%&#x27;, position: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0, &#x27;overflow-y&#x27;: &#x27;auto&#x27;, &#x27;margin-top&#x27;: &#x27;8%&#x27; });
        editTransparencyDocfrag.appendChild(inkEditTransparency[0]);
        inkEditTransparency.css({ &quot;display&quot;: &quot;none&quot; });

        // trans cancel button
        var cancelEditTransButton = $(document.createElement(&#x27;button&#x27;));
        cancelEditTransButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, /*&#x27;width&#x27;: &#x27;25%&#x27;*/ &#x27;width&#x27;: &#x27;80%&#x27; });
        cancelEditTransButton.get(0).innerHTML = &quot;Cancel&quot;;
        inkEditTransparency.append(cancelEditTransButton);

        var transEditArray = []; // array of edit transparency controls

        // add ellipse bounding shape button
        var addEditEllipseButton = $(document.createElement(&#x27;button&#x27;));
        addEditEllipseButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27; });
        addEditEllipseButton.get(0).innerHTML = &quot;Add Ellipse&quot;;
        addEditEllipseButton.on(&#x27;click&#x27;, function () {
            currentInkController.add_ellipse();
        });
        inkEditTransparency.append(addEditEllipseButton);

        // add rectangle bounding shape button
        var addEditRectButton = $(document.createElement(&#x27;button&#x27;));
        addEditRectButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27; });
        addEditRectButton.get(0).innerHTML = &quot;Add Rectangle&quot;;
        addEditRectButton.on(&#x27;click&#x27;, function () {
            currentInkController.add_rectangle();
        });
        inkEditTransparency.append(addEditRectButton);

        // div containing transparency mode options
        var transEditModeDiv = $(document.createElement(&#x27;div&#x27;));
        transEditModeDiv.css({ &quot;height&quot;: &#x27;10%&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;display&#x27;: &#x27;none&#x27; });

        // trans mode label
        var transEditModeLabel = $(document.createElement(&#x27;div&#x27;));
        transEditModeLabel.addClass(&#x27;thicknessLabel&#x27;);
        var transEditModeLabel1 = $(document.createElement(&#x27;div&#x27;));
        transEditModeLabel.text(&quot;Mode: &quot;);
        transEditModeLabel1.text(&quot;Isolate&quot;);
        transModeLabel.attr(&quot;id&quot;, &quot;transModeLabel&quot;);
        transEditModeLabel.append(transEditModeLabel1);
        transEditModeLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        transEditModeLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });
        inkEditTransparency.append(transEditModeLabel);
        inkEditTransparency.append(transEditModeDiv);
        transEditArray.push(transEditModeDiv);

        //trans mode click handler
        transEditModeLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            transEditModeLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(transEditArray, transEditModeDiv);
        });

        var transparencyEditMode = &#x27;isolate&#x27;;

        // isolate label
        var isolateEditLabel = $(document.createElement(&#x27;label&#x27;));
        isolateEditLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27; });
        isolateEditLabel.text(&quot;Isolate&quot;);
        transEditModeDiv.append(isolateEditLabel);

        // isolate label click handler
        isolateEditLabel.on(&#x27;click&#x27;, function () {
            if (transparencyEditMode === &#x27;block&#x27;) {
                isolateEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                blockEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                transparencyEditMode = &#x27;isolate&#x27;;
                transEditModeLabel1.text(&quot;Isolate&quot;);
                currentInkController.setTransMode(&quot;isolate&quot;);
            }
        });

        // block label
        var blockEditLabel = $(document.createElement(&#x27;label&#x27;));
        blockEditLabel.css({ &#x27;font-size&#x27;: &#x27;120%&#x27;, &#x27;color&#x27;: &#x27;gray&#x27;, &#x27;margin-right&#x27;: &#x27;9%&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;right&#x27; });
        blockEditLabel.text(&quot;Block&quot;);
        transEditModeDiv.append(blockEditLabel);

        // block label click handler
        blockEditLabel.on(&#x27;click&#x27;, function () {
            if (transparencyEditMode === &#x27;isolate&#x27;) {
                isolateEditLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
                blockEditLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
                transparencyEditMode = &#x27;block&#x27;;
                transEditModeLabel1.text(&quot;Block&quot;);
                currentInkController.setTransMode(&quot;block&quot;);
            }
        });

        // trans opacity label
        var opacityEditTransparencyLabel = $(document.createElement(&#x27;div&#x27;));
        opacityEditTransparencyLabel.addClass(&#x27;thicknessLabel&#x27;);
        var opacityEditTransparencyLabel1 = $(document.createElement(&#x27;div&#x27;));
        opacityEditTransparencyLabel.text(&quot;Opacity: &quot;);
        opacityEditTransparencyLabel1.text(&quot;80%&quot;);
        opacityEditTransparencyLabel.append(opacityEditTransparencyLabel1);
        inkEditTransparency.append(opacityEditTransparencyLabel);
        opacityEditTransparencyLabel1.css({ &#x27;color&#x27;: &#x27;green&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;padding-left&#x27;: &#x27;2%&#x27; });
        opacityEditTransparencyLabel.css({ &#x27;font-size&#x27;: &#x27;130%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;font-weight&#x27;: &#x27;normal&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-right&#x27;: &#x27;12%&#x27;, &#x27;margin-bottom&#x27;: &#x27;1%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;display&#x27;: &#x27;inline&#x27;, &#x27;border-bottom-width&#x27;: &#x27; 2px&#x27;, &#x27;border-bottom-style&#x27;: &#x27;solid&#x27;, &#x27;border-bottom-color&#x27;: &#x27;white&#x27;, &#x27;width&#x27;: &#x27;80%&#x27;, });

        // trans opacity slider
        var opacityEditTransparencySlider = $(document.createElement(&#x27;div&#x27;));
        opacityEditTransparencySlider.attr(&quot;id&quot;, &quot;opacityEditTransparencySlider&quot;);
        opacityEditTransparencySlider.css({
            &#x27;clear&#x27;: &#x27;both&#x27;, &#x27;background-color&#x27;: &#x27;rgb(136, 134, 134)&#x27;, &quot;border-radius&quot;: &quot;25px&quot;, &quot;-ms-touch-action&quot;: &quot;none&quot;, &#x27;border&#x27;: &#x27;1px solid gray&#x27;,
            &#x27;width&#x27;: &#x27;70%&#x27;, &#x27;height&#x27;: &#x27;21px&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;display&#x27;: &#x27;none&#x27;, &#x27;position&#x27;: &#x27;relative&#x27;/*, &#x27;float&#x27;: &#x27;left&#x27;*/
        });
        var opacityEditTransparencySliderPoint = $(document.createElement(&#x27;div&#x27;));
        opacityEditTransparencySliderPoint.attr(&quot;id&quot;, &quot;opacityEditTransparencySliderPoint&quot;);
        opacityEditTransparencySliderPoint.css({
            &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;height&#x27;: &#x27;115%&#x27;, &#x27;width&#x27;: &#x27;9.25%&#x27;, &#x27;position&#x27;: &quot;relative&quot;,
            &#x27;border&#x27;: &#x27;1px&#x27;, &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-color&#x27;: &#x27;gray&#x27;, &quot;border-radius&quot;: &quot;50%&quot;, &quot;top&quot;: &quot;-5%&quot;, &quot;margin-top&quot;: &quot;-0.57%&quot;
        });
        opacityEditTransparencySlider.append(opacityEditTransparencySliderPoint);
        inkEditTransparency.append(opacityEditTransparencySlider);

        // trans opacity label click handler
        opacityEditTransparencyLabel.on(&#x27;click&#x27;, function () {
            $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
            opacityEditTransparencyLabel.css({ &#x27;font-weight&#x27;: &#x27;bold&#x27; });
            updateToggle(transEditArray, opacityEditTransparencySlider);
        });

        // trans opacity slider drag handler
        opacityEditTransparencySliderPoint.draggable({
            axis: &quot;x&quot;, containment: &quot;parent&quot;,
            scroll: false,
            drag: function (event) {
                opacityEditTransparencySliderPoint.attr(&#x27;value&#x27;, (parseFloat(opacityEditTransparencySliderPoint.css(&quot;left&quot;).replace(&#x27;px&#x27;, &#x27;&#x27;)) / (parseFloat(opacityEditTransparencySlider.offset().left) + parseFloat(opacityEditTransparencySlider.width())) * 1.28));
                if (opacityEditTransparencySliderPoint[0].value &gt; 0.99) {
                    opacityEditTransparencySliderPoint.attr(&#x27;value&#x27;, 1.0);
                }
                else if (opacityEditTransparencySliderPoint[0].value &lt; 0) {
                    opacityEditTransparencySliderPoint.attr(&#x27;value&#x27;, 0.0);
                }
                currentInkController.setMarqueeFillOpacity(parseFloat(opacityEditTransparencySliderPoint.attr(&quot;value&quot;)));
                opacityEditTransparencyLabel1.text(Math.round(100 * opacityEditTransparencySliderPoint.attr(&quot;value&quot;)) + &quot;%&quot;);
            },
            appendTo: &#x27;body&#x27;
        });
        transEditArray.push(opacityEditTransparencySlider);

        // edit trans save button
        var saveTransButton = $(document.createElement(&#x27;button&#x27;));
        saveTransButton.css({ &#x27;font-size&#x27;: &#x27;100%&#x27;, &#x27;color&#x27;: &#x27;black&#x27;, &#x27;margin-top&#x27;: &#x27;3%&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-bottom&#x27;: &#x27;10px&#x27;, &#x27;font-weight&#x27;: &#x27;bold&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;width&#x27;: &#x27;80%&#x27; });
        saveTransButton.get(0).innerHTML = &quot;Save&quot;;
        inkEditTransparency.append(saveTransButton);
        functionsPanel.append(editTransparencyDocfrag);

        /**
         * Below are some helper function for the creation of ink controls above
         */

        /**
         * Allows you to click to close ink, edit ink controls (e.g. opacity sliders by clicking on labels).
         * Clicking on a label will collapse all other controls and show the selected control if it was hidden, hide it if it was shown.
         * @param array   the array of controls containing the control we are clicking on
         * @param show    the control we are clicking on -- we toggle it to be shown or hidden
         */
        function updateToggle(array, show) {
            if (array === textArray || array === drawArray || array === transArray || array === textEditArray || array === drawEditArray || array === transEditArray) {
                $.each(array, function () {
                    if (this === show &amp;&amp; $(show).css(&quot;display&quot;) === &quot;block&quot;) {
                        $(&quot;.thicknessLabel&quot;).css({ &#x27;font-weight&#x27;: &#x27;normal&#x27; });
                        this.css(&quot;display&quot;, &quot;none&quot;);
                    }
                    else {
                        if (this === show) { this.css(&quot;display&quot;, &quot;block&quot;); }
                        else { this.css(&quot;display&quot;, &quot;none&quot;); }
                    }
                });
            }
            else {
                $.each(array, function () {
                    if (this === show)
                        this.css(&quot;display&quot;, &quot;block&quot;);
                    else
                        this.css(&quot;display&quot;, &quot;none&quot;);
                });
            }
        }

        /**
         * Collapses all controls in a given panel
         * @param array   this is the array of controls to collapse (e.g. drawArray)
         */
        function hideAll(array) {
            $.each(array, function () {
                    this.css(&quot;display&quot;, &quot;none&quot;);
            });
        }

        /**
         * Initialize the text controls with default values
         */
        function initText() {
            fontLabel.text(&quot;Font: &quot;);
            fontLabel1.text(&quot;Times New Roman&quot;);
            fontLabel.append(fontLabel1);
            textSliderPoint.css(&quot;left&quot;, &quot;10%&quot;);
            timesOption.attr(&quot;selected&quot;, &quot;selected&quot;);
            textSizeLabel.text(&quot;Text Size: &quot;);
            textSizeLabel1.text(&quot;12px&quot;);
            textSizeLabel.append(textSizeLabel1);
            hideAll(textArray);
        }

        /**
         * Initialize the transparency controls with default values
         */
        function initTrans() {
            opacityTransparencyLabel.text(&quot;Opacity: &quot;);
            opacityTransparencyLabel1.text(&quot;80%&quot;);
            opacityTransparencyLabel.append(opacityTransparencyLabel1);
            opacityTransparencySliderPoint.css(&quot;left&quot;, (0.8 * (opacityTransparencySlider.offset().left + opacityTransparencySlider.width()) / 1.28) + &#x27;px&#x27;);
            isolateLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            blockLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            transparencyMode = &#x27;isolate&#x27;;
            transModeLabel1.text(&quot;Isolate&quot;);
            hideAll(transArray);
        }

        /**
         * Initialize the draw controls with default values
         */
        function initDraw() {
            brushLabel.text(&quot;Width: &quot;);
            brushLabel1.text(&quot;7px&quot;);
            brushLabel.append(brushLabel1);
            brushSliderPoint.css(&quot;left&quot;, &quot;0px&quot;);
            drawLabel.css({ &#x27;color&#x27;: &#x27;black&#x27; });
            eraseLabel.css({ &#x27;color&#x27;: &#x27;gray&#x27; });
            drawMode = &#x27;draw&#x27;;
            drawModeLabel1.text(&quot;Draw&quot;);
            //eraserLabel.text(&quot;Eraser: &quot;);
            //eraserLabel1.text(&quot;7px&quot;);
            //eraserLabel.append(eraserLabel1);
            //eraserSliderPoint.css(&quot;left&quot;, &quot;0px&quot;);
            opacityLabel.text(&quot;Opacity: &quot;);
            opacityLabel1.text(&quot;100%&quot;);
            opacityLabel.append(opacityLabel1);
            opacitySliderPoint.css(&quot;left&quot;, (0.87 * opacitySlider.width()) + &quot;px&quot;);
            hideAll(drawArray);
        }

        function closeAllMenus() {
            dropInk.hide();
            dropFile.hide();
            dropMain.hide();
            fade.hide();
            componentDropDown = false;
        }
        /**
         * Create attach and create as unlinked buttons for ink creation
         */
        function getAttachDiv(controls, text, trans) {
            // slightly different controls for text and transparency, since we can&#x27;t call currentInkController.link directly
            var text_mode = false;
            var trans_mode = false;
            if (text &amp;&amp; text !== 0)
                text_mode = true;
            if (trans)
                trans_mode = true;

            // div to contain buttons
            var newDiv = $(document.createElement(&#x27;div&#x27;));
            newDiv.css(&quot;display&quot;, &quot;block&quot;);
            newDiv.css(&#x27;margin-top&#x27;, &#x27;2%&#x27;);

            // attach button
            var linkButton = $(document.createElement(&#x27;button&#x27;));
            linkButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;5%&#x27;, &#x27;clear&#x27;: &#x27;left&#x27; });
            linkButton.get(0).innerHTML = &quot;Attach to Selected&quot;;

            // attach button click handler -- reset to default values, call link, link_text, or link_trans or their unattached equivalents
            linkButton.on(&#x27;click&#x27;, function () {
                brushSliderPoint.attr(&#x27;value&#x27;, 7.0);
                currentInkController.updatePenWidth(&quot;brushSlider&quot;);
                colorLabel1.text(&quot;#000000&quot;);
                myPicker = new jscolor.color(item, {});
                myPicker.fromString(&quot;000000&quot;);
                myPicker.onImmediateChange = function () {
                    currentInkController.updatePenColor(&quot;brushColorToggle&quot;);
                    currentInkController.set_mode(LADS.TourAuthoring.InkMode.draw);
                    $(&#x27;.changeColor1&#x27;)[0].innerHTML = &quot;#&quot; + $(&quot;#brushColorToggle&quot;).attr(&quot;value&quot;);
                };
                var check = true; // if check becomes false, then a warning message appeared, do not proceed after trying to attach
                text_mode = false; // hacky temporary workaround
                if (text_mode)
                    check = currentInkController.link_text();
                else if (trans_mode)
                    check = currentInkController.link_trans();
                else // draw
                    check = currentInkController.link();
                if (!check)
                    return;

                controls.hide();
                // reset undo/redo buttons to global undo/redo functionality
                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);

                playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);


                if (inkAuthoring) {
                    inkAuthoring.getInkUndoManager().clear();
                    undoManager.greyOutBtn();
                }
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
            });
            newDiv.append(linkButton);

            // create as unattached ink button
            var freeInkButton = $(document.createElement(&#x27;button&#x27;));
            freeInkButton.css({ &#x27;color&#x27;: &#x27;black&#x27;, &#x27;width&#x27;: &#x27;35%&#x27;, &#x27;float&#x27;: &#x27;left&#x27;, &#x27;margin-left&#x27;: &#x27;8%&#x27;, &#x27;margin-top&#x27;: &#x27;5%&#x27; });
            freeInkButton.get(0).innerHTML = &quot;Create as Unattached&quot;;

            // unattached button click handler
            freeInkButton.on(&#x27;click&#x27;, function () {
                brushSliderPoint.attr(&#x27;value&#x27;, 7.0);
                currentInkController.updatePenWidth(&quot;brushSlider&quot;);
                var check=true;
                if (text_mode)
                    check=currentInkController.link_text_unattached();
                else if (trans_mode)
                    check=currentInkController.link_trans_unattached();
                else
                    check=currentInkController.linkUnattached();
                if (!check) {
                    return;
                }
                controls.hide();
                // restore global undo/redo functionality
                playbackControls.undoButton.off(&quot;click&quot;);
                playbackControls.redoButton.off(&quot;click&quot;);
                playbackControls.undoButton.on(&#x27;click&#x27;, function () {
                    undoManager.undo();
                });
                playbackControls.redoButton.on(&#x27;click&#x27;, function () {
                    undoManager.redo();
                });
                playbackControls.undoRedoInkOnly.css(&#x27;display&#x27;, &#x27;none&#x27;);

                if (inkAuthoring) {
                    inkAuthoring.getInkUndoManager().clear();
                    undoManager.greyOutBtn();
                }
                timeline.setModifyingInk(false);
                timeline.setEditInkOn(false);
            });
            newDiv.append(freeInkButton);
            return newDiv;
        }

        /**
         * Sets display:none for each of the ink control panels
         */
        function hideInkControls() {
            inkTransparencyControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkTextControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkDrawControls.css({ &#x27;display&#x27;: &#x27;none&#x27; });
            inkEditDraw.css({ &#x27;display&#x27;: &#x27;none&#x27;, });
            inkEditTransparency.css(&#x27;display&#x27;, &#x27;none&#x27;);
            inkEditText.css(&#x27;display&#x27;, &#x27;none&#x27;);
        }
        that.hideInkControls = hideInkControls;

        /**
         * Removes the current ink canvas if there is one
         */
        function removeInkCanv() {
            if ($(&quot;#inkCanv&quot;).length)
                $(&quot;#inkCanv&quot;).remove();

            $(&quot;#rinplayer&quot;).css({
                
            });
        }
        that.removeInkCanv = removeInkCanv;

        /**
         * Creates an ink canvas
         * @return   a div on which we&#x27;ll create a Raphael paper
         */
        function createInkCanv() {
            // remove any existing ink canvases
            removeInkCanv();

            // create a div on which we&#x27;ll create a Raphael paper
            var inkdiv = document.createElement(&quot;div&quot;);
            inkdiv.setAttribute(&quot;id&quot;, &quot;inkCanv&quot;);
            inkdiv.setAttribute(&quot;class&quot;, &quot;inkCanv&quot;);
            //set rinplayer&#x27;s position to absolute so our canvas isn&#x27;t pushed down
            $(&quot;#rinplayer&quot;).css({
                &quot;position&quot;: &quot;absolute&quot;,
            });

            // set css of inkdiv, making sure that its z-index is greater than those of all images and artworks (artwork in track i has z-index 20000+i)
            var num_tracks = timeline.getTrackslength();
            inkdiv.setAttribute(&quot;style&quot;, &quot;overflow:hidden; position:absolute; width:100%; height:100%; background:transparent; pointer-events: all; z-index:&quot; + (20100 + num_tracks) + &quot;;&quot;);
            var view_elt = $(&quot;#rinContainer&quot;); // change to #rinplayer if we can figure out how to keep it around during tour reloads (if in #rinplayer, we can capture inks in thumbnails)
            //view_elt.append(inkdiv);
            $(&quot;#rinplayer&quot;).before(inkdiv);
            return inkdiv;
        }

    })();


    /**
     * Appends the functions panel to the inputted container element
     * @param container   element to which we&#x27;ll append the functions panel
     */
    function addToDOM(container) {
        container.append(functionsPanelDocfrag);
    }
    that.addToDOM = addToDOM;

    /**
     * Adds the catalog overlays (for artwork and associated media import) to the inputted container element
     * Used in TourAuthoringNew
     * @param container   element to which we&#x27;ll append the functions panel
     */
    function addCatalogToDOM(container) {
        container.appendChild(catalogPickerOverlay);
        container.appendChild(associatedMediaPickerOverlay);
    }
    that.addCatalogToDOM = addCatalogToDOM;

    function getIsUploading() {
        return isUploading;
    }
    that.getIsUploading = getIsUploading;

    return that;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
