<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>LADS/js/LADS/layout/LADS.Layout.Artmode.js - Touch Art Gallery web application</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../LADS/images/WideLogo.scale-100.png" title="Touch Art Gallery web application"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Autolinker.html">Autolinker</a></li>
            
                <li><a href="../classes/CryptoJS.html">CryptoJS</a></li>
            
                <li><a href="../classes/LADS.Layout.Artmode.html">LADS.Layout.Artmode</a></li>
            
                <li><a href="../classes/LADS.Layout.InternetFailurePage.js.html">LADS.Layout.InternetFailurePage.js</a></li>
            
                <li><a href="../classes/LADS.Layout.StartPage.html">LADS.Layout.StartPage</a></li>
            
                <li><a href="../classes/TAG_embed.html">TAG_embed</a></li>
            
                <li><a href="../classes/Telemetry.html">Telemetry</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: LADS/js/LADS/layout/LADS.Layout.Artmode.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿LADS.Util.makeNamespace(&quot;LADS.Layout.Artmode&quot;);

//Constructor. Takes in prevInfo object {prevPage: [string (currently &quot;catalog&quot; or &quot;exhibitions&quot;)], prevScroll: [int value of scrollbar
// on NewCatalog page, used for backbutton]}, {previousState, doq, split}, exhibition
//TODO: Adjust this so the back button can go to any arbitrary layout, not just Timeline

/**
 * The artwork viewer, which contains a sidebar with tools
 * and thumbnails as well as a central area for the deepzoom image.
 * @class LADS.Layout.Artmode
 * @constructor
 * @param {Object} prevInfo      contains information about returning to the previous page
 * @param {Object} options       information about current artwork and whether we&#x27;re in splitscreen mode
 * @param {Doq} exhibition       the exhibition we came from (if any)
 */
LADS.Layout.Artmode = function (prevInfo, options, exhibition) {
    &quot;use strict&quot;;

    var prevPage,
        prevScroll,
        prevExhib = exhibition,
        locationList = LADS.Util.UI.getLocationList(options.doq.Metadata),
        initialized = false,
        root, doq, map, splitscreen, locsize, backButton,
        sideBar, toggler, togglerImage, locationHistoryDiv, info, //Need to be instance vars for splitscreen
        zoomimage = null,
        locationHistoryToggle,
        locationHistoryContainer,
        locationHistory,
        direction, //direction for location history panel
        mapMade = false,
        locationHistoryActive = false,//have the location history panel hidden as default.
        drawers = [],
        hotspotsHolderArray = [],
        hotspotsArray = [],
        assets, hotspots,
        loadQueue = LADS.Util.createQueue(),
        switching = false,
        confirmationBox,
        tagContainer = $(&#x27;#tagRoot&#x27;) || $(&#x27;body&#x27;),
        NUM_DRAWERS = 0;

    if (prevInfo) {
        prevPage = prevInfo.prevPage,
        prevScroll = prevInfo.prevScroll || 0;
    }
        
    options = LADS.Util.setToDefaults(options, LADS.Layout.Artmode.default_options);
    doq = options.doq;

    init();

    /**
     * Initiate artmode with a root, artwork image and a sidebar on the left.
     * @method init
     */
    function init() {
        // add elements to the header for displaying bing maps
        var head,
            script,
            meta;

        head = document.getElementsByTagName(&#x27;head&#x27;).item(0);
        script = document.createElement(&quot;script&quot;);
        script.charset = &quot;UTF-8&quot;;
        script.type = &quot;text/javascript&quot;;
        script.src = &quot;http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&quot;;
        head.appendChild(script);

        meta = document.createElement(&#x27;meta&#x27;);
        meta.httpEquiv = &quot;Content-Type&quot;;
        meta.content = &quot;text/html; charset=utf-8&quot;;
        head.appendChild(meta);

        root = LADS.Util.getHtmlAjax(&#x27;Artmode.html&#x27;);
        root.data(&#x27;split&#x27;, options.split);

        //get the artwork
        if (doq) {
            zoomimage = new LADS.AnnotatedImage(root, doq, options.split, function () {
                hotspots = zoomimage.getHotspots();
                assets = zoomimage.getAssets();
                hotspots.sort(function (a, b) { return a.title.toLowerCase() &lt; b.title.toLowerCase() ? -1 : 1; });
                assets.sort(function (a, b) { return a.title.toLowerCase() &lt; b.title.toLowerCase() ? -1 : 1; });
                try { // TODO figure out why loadDoq sometimes causes a NetworkError (still happening?)
                    zoomimage.loadDoq(doq);
                } catch(err) {
                    console.log(err); // TODO if we hit a network error, show an error message
                }
                LADS.Util.Splitscreen.setViewers(root, zoomimage); // TODO should we get rid of all splitscreen stuff?
                makeSidebar();
                createSeadragonControls();
                initialized = true;
            });
            
        }
    }

    /**
     * Add controls for manual Seadragon manipulation
     * This was written for testing purposes and was not carefully written
     * DO NOT KEEP THIS AS IS!!!!!!
     * @method createSeadragonControls
     */
    function createSeadragonControls() {
        var container = $(document.createElement(&#x27;div&#x27;));
        container.attr(&#x27;id&#x27;, &#x27;seadragonManipContainer&#x27;);
        container.css({
            &#x27;left&#x27;: ($(&#x27;#tagRoot&#x27;).width()-120) + &quot;px&quot;
        });
        root.append(container);

        container.append(createButton(&#x27;leftControl&#x27;, &#x27;&lt;&#x27;, 0, 40));
        container.append(createButton(&#x27;upControl&#x27;, &#x27;^&#x27;, 40, 0));
        container.append(createButton(&#x27;rightControl&#x27;, &#x27;&gt;&#x27;, 80, 40));
        container.append(createButton(&#x27;downControl&#x27;, &#x27;v&#x27;, 40, 80));
        container.append(createButton(&#x27;zinControl&#x27;, &#x27;+&#x27;, 80, 0));
        container.append(createButton(&#x27;zoutControl&#x27;, &#x27;-&#x27;, 0, 0));

        function createButton(id, text, left, top) {
            var button = $(document.createElement(&#x27;div&#x27;));
            button.attr(&#x27;id&#x27;, id);
            button.css({
                left: left,
                top: top
            });
            button.addClass(&#x27;seadragonManipButton&#x27;);
            button.text(text);
            return button;
        }

        var delt = 40,
            scrollDelt = 0.1;

        var interval;

        $(&#x27;#leftControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: delt, y: 0}, 1);
            interval = setInterval(function() {
                zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: delt, y: 0}, 1);
            }, 100);
        });
        $(&#x27;#upControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: 0, y: delt}, 1);
            interval = setInterval(function() {
                zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: 0, y: delt}, 1);
            }, 100);
        });
        $(&#x27;#rightControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: -delt, y: 0}, 1);
            interval = setInterval(function() {
                zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: -delt, y: 0}, 1);
            }, 100);
        });
        $(&#x27;#downControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: 0, y: -delt}, 1);
            interval = setInterval(function() {
                zoomimage.dzManip({x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2}, {x: 0, y: -delt}, 1);
            }, 100);
        });
        $(&#x27;#zinControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzScroll(1+scrollDelt, {x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2});
            interval = setInterval(function() {
                zoomimage.dzScroll(1+scrollDelt, {x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2});
            }, 100);
        });
        $(&#x27;#zoutControl&#x27;).on(&#x27;mousedown&#x27;, function() {
            zoomimage.dzScroll(1-scrollDelt, {x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2});
            interval = setInterval(function() {
                zoomimage.dzScroll(1-scrollDelt, {x: $(&#x27;#tagRoot&#x27;).width()/2, y: $(&#x27;#tagRoot&#x27;).height()/2});
            }, 100);
        });
        $(&#x27;.seadragonManipButton&#x27;).on(&#x27;mouseup&#x27;, function() {
            clearInterval(interval);
        });
    }

    /**
     * Makes the artwork viewer sidebar
     * @method makeSidebar
     */
    function makeSidebar() {
        var i;
        var button;
        //sideBar is the outermost container for sidebar
        //Sets entire sidebar to this...
        var sideBarWidth = window.innerWidth * 0.20; //innerWidth Define width in absolute terms to work with split screen
		sideBar = root.find(&#x27;#sideBar&#x27;);

		toggler = root.find(&#x27;#toggler&#x27;);
		togglerImage = root.find(&#x27;#togglerImage&#x27;);

        //Switch side based on splitscreen state, if it is the right half screen, move the sidebar to right.
        if (root.data(&#x27;split&#x27;) === &#x27;R&#x27; &amp;&amp; prevPage !== &quot;artmode&quot;) {//if user doesn&#x27;t go back from the tourplayer too.
            sideBar.css({ right: &#x27;0px&#x27;});
            toggler.css({
                left: &#x27;-12%&#x27;,
                borderTopLeftRadius: &quot;10px&quot;,
                borderBottomLeftRadius: &quot;10px&quot;
            });
            togglerImage.attr(&quot;src&quot;, tagPath+&#x27;images/icons/Open.svg&#x27;);

        }
        else {
            sideBar.css({ left: &#x27;0px&#x27;, });
            toggler.css({
                right: &#x27;-12%&#x27;,
                borderTopRightRadius: &quot;10px&quot;,
                borderBottomRightRadius: &quot;10px&quot;
            });
				togglerImage.attr(&quot;src&quot;, tagPath+&#x27;images/icons/Close.svg&#x27;);
        }
        
        //set sidebar open as default.
        var isBarOpen = true;
        //click toggler to hide/show sidebar
        toggler.click(function () {
            var opts = {};
	    
            //when the bar is open, set the sidebar position according to splitscreen states.
            if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
                opts.right = isBarOpen ? &#x27;-22%&#x27; : &#x27;0%&#x27;;
            } else {
                opts.left = isBarOpen ? &#x27;-22%&#x27; : &#x27;0%&#x27;;
            }
            isBarOpen = !isBarOpen;

            //when click the toggler, the arrow will rotate 180 degree to change direction.
            $(sideBar).animate(opts, 1000, function () {
                togglerImage.attr(&#x27;src&#x27;, tagPath + &#x27;images/icons/&#x27; + (isBarOpen ? &#x27;Close.svg&#x27; : &#x27;Open.svg&#x27;));
            });
        });


        //Create back button TODO: See todo in constructor
		var backBttnContainer = root.find(&quot;#backBttnContainer&quot;);
		backButton = root.find(&#x27;#backButton&#x27;);
        $(backButton).attr(&#x27;src&#x27;,tagPath+&#x27;images/icons/Back.svg&#x27;);

        //change the backColor to show the button is being clicked
        //mouseleave for lifting the finger from the back button
        backButton.on(&#x27;mouseleave mouseup&#x27;, function () {
            LADS.Util.UI.cgBackColor(&quot;backButton&quot;, backButton, true);
        });
        //mousedown for pressing the back button
        backButton.on(&#x27;mousedown&#x27;, function () {
            LADS.Util.UI.cgBackColor(&quot;backButton&quot;, backButton, false);
        });

        //click function for back button based on previous page.
        //this is called when the user entered the artmode from catalog, 
		// have the &quot;artmode&quot; case because if user goes back to artmode from tourplayer, the prevpage will stay as artmode. 
		backButton.on(&#x27;click&#x27;, function () {
			backButton.off(&#x27;click&#x27;); // prevent user from clicking twice
			zoomimage &amp;&amp; zoomimage.unload();
			var backInfo = { backArtwork: doq, backScroll: prevScroll };
			var catalog = new LADS.Layout.NewCatalog(backInfo, exhibition);
			catalog.getRoot().css({ &#x27;overflow-x&#x27;: &#x27;hidden&#x27; }); // TODO this line shouldn&#x27;t be necessary -- do in styl file
			LADS.Util.UI.slidePageRightSplit(root, catalog.getRoot(), function () {
                if(prevExhib &amp;&amp; prevExhib.Identifier) {
    				var selectedExhib = $(&#x27;#exhib-&#x27; + prevExhib.Identifier);
    				selectedExhib.attr(&#x27;flagClicked&#x27;, &#x27;true&#x27;);
    				selectedExhib.css({ &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;color&#x27;: &#x27;black&#x27; });
                    if(selectedExhib[0] &amp;&amp; selectedExhib[0].firstChild) {
    	       			$(selectedExhib[0].firstChild).css({&#x27;color&#x27;: &#x27;black&#x27;});
                    }
                }
			});
		});

        //second outermost div to contain contents in sidebar.
		var sideBarSections = root.find(&#x27;#sideBarSections&#x27;);

        //div for artinfo info and other stuff except for minimapContainer
		var sideBarInfo = root.find(&#x27;#sideBarInfo&#x27;);

        //this contains basic info about the artwork
		info = root.find(&#x27;#info&#x27;);

        //The title of artwork. Currently, we have the text overflow as ellipsis, may implement auto scroll later...
		var infoTitle = root.find(&#x27;#infoTitle&#x27;);
        infoTitle.text(doq.Name);

        //The artist of artwork
		var infoArtist = root.find(&#x27;#infoArtist&#x27;);
        infoArtist.text(doq.Metadata.Artist);
		
        //The year of artwork
		var infoYear = root.find(&#x27;#infoYear&#x27;);
        infoYear.text(doq.Metadata.Year);

        //add more information for the artwork if curator add in the authoring mode
        for (var item in doq.Metadata.InfoFields) {
            var fieldTitle = item;
            var fieldValue = doq.Metadata.InfoFields[item];

                var infoCustom = $(document.createElement(&#x27;div&#x27;));
				infoCustom.addClass(&#x27;infoCustom&#x27;);
                infoCustom.text(fieldTitle + &#x27;: &#x27; + fieldValue);
                infoCustom.appendTo(info);

        }
        //make sure the info text fits in the div
        LADS.Util.fitText(info, 1.1);
        
        /*var splitscreenContainer = initSplitscreen();
        if (LADS.Util.Splitscreen.on()) {
            splitscreenContainer.hide();
        }*/

		var assetContainer = root.find(&#x27;#assetContainer&#x27;);

        //Descriptions, Hotspots, Assets and Tours drawers
        var existsDescription = !!doq.Metadata.Description;
        
        if (existsDescription) {
            NUM_DRAWERS++;
            var descriptionDrawer = createDrawer(&quot;Description&quot;, !existsDescription);
            if (doq.Metadata.Description) {
                var descrip = doq.Metadata.Description.replace(/\n/g, &quot;&lt;br /&gt;&quot;);
                
                if (typeof Windows != &quot;undefined&quot;) {
                    // running in Win8 app
                    descriptionDrawer.contents.html(descrip);
                } else {  
                    // running in browser
                    descriptionDrawer.contents.html(Autolinker.link(descrip, {email: false, twitter: false}));
                }
            }
            var test = doq;
            assetContainer.append(descriptionDrawer);
        }

        //location history
        locationList = LADS.Util.UI.getLocationList(options.doq.Metadata); 
        if (locationList.length !== 0) {
            NUM_DRAWERS++;
            var locationHistorysec = initlocationHistory();
            assetContainer.append(locationHistorysec);
        }

        

        ///////////////////////////////////////
        function downhelper(elt) {
            return function () {
                //elt.css(&#x27;background-color&#x27;, &#x27;rgba(255,255,255,0.75&#x27;);
            };
        }

        function uphelper(elt) {
            return function () {
                elt.css(&#x27;background-color&#x27;, &#x27;&#x27;);
                elt.css(&#x27;color&#x27;, &#x27;rgb(255, 255, 255)&#x27;);
            };
        }

        function createTourHolder(container, tour) { // after release, make this more general, combine with createMediaHolder TODO
            return function () {
                var holder = $(document.createElement(&#x27;div&#x27;));
                holder.addClass(&quot;tourHolder&quot;);
                holder.css({
                    &#x27;height&#x27;: 0.15 * $(&quot;#tagRoot&quot;).height() + &quot;px&quot;
                });

                holder.on(&quot;click&quot;, tourClicked(tour));
                holder.on(&quot;mousedown&quot;, downhelper(holder));
                holder.on(&quot;mouseup&quot;, uphelper(holder));
                container.append(holder);

                var mediaHolderDiv = $(document.createElement(&#x27;div&#x27;));
                mediaHolderDiv.addClass(&#x27;mediaHolderDiv&#x27;);
                holder.append(mediaHolderDiv);

                var holderContainer = $(document.createElement(&#x27;div&#x27;)).addClass(&#x27;holderContainer&#x27;);
                mediaHolderDiv.append(holderContainer);

                var holderInnerContainer = $(document.createElement(&#x27;div&#x27;)).addClass(&#x27;holderInnerContainer&#x27;);
                holderContainer.append(holderInnerContainer);

                var mediaHolderImage = $(document.createElement(&#x27;img&#x27;));
                mediaHolderImage.addClass(&#x27;assetHolderImage&#x27;);
                mediaHolderImage.attr(&#x27;src&#x27;, (tour.Metadata.Thumbnail ? LADS.Worktop.Database.fixPath(tour.Metadata.Thumbnail) : tagPath+&#x27;images/tour_icon.svg&#x27;));
                mediaHolderImage.removeAttr(&#x27;width&#x27;);
                mediaHolderImage.removeAttr(&#x27;height&#x27;);

                mediaHolderImage.css({ // TODO do this the right way... this isn&#x27;t flexible at all, but it will probably do for the release
                    &#x27;max-height&#x27;: 0.15 * 0.7 * $(&quot;#tagRoot&quot;).height() + &quot;px&quot;,
                    &#x27;max-width&#x27;: 0.22 * 0.89 * 0.95 * 0.40 * 0.92 * $(&quot;#tagRoot&quot;).width() + &quot;px&quot; // these are all the % widths propagating down from the tag root
                });

                holderInnerContainer.append(mediaHolderImage);

                var title = $(document.createElement(&#x27;div&#x27;));
				title.addClass(&#x27;mediaHolderTitle&#x27;);
                title.text(LADS.Util.htmlEntityDecode(tour.Name));
                holder.append(title);
            };
        }

        function createMediaHolder(container, media, isHotspot) {
            return function () {
                var holder = $(document.createElement(&#x27;div&#x27;));
                holder.addClass(&quot;assetHolder&quot;);
                holder.css({
                    &#x27;height&#x27;: 0.15 * $(&quot;#tagRoot&quot;).height() + &quot;px&quot;
                });
                holder.attr(&quot;id&quot;, media.assetLinqID);
                holder.data(&quot;assetHidden&quot;, true);
                holder.data(&quot;ishotspot&quot;, isHotspot);

                holder.data(&#x27;info&#x27;, media);

                holder.on(&quot;click&quot;, hotspotAssetClick(media, holder));
                holder.on(&quot;mousedown&quot;, downhelper(holder));
                holder.on(&quot;mouseup&quot;, uphelper(holder));
                container.append(holder);
                hotspotsHolderArray.push(holder);
                hotspotsArray.push(media);

                var mediaHolderDiv = $(document.createElement(&#x27;div&#x27;));
                mediaHolderDiv.addClass(&#x27;mediaHolderDiv&#x27;);
                holder.append(mediaHolderDiv);

                var holderContainer = $(document.createElement(&#x27;div&#x27;)).addClass(&#x27;holderContainer&#x27;);
                mediaHolderDiv.append(holderContainer);

                var holderInnerContainer = $(document.createElement(&#x27;div&#x27;)).addClass(&#x27;holderInnerContainer&#x27;);
                holderContainer.append(holderInnerContainer);

                var mediaHolderImage = $(document.createElement(&#x27;img&#x27;));
                mediaHolderImage.addClass(&#x27;assetHolderImage&#x27;);
                switch (media.contentType) {
                    case &#x27;Audio&#x27;:
                        mediaHolderImage.attr(&#x27;src&#x27;, tagPath+&#x27;images/audio_icon.svg&#x27;);
                        break;
                    case &#x27;Video&#x27;:
                        mediaHolderImage.attr(&#x27;src&#x27;, (media.thumbnail &amp;&amp; !media.thumbnail.match(/.mp4/)) ? LADS.Worktop.Database.fixPath(media.thumbnail) : &#x27;images/video_icon.svg&#x27;);
                        break;
                    case &#x27;Image&#x27;:
                        mediaHolderImage.attr(&#x27;src&#x27;, media.thumbnail ?  LADS.Worktop.Database.fixPath(media.thumbnail) :LADS.Worktop.Database.fixPath(media.source));
                        break;
                    default:
                        mediaHolderImage.attr(&#x27;src&#x27;, tagPath+&#x27;images/text_icon.svg&#x27;);
                        break;
                }

                mediaHolderImage.removeAttr(&#x27;width&#x27;);
                mediaHolderImage.removeAttr(&#x27;height&#x27;);

                mediaHolderImage.css({
                    &#x27;max-height&#x27;: 0.15 * 0.7 * $(&quot;#tagRoot&quot;).height() + &quot;px&quot;,
                    &#x27;max-width&#x27;: 0.22 * 0.89 * 0.95 * 0.40 * 0.92 * $(&quot;#tagRoot&quot;).width() + &quot;px&quot;
                });

                holderInnerContainer.append(mediaHolderImage);

                var title = $(document.createElement(&#x27;div&#x27;));
				title.addClass(&#x27;mediaHolderTitle&#x27;);
                title.text(LADS.Util.htmlEntityDecode(media.title));
                holder.append(title);
            };
        }
        ///////////////////////////////////////
        
        //get the hotspots for the artwork
        if (hotspots.length != 0) {
            NUM_DRAWERS++;
            var hotspotsDrawer = createDrawer(&#x27;Hotspots&#x27;, (hotspots.length === 0));
            for (var k = 0; k &lt; hotspots.length; k++) {
                loadQueue.add(createMediaHolder(hotspotsDrawer.contents, hotspots[k], true));
            }
            assetContainer.append(hotspotsDrawer);
        }

        if (assets.length != 0) {
            NUM_DRAWERS++;
            var assetsDrawer = createDrawer(&#x27;Assets&#x27;, (assets.length===0));
            for (var j = 0; j&lt; assets.length; j++) {
                loadQueue.add(createMediaHolder(assetsDrawer.contents, assets[j], false));
            }
            assetContainer.append(assetsDrawer);
        }

        function hotspotAssetClick(hotspotsAsset, btn) {//check if the location history is open before you click the button, if so, close it
            return function () {
                hotspotsAsset.mediaload();
                if (locationHistoryActive) {
                    locationHistoryActive = false;
                    locationHistory.css({
                        &#x27;color&#x27;: locationList.length ? &#x27;white&#x27; : &quot;rgb(136, 136, 136)&quot;,
                        &quot;font-size&quot;: &quot;25px&quot;,
                    });
                    locationHistoryToggle.hide();
                    locationHistoryToggle.hide(&quot;slide&quot;, { direction: direction }, 500);
                    locationHistoryDiv.hide(&quot;slide&quot;, { direction: direction }, 500);
                    setTimeout(function(){toggler.show()}, 500);//show the toggler for sidebar and hide the locationhistory toggler.
                }
                var circle = hotspotsAsset.toggle();

                if (btn.data(&quot;ishotspot&quot;)) {//btn change for hotspots
                    if (btn.data(&quot;assetHidden&quot;) &amp;&amp; $(circle).css(&#x27;display&#x27;) === &#x27;block&#x27;) {
                        btn.css({
                            &#x27;color&#x27;: &#x27;black&#x27;,
                            &#x27;background-color&#x27;: &#x27;rgba(255,255,255, 0.3)&#x27;,
                        });
                        btn.data(&quot;assetHidden&quot;, false);
                    }
                    else {
                        btn.css({
                            &#x27;color&#x27;: &#x27;white&#x27;,
                            &#x27;background-color&#x27;: &#x27;&#x27;
                        });

                        btn.data(&quot;assetHidden&quot;, true);
                    }
                } else {//btn change for assets
                    if (btn.data(&quot;assetHidden&quot;)) {
                        btn.css({
                            &#x27;color&#x27;: &#x27;black&#x27;,
                            &#x27;background-color&#x27;: &#x27;rgba(255,255,255, 0.3)&#x27;,
                        });
                        btn.data(&quot;assetHidden&quot;, false);
                    } else {
                        btn.css({
                            &#x27;color&#x27;: &#x27;white&#x27;,
                            &#x27;background-color&#x27;: &#x27;&#x27;
                        });

                        btn.data(&quot;assetHidden&quot;, true);
                    }
                }
                hotspotsAsset.pauseAsset();
                if (circle) {
                    setTimeout(function () { circle.click(); }, 500); // has to be a better way.....
                }
            };
        }

        var toursDrawer;
        // Load tours and filter for tours associated with this artwork
        LADS.Worktop.Database.getTours(function (tours) {
            var relatedTours = tours.filter(function (tour) {
                if (!tour.Metadata || !tour.Metadata.RelatedArtworks || tour.Metadata.Private === &quot;true&quot;)
                    return false;
                var relatedArtworks = JSON.parse(tour.Metadata.RelatedArtworks);
                return relatedArtworks instanceof Array &amp;&amp; relatedArtworks.indexOf(doq.Identifier) &gt; -1;
            });

            if (relatedTours.length != 0) {
                NUM_DRAWERS++;
                toursDrawer = createDrawer(&#x27;Tours&#x27;, relatedTours.length === 0);
                assetContainer.append(toursDrawer);
                if (relatedTours.length &gt; 0) {
                    toursDrawer.contents.text(&#x27;&#x27;);
                    $.each(relatedTours, function (index, tour) {
                        loadQueue.add(createTourHolder(toursDrawer.contents, tour));
                    });
                }
            }

            var maxHeight= $(&quot;#assetContainer&quot;).height() - $(&#x27;.drawerHeader&#x27;).height() * NUM_DRAWERS - 10;
            if (maxHeight&lt;=0)
                maxHeight=1;
            root.find(&quot;.drawerContents&quot;).css({
                &quot;max-height&quot;: maxHeight +&quot;px&quot;,
            });
        });

        

        function tourClicked(tour) {
            return function () {
                if (LADS.Util.Splitscreen.on()) {
                    confirmationBox = LADS.Util.UI.PopUpConfirmation(function () {
                        if (!switching) {
                            switching = true;
                            zoomimage.unload();
                            /* nbowditch _editted 2/13/2014 : added prevInfo */
                            prevInfo = { artworkPrev: &quot;artmode&quot;, prevScroll: prevScroll };
                            var rinData = JSON.parse(unescape(tour.Metadata.Content)),
                            rinPlayer = new LADS.Layout.TourPlayer(rinData, exhibition, prevInfo, options);
                            /* end nbowditch edit */
                            //check if the screen split is on, exit the other one if splitscreen is on to play the tour on full screen.
                            if (LADS.Util.Splitscreen.on()) {
                                var parentid = $(root).parent().attr(&#x27;id&#x27;);
                                LADS.Util.Splitscreen.exit(parentid[parentid.length - 1]);
                            }
                            LADS.Util.UI.slidePageLeftSplit(root, rinPlayer.getRoot(), rinPlayer.startPlayback);
                        }
                    },
                    &quot;By opening this tour, you will exit split screen mode. Would you like to continue?&quot;,
                    &quot;Continue&quot;,
                    false,
                    function () {
                        $(confirmationBox).remove();
                    },
                    root);
                    $(confirmationBox).css(&#x27;z-index&#x27;, 10001);
                    root.append($(confirmationBox));
                    $(confirmationBox).show();
                } else {
                    if (!switching) {
                        switching = true;
                        zoomimage.unload();
                        /* nbowditch _editted 2/13/2014 */
                        prevInfo = { artworkPrev: &quot;artmode&quot;, prevScroll: prevScroll };
                        var rinData = JSON.parse(unescape(tour.Metadata.Content)),
                        rinPlayer = new LADS.Layout.TourPlayer(rinData, exhibition, prevInfo, options);
                        /* end nbowditch edit */
                        //check if the screen split is on, exit the other one if splitscreen is on to play the tour on full screen.
                        if (LADS.Util.Splitscreen.on()) {
                            var parentid = $(root).parent().attr(&#x27;id&#x27;);
                            LADS.Util.Splitscreen.exit(parentid[parentid.length - 1]);
                        }
                        LADS.Util.UI.slidePageLeftSplit(root, rinPlayer.getRoot(), rinPlayer.startPlayback);
                    }
                }
            };
        }
        

        

        //Send Feedback (bleveque: commented it out for Curtis, need to put it back in)
        var feedbackContainer = $(&#x27;notmatchinganything&#x27;); // TODO initFeedback();

        //Create minimapContainer...
		var minimapContainer = root.find(&#x27;#minimapContainer&#x27;);
        // minimapContainer.on(&#x27;scroll&#x27;, function(evt){
        //     evt.preventDefault();
        // });

        sideBarSections.append(minimapContainer);

        feedbackContainer.css(&quot;top&quot;, (minimapContainer.position().top - 0.05 * $(document).height()) + &quot;px&quot;);//set feedback location


        //A white rectangle for minimap to show the current shown area for artwork
		var minimaprect = root.find(&#x27;#minimaprect&#x27;);

        //Load deepzoom thumbnail. 
        var img = new Image();
        var loaded = false;
        var AR = 1;//ratio between width and height.
        var minimapw = 1;//minimap width
        var minimaph = 1;//minimap height
        var minimap;
        /*
        **On load, load the image of artwork and initialize the rectangle
        */
        function minimapLoaded() {
            if (loaded) return;
            loaded = true;
            //load the artwork image
			minimap = root.find(&#x27;#minimap&#x27;);
            minimap.attr(&#x27;src&#x27;, LADS.Worktop.Database.fixPath(doq.URL));

            //make the minimap not moveable. 
            minimap.mousedown(function () {
                return false;
            });
            AR = img.naturalWidth / img.naturalHeight;
            var heightR = img.naturalHeight / $(minimapContainer).height();//the ratio between the height of image and the container.
            var widthR = img.naturalWidth / $(minimapContainer).width();//ratio between the width of image and the container.
            //make sure the whole image shown inside the container based on the longer one of height and width.
            if (heightR &gt; widthR) {
                minimap.removeAttr(&quot;height&quot;);
                minimap.removeAttr(&quot;width&quot;);
                minimap.css({ &quot;height&quot;: &quot;100%&quot; });
            }
            else {
                minimap.removeAttr(&quot;height&quot;);
                minimap.removeAttr(&quot;width&quot;);
                minimap.css({ &quot;width&quot;: &quot;100%&quot; });
            }

            //make the image manipulatable. 
            var gr = LADS.Util.makeManipulatable(minimap[0],
            {
                onManipulate: onMinimapManip,
                onScroll: onMinimapScroll,
                onTapped: onMinimapTapped
            }, false);

            /**********************/
            var minimaph = minimap.height();
            var minimapw = minimap.width();

            //centers rectangle
            var minimapt = (minimapContainer.height() / 2) - (minimap.height() / 2);
            var minimapl = (minimapContainer.width() / 2) - (minimap.width() / 2);
            minimaprect.css({
                width: (minimapw - 1) + &quot;px&quot;,
                height: (minimaph - 1) + &quot;px&quot;,
                top: minimapt + &quot;px&quot;,
                left: (minimapl - 1) + &quot;px&quot;
            });
            /*********************/
        }
        /*
        **implement specific manipulation functions for manipulating the minimap.
        */
        function onMinimapManip(evt) {
            var minimaph = minimap.height();
            var minimapw = minimap.width();
            var minimapt = minimap.position().top;
            var minimapl = parseFloat(minimap.css(&#x27;marginLeft&#x27;));

            var px = evt.pivot.x;
            var py = evt.pivot.y;
            var tx = evt.translation.x;
            var ty = evt.translation.y;

            var x = px + tx;
            var y = py + ty;
            x = (x - minimapl) / minimapw;
            y = (y - minimapt) / minimaph;
            y = y / AR;
            x = Math.max(0, Math.min(x, 1));
            y = Math.max(0, Math.min(y, 1 / AR));
            var s = 1 + (1 - evt.scale);
            if (s) zoomimage.viewer.viewport.zoomBy(s, false);
            zoomimage.viewer.viewport.panTo(new Seadragon.Point(x, y), true);
            zoomimage.viewer.viewport.applyConstraints();
        }
        function onMinimapScroll(res, pivot) {
            var a = 0;
        }
        function onMinimapTapped(evt) {
            var a = 0;
        }

        img.onload = minimapLoaded;
        //should be complete image of artwork NOT thumbnail
        img.src = LADS.Worktop.Database.fixPath(doq.URL);
        if (img.complete) {
            minimapLoaded();
        }
        /*
        **Handler for image-&gt;rectangle TODO: rectangle-&gt;image handler
        */
        function dzMoveHandler(evt) {
            var minimaph = minimap.height();
            var minimapw = minimap.width();

            //centers rectangle
            var minimapt = (minimapContainer.height() / 2) - (minimap.height() / 2);
            var minimapl = (minimapContainer.width() / 2) - (minimap.width() / 2);

            var viewport = evt.viewport;
            var rect = viewport.getBounds(true);
            var tl = rect.getTopLeft();
            var br = rect.getBottomRight();
            var x = tl.x;
            var y = tl.y;
            var xp = br.x;
            var yp = br.y;
            if (x &lt; 0) x = 0;
            if (y &lt; 0) y = 0;
            if (xp &gt; 1) xp = 1;
            if (yp &gt; 1 / AR) yp = 1 / AR;
            y = y * AR;
            yp = yp * AR;
            yp = yp - y;
            xp = xp - x;
            x = minimapl + x * minimapw;
            y = minimapt + y * minimaph;
            xp = xp * minimapw;
            yp = yp * minimaph;
            minimaprect.css({
                width: (xp-1) + &quot;px&quot;,
                height: (yp - 1) + &quot;px&quot;,
                top: y + &quot;px&quot;,
                left: (x-1) + &quot;px&quot;
            });
        }
        zoomimage.addAnimateHandler(dzMoveHandler);

    }

    /**
     * Create a drawer with a disclosure button used to display
     * hotspots, assets, tours. The returned jQuery object has
     * a property called &quot;contents&quot; which should be used to add
     * buttons or messages to the contents of the drawer.
     *
     * @param title, the display title for the drawer
     * @author jastern
     */
    function initlocationHistory() {
        //create container div for locationhistory
		locationHistoryContainer = root.find(&#x27;#locationHistoryContainer&#x27;);
		
        //have the container clickable. check histOnClick for more details.
        locationHistoryContainer.click(histOnClick);
        //create the icon for location history
        //create the div for text
		locationHistory = root.find(&#x27;#locationHistory&#x27;);

        locationHistory.text(&#x27;Location History&#x27;);
        locationHistory.css({
            &#x27;color&#x27;: locationList.length ? &#x27;white&#x27; : &#x27;rgb(136,136,136)&#x27;
        });

        //panel that slides out when location history is clicked
		locationHistoryDiv = root.find(&#x27;#locationHistoryDiv&#x27;);
        var offsetSide = window.innerWidth * 0.22,
		locwidth = (!LADS.Util.Splitscreen.on()) ?//if the splitscreen is not on, set the width as 78% of current window width.
					window.innerWidth * 0.78 ://else set the width based on the side of screen. 
					((root.data(&#x27;split&#x27;) === &#x27;L&#x27;) ?
						$(&#x27;#metascreen-L&#x27;).width() - window.innerWidth * 0.22 :
						$(&#x27;#metascreen-R&#x27;).width() - window.innerWidth * 0.22);

        //create the panel for location history.
		var locationHistoryPanel = root.find(&#x27;#locationHistoryPanel&#x27;);

        //set the position of outtermost div and panel for locationhistory based on the which splitscreen
        if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
            var locpaneloffset = locwidth * 0.125;
            locationHistoryPanel.css({
                position: &#x27;relative&#x27;,
                left: locpaneloffset + &#x27;px&#x27;
            });
        } else {
            //locationHistoryDiv.css({ left: offsetSide });
        }

        var mapOverlay = $(LADS.Util.UI.blockInteractionOverlay());//overlay for when &#x27;edit ink&#x27; component option is selected while playhead is not over the art track
        $(mapOverlay).addClass(&#x27;mapOverlay&#x27;);
        var overlayLabel = $(&#x27;&lt;label&gt;&#x27;).text(&quot;Map has no location history to display.&quot;);
        overlayLabel.attr(&quot;id&quot;, &quot;mapOverlayLabel&quot;);
        mapOverlay.append(overlayLabel);

        var lpContents = $(document.createElement(&#x27;div&#x27;));
        lpContents.addClass(&#x27;lpContents&#x27;);

        lpContents.append(mapOverlay);
        //
        locationHistoryPanel.append(lpContents);

        //create a div for title
        var lpTitle = $(document.createElement(&#x27;div&#x27;));
        lpTitle.attr(&quot;id&quot;, &quot;lpTitle&quot;);
        lpTitle.text(&#x27;Location History&#x27;);

        lpContents.append(lpTitle);
        //create a div for map
        var lpMapDiv = $(document.createElement(&#x27;div&#x27;));
        
        //set the id of map div according to the splitscreen position.
        if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
            lpMapDiv.attr(&#x27;id&#x27;, &#x27;lpMapDivR&#x27;);
        } else {
            lpMapDiv.attr(&#x27;id&#x27;, &#x27;lpMapDiv&#x27;);
        }
        lpMapDiv.addClass(&#x27;lpMapDiv&#x27;);

        lpContents.append(lpMapDiv);
        //this div contains all text information about the artwork&#x27;s location history.
        var lpTextInfoDiv = $(document.createElement(&#x27;div&#x27;));
        lpTextInfoDiv.addClass(&#x27;lpTextInfoDiv&#x27;);

        lpContents.append(lpTextInfoDiv);
        //this div contains a list of locations for the artwork.
        var lpTextDiv = $(document.createElement(&#x27;div&#x27;));
        lpTextDiv.addClass(&quot;lpTextDiv&quot;);

        lpTextInfoDiv.append(lpTextDiv);
        //this div gives details about one specific location history when one location is clicked.
        var lpInfoDiv = $(document.createElement(&#x27;div&#x27;));
        lpInfoDiv.addClass(&#x27;lpInfoDiv&#x27;);

        lpTextInfoDiv.append(lpInfoDiv);

        //create the toggler to close the location history. Same arrow as sidebar toggler. 
        locationHistoryToggle = root.find(&#x27;#locationHistoryToggle&#x27;);

        var locationHistoryToggleIcon = root.find(&#x27;#locationHistoryToggleIcon&#x27;);

        //set the toggler based on the splitscreen.
        if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
            locationHistoryToggle.css({
                right: &#x27;87.5%&#x27;,
                &#x27;border-bottom-left-radius&#x27;: &#x27;10px&#x27;,
                &#x27;border-top-left-radius&#x27;: &#x27;10px&#x27;
            });
            locationHistoryToggleIcon.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/Open.svg&#x27;);
        } else {
            locationHistoryToggle.css({
                left: &#x27;87.5%&#x27;,
                &#x27;border-bottom-right-radius&#x27;: &#x27;10px&#x27;,
                &#x27;border-top-right-radius&#x27;: &#x27;10px&#x27;
            });
            locationHistoryToggleIcon.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/Close.svg&#x27;);
        }

        locationHistoryToggle.click(toggleLocationPanel);

        /**
         * This is the click function LocationHistoryContainer. 
         */
        function histOnClick() {
            console.log(&quot;clicking on location history&quot;);

            locationList = LADS.Util.UI.getLocationList(options.doq.Metadata); //Location List is LOADED HERE

            if (locationList.length === 0) {
                mapOverlay.show();
            }
            if (!mapMade || !map) {
                console.log(&quot;in if&quot;);
                var prepMap = function () {
                    console.log(&quot;in prepMap&quot;);
                    //make location pushpins show up on map
                    locationList = LADS.Util.UI.getLocationList(options.doq.Metadata); //Location List is LOADED HERE
                    LADS.Util.UI.drawPushpins(locationList, map);


                    //traverse locationList and populate the location list
                    //lptext.information contains further information to be displayed when clicked
                    function drawPinHelper(e) {
                        LADS.Util.UI.drawPushpins(locationList, map);

                        //display location information
                        if (e.data.info !== undefined)
                            lpInfoDiv.html($(this).html() + &quot;&lt;br/&gt;&quot; + e.data.info);
                        else
                            lpInfoDiv.html($(this).html() + &quot;&lt;br/&gt;&quot;);

                        $(&#x27;div.locations&#x27;).css(unselectedCSS);
                        $(&#x27;img.removeButton&#x27;).attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/minus.svg&#x27;);
                        $(&#x27;img.editButton&#x27;).attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/edit.png&#x27;);
                        $(this).find(&#x27;img.removeButton&#x27;).attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/minusB.svg&#x27;);
                        $(this).find(&#x27;img.editButton&#x27;).attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/editB.png&#x27;);
                        $(this).css(selectedCSS);
                        var lat, long, location;
                        if (e.data.resource.latitude) {
                            location = e.data.resource;
                        } else {
                            lat = e.data.resource.point.coordinates[0];
                            long = e.data.resource.point.coordinates[1];
                            location = new Microsoft.Maps.Location(lat, long);
                        }
                        var viewOptions = {
                            center: location,
                            zoom: 4,
                        };
                        map.setView(viewOptions);
                    }

                    for (var i = 0; i &lt; locationList.length; i++) {

                        var unselectedCSS = {
                            &#x27;background-color&#x27;: &#x27;transparent&#x27;,
                            &#x27;color&#x27;: &#x27;white&#x27;
                        };
                        var selectedCSS = {
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;,
                        };
                        var pushpinOptions = {
                            text: String(i + 1),
                            icon: tagPath+&#x27;images/icons/locationPin.png&#x27;,
                            width: 20,
                            height: 30
                        };
                        var address = locationList[i].address;
                        var date = &#x27;&#x27;;
                        if (locationList[i].date &amp;&amp; locationList[i].date.year) {
                            var year = locationList[i].date.year;
                            if (year &lt; 0) {
                                //add BC to years that are less than 0
                                year = Math.abs(year) + &#x27; BC&#x27;;
                            }
                            date = &quot; - &quot; + year;
                        } else {
                            date = &#x27; - &lt;i&gt;Date Unspecified&lt;/i&gt;&#x27;;
                        }
                        //create a div for each location.
                        var newDiv = $(document.createElement(&#x27;div&#x27;));
                        newDiv.addClass(&#x27;locations&#x27;);
                        newDiv.html((i + 1) + &#x27;. &#x27; + address + date + &#x27;&lt;br&gt;&#x27;);

                        lpTextDiv.append(newDiv);

                        LADS.Util.UI.drawPushpins(locationList, map);

                        //display more information about the location when newdiv is clicked
                        newDiv.click(locationList[i], drawPinHelper);
                        newDiv.fadeIn();
                    }

                    console.log(&quot;here 1&quot;);
                    toggleLocationPanel();
                };

                console.log(&quot;here 2&quot;);
                makeMap(prepMap);
            } else {
                console.log(&quot;in else&quot;);
                toggleLocationPanel();
            }
        }
        /*
        **toggles location panel when LocationHistoryContainer or toggler is clicked.
        **@return: locationHistoryContainer
        */
        function toggleLocationPanel() {
            console.log(&quot;toggle location panel&quot;);
            if (locationList.length === 0) return;
            if (LADS.Util.Splitscreen.on()) {
                return;
            }
            //set the direction based on the splitscreen position
            if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
                direction = &#x27;right&#x27;;
            } else {
                direction = &#x27;left&#x27;;
            }
            //if the panel is currently shown, hide it.
            if (locationHistoryActive) {
                locationHistory.text(&#x27;Location History&#x27;);
                locationHistory.css({ &#x27;color&#x27;: &#x27;white&#x27; });
                locationHistoryToggle.hide();
                locationHistoryToggle.hide(&quot;slide&quot;, { direction: direction }, 500);
                locationHistoryDiv.hide(&quot;slide&quot;, { direction: direction }, 500);
                setTimeout(function(){toggler.show()}, 500);//show the toggler for sidebar and hide the locationhistory toggler.
                locationHistoryActive = false;
            }
            else {//show the panel if it is hidden when clicked
                locationHistory.text(&#x27;Location History&#x27;);
                locationHistoryToggle.hide();
                locationHistoryDiv.show(&quot;slide&quot;, { direction: direction }, 500, function () {
                    locationHistoryToggle.show();
                });
                locationHistoryDiv.css({ display: &#x27;inline&#x27; });
                toggler.hide();
                locationHistoryActive = true;
            }
        }

        locationHistoryContainer.append(locationHistory);

        if (LADS.Util.Splitscreen.on()) {
            locationHistory.css(&#x27;opacity&#x27;, &#x27;0.5&#x27;);
        }

        return locationHistoryContainer;
    }

    /*
    **this function create drawer for hotspots, assets and tour. 
    **@para: title of the drawer
    */
    function createDrawer(title, grayOut) {
        //here goes the basic UI elements for drawer: Outtermost div, header, iconContainer, icon and etc
        var drawer = $(document.createElement(&#x27;div&#x27;));

        drawer.addClass(&#x27;drawer&#x27;);

        var drawerHeader = $(document.createElement(&#x27;div&#x27;));
        drawerHeader.addClass(&#x27;drawerHeader&#x27;);
        drawerHeader.appendTo(drawer);

        var label = $(document.createElement(&#x27;div&#x27;));
        label.addClass(&#x27;label&#x27;);
        label.text(title);
        label.css({
            &#x27;color&#x27;: grayOut ? &#x27;#888888&#x27; : &#x27;white&#x27;
        });
        label.appendTo(drawerHeader);

        if (!grayOut) {
            var toggleContainer = $(document.createElement(&#x27;div&#x27;));
            toggleContainer.addClass(&#x27;toggleContainer&#x27;);
            toggleContainer.appendTo(drawerHeader);

            var toggle = $(document.createElement(&#x27;img&#x27;));
            toggle.addClass(&quot;plusToggle&quot;);
            toggle.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/plus.svg&#x27;);

            toggle.appendTo(toggleContainer);
            drawer.isslided = false;
            var drawerContents = $(document.createElement(&#x27;div&#x27;));
            drawerContents.addClass(&quot;drawerContents&quot;);
            // var maxHeight= $(&quot;#assetContainer&quot;).height() - $(&#x27;.drawerHeader&#x27;).height() * NUM_DRAWERS - 15; // 165;
            // if (maxHeight&lt;=0)
            //     maxHeight=1;
            // drawerContents.css({
            //     &quot;max-height&quot;: maxHeight +&quot;px&quot;,
            // });
            drawerContents.appendTo(drawer);

            //have the toggler icon minus when is is expanded, plus otherwise.
            drawerHeader.on(&#x27;click&#x27;, function (evt) {
                if (drawer.isslided === false) {
                    root.find(&quot;.plusToggle&quot;).attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/plus.svg&#x27;);//ensure only one shows.
                    root.find(&quot;.drawerContents&quot;).slideUp();

                    $.each(drawers, function () {
                        this.isslided = false;
                    });
                    toggle.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/minus.svg&#x27;);
                    drawer.isslided = true;
                }
                else {
                    toggle.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/plus.svg&#x27;);
                    $.each(hotspotsHolderArray, function () {
                        if (!this.data(&quot;assetHidden&quot;)) {
                            this.css({
                                &#x27;color&#x27;: &#x27;white&#x27;,
                                &#x27;background-color&#x27;: &#x27;&#x27;
                            });

                            this.data(&quot;assetHidden&quot;, true);
                        }
                    });
                    $.each(hotspotsArray, function () {
                        this.hide();
                    });
                    drawer.isslided = false;
                }
                drawerContents.slideToggle();
            });

            drawer.contents = drawerContents;
        }
        drawers.push(drawer);

        return drawer;
    }

    function splitscreenAdjustments() {
        splitscreen.text(&#x27;Exit Split Screen&#x27;);
    }

    // exhibition picker
    function createExhibitionPicker(artworkObj) {
        // debugger; // this shouldn&#x27;t be called in the web app...
        var exhibitionPicker = $(document.createElement(&#x27;div&#x27;));
        exhibitionPicker.addClass(&quot;exhibitionPicker&quot;);

        var infoLabel = $(document.createElement(&#x27;div&#x27;));
        infoLabel.addClass(&quot;infoLabel&quot;);

        infoLabel.text(&#x27;Choose an exhibition in which to view the artwork.&#x27;);
        exhibitionPicker.append(infoLabel);

        var exhibitionsList = $(document.createElement(&#x27;div&#x27;));
        exhibitionsList.addClass(&quot;exhibitionsList&quot;);

        exhibitionPicker.append(exhibitionsList);

        var cancelButton = $(document.createElement(&#x27;button&#x27;));
        cancelButton.attr(&#x27;type&#x27;, &#x27;button&#x27;);
        cancelButton.addClass(&quot;cancelButton&quot;);

        cancelButton.text(&#x27;Cancel&#x27;);

        cancelButton.click(function () {
            exhibitionPicker.detach();
        });
        exhibitionPicker.append(cancelButton);

        root.append(exhibitionPicker);

        exhibitionSelect(artworkObj);

        function exhibitionSelect(artwork) {
            var i;
            var xml = LADS.Worktop.Database.getDoqXML(artwork.Identifier);
            var parser = new DOMParser();
            var artworkXML = parser.parseFromString(xml, &#x27;text/xml&#x27;);
            var selected;
            var currentExhibitions = [];
            var exhibitionLabelArray = [];

            for (i = 0; i &lt; artworkXML.getElementsByTagName(&#x27;FolderId&#x27;).length; i++) {
                var exhib_id = artworkXML.getElementsByTagName(&#x27;FolderId&#x27;)[i].textContent;
                currentExhibitions.push(exhib_id);
            }

            for (i = 0; i &lt; currentExhibitions.length; i++) {
                var exhibitionLabelWrapper = document.createElement(&#x27;div&#x27;);
                var exhibitionLabel = $(document.createElement(&#x27;div&#x27;));
                exhibitionLabel.addClass(&quot;.exhibitionLabel&quot;);
                exhibitionLabel.css({
                    width: &#x27;80%&#x27;,
                    color: &#x27;white&#x27;,
                    &#x27;font-size&#x27;: &#x27;180%&#x27;,
                });
                exhibitionLabel.text(currentExhibitions[i].Name);
                var exhibitionObject = currentExhibitions[i];
                $(exhibitionLabelWrapper).append(exhibitionLabel);
                exhibitionLabelArray.push(exhibitionLabelWrapper);
            }

            $.each(currentExhibitions, function (i, exhibition) {
                var toAdd = LADS.Worktop.Database.getDoq(exhibition);
                if (toAdd.Metadata.Private === &quot;true&quot; || toAdd.Metadata.Type !== &quot;Exhibit&quot; || toAdd.Metadata.Deleted) { return; }
                else {
                    var name = toAdd.Name;
                    var preview = LADS.Worktop.Database.fixPath(toAdd.Metadata.BackgroundImage);
                    var listCell = $(document.createElement(&#x27;div&#x27;));
                    listCell.addClass(&quot;exhibitions-list-cell&quot;);

                    listCell.on(&#x27;mousedown&#x27;, function () {
                        listCell.css({
                            &#x27;background-color&#x27;: &#x27;white&#x27;,
                            &#x27;color&#x27;: &#x27;black&#x27;,
                        });
                        listCell.on(&#x27;mouseleave&#x27;, function () {
                            listCell.css({
                                &#x27;background-color&#x27;: &#x27;black&#x27;,
                                &#x27;color&#x27;: &#x27;white&#x27;,
                            });
                        });
                    });
                    listCell.on(&#x27;mouseup&#x27;, function () {
                        listCell.css({
                            &#x27;background-color&#x27;: &#x27;black&#x27;,
                            &#x27;color&#x27;: &#x27;white&#x27;,
                        });
                        listCell.off(&#x27;mouseleave&#x27;);
                    });
                    

                    var textBox = $(document.createElement(&#x27;div&#x27;));
                    textBox.addClass(&quot;textbox&quot;);

                    textBox.text(name);

                    // Create an img element to load the image
                    var img = $(document.createElement(&#x27;img&#x27;));
                    img.addClass(&quot;imgLoader&quot;);
                    img.attr(&#x27;src&#x27;, preview);

                    listCell.append(img);
                    listCell.append(textBox);

                    // Create a progress circle
                    var progressCircCSS = {
                        &#x27;position&#x27;: &#x27;absolute&#x27;,
                        &#x27;left&#x27;: &#x27;40%&#x27;,
                        &#x27;top&#x27;: &#x27;40%&#x27;,
                        &#x27;z-index&#x27;: &#x27;50&#x27;,
                        &#x27;height&#x27;: &#x27;auto&#x27;,
                        &#x27;width&#x27;: &#x27;20%&#x27;
                    };

                    var circle = LADS.Util.showProgressCircle(img, progressCircCSS, &#x27;0px&#x27;, &#x27;0px&#x27;, true);

                    img.load(function () {
                        LADS.Util.removeProgressCircle(circle);
                    });

                    exhibitionsList.append(listCell);
                    listCell.click(function () {

                        /* nbowditch _editted 2/14/2013 : added backInfo */
                        var backInfo = { backArtwork: null, backScroll: prevScroll };
                        var newSplit = new LADS.Layout.NewCatalog(backInfo, toAdd);
                        /* end nbowditch edit */
                        LADS.Util.Splitscreen.init(root, newSplit.getRoot());
                        splitscreen.text(&#x27;Exit Split Screen&#x27;);
                        locsize = $(&#x27;#metascreen-L&#x27;).width() - window.innerWidth * 0.2;
                        $(&#x27;.exhibitionPicker&#x27;).remove();

                        newSplit.loadInteraction();

                        backButton.off(&#x27;click&#x27;);
                        backButton.on(&#x27;click&#x27;, function () {
                            backButton.off(&#x27;click&#x27;);
                            zoomimage &amp;&amp; zoomimage.unload();
                            /* nbowditch _editted 2/13/2014 */
                            var backInfo = { backArtwork: doq, backScroll: prevScroll };
                            var catalog = new LADS.Layout.NewCatalog(backInfo, toAdd);
                            /* end nbowditch edit */

                            catalog.getRoot().css({ &#x27;overflow-x&#x27;: &#x27;hidden&#x27; });
                            LADS.Util.UI.slidePageRightSplit(root, catalog.getRoot(), function () {
                                catalog.getRoot().css({ &#x27;overflow-x&#x27;: &#x27;hidden&#x27; });
                                var newState = {};
                                newState.currentSort = &quot;Title&quot;;
                                newState.exhibition = toAdd;
                                newState.tag = &quot;Title&quot;;
                                newState.currentImage = artwork;
                                //catalog.setState;  //commented out due to jshint error and unknown purpose
                            });
                        });
                    });
                }
            });
        }
    }

    function initFeedback() {

        var feedbackContainer = root.find(&#x27;#feedbackContainer&#x27;);

        var feedback = root.find(&#x27;#feedback-text&#x27;);
        feedback.text(&#x27;Send Feedback&#x27;);

         var feedbackIcon = root.find(&#x27;#feedback-icon&#x27;);

        feedbackIcon.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/FeedbackIcon.svg&#x27;);

        var feedbackBox = LADS.Util.UI.FeedbackBox(&quot;Artwork&quot;, doq.Identifier);//initiate the send feedback box
        setTimeout(function () {
           tagContainer.append(feedbackBox);
        }, 750);
        //pop up the feedback editing box when Send Feedback is clicked.
        // disable for now
        feedbackContainer.click(makeFeedback);
        function makeFeedback() {
            $(feedbackBox).css({ &#x27;display&#x27;: &#x27;block&#x27; });
        }

        return feedbackContainer;
    }

    function initSplitscreen() {

        //Split screen sidebar button
        var splitscreenContainer = root.find(&#x27;#splitscreenContainer&#x27;);
        //create splitscreen Icon
        var splitscreenIcon = root.find(&#x27;#splitscreenIcon&#x27;);

        splitscreenIcon.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/SplitW.svg&#x27;);

        splitscreenContainer.click(function () {
            if (locationHistoryActive) {
                locationHistory.text(&#x27;Location History&#x27;);
                locationHistory.css({ &#x27;color&#x27;: &#x27;white&#x27; });
                locationHistoryToggle.hide();
                locationHistoryToggle.hide(&quot;slide&quot;, { direction: direction }, 500);
                locationHistoryDiv.hide(&quot;slide&quot;, { direction: direction }, 500);
                setTimeout(function(){toggler.show()}, 500);//show the toggler for sidebar and hide the locationhistory toggler.
                locationHistoryActive = false;
            }
            if (prevPage === &quot;catalog&quot; &amp;&amp; initialized === true) {
                enterSplitScreen(true);
            } else {
                enterSplitScreen();
            }
        });
        function enterSplitScreen(fromTour) {//click function for splitscreenContainer
            fromTour = fromTour || 0;
            $(&#x27;.locations&#x27;).css({
                display: &#x27;block&#x27;,
                &#x27;white-space&#x27;: &#x27;nowrap&#x27;,
                &#x27;text-overflow&#x27;: &#x27;ellipsis&#x27;,
                &#x27;-o-text-overflow&#x27;: &#x27;ellipsis&#x27;,
                &#x27;-ms-text-overflow&#x27;: &#x27;ellipsis&#x27;,
                overflow: &#x27;hidden&#x27;
            });

            if (!LADS.Util.Splitscreen.on()) {
                locationHistory.css(&#x27;opacity&#x27;, &#x27;0.5&#x27;);
                //if the user enter artmode from tour tab in exhibition
                var newSplit;
                if (exhibition) {
                    /* nbowditch _editted 2/13/2014 : added backInfo */
                    var backInfo = { backArtwork: doq, backScroll: prevScroll };
                    newSplit = new LADS.Layout.NewCatalog(backInfo, exhibition, null, true);
                    /* end nbowditch edit */
                    (function () {
                        splitscreenContainer.hide();
                        LADS.Util.Splitscreen.init(root, newSplit.getRoot());
                        zoomimage.viewer.scheduleUpdate();

                        LADS.Util.Splitscreen.setViewers(root, zoomimage);
                        locsize = $(&#x27;#metascreen-L&#x27;).width() - window.innerWidth * 0.2;
                    })();

                }
                else if (fromTour !== 0) {
                    createExhibitionPicker(doq);
                }
            }
            else {//if the splitscreen is on, exit it.
                var parentid = $(root).parent().attr(&#x27;id&#x27;);
                splitscreenContainer.show();
                var parentSide = parentid[parentid.length - 1];
                zoomimage.viewer.scheduleUpdate();
                LADS.Util.Splitscreen.exit(parentSide);
                locationHistory.css(&#x27;opacity&#x27;, &#x27;1&#x27;);
            }
        }

        return splitscreenContainer;
    }

    /**
     * Return art viewer root element
     * @method
     * @return {Object}    root jquery object
     */
    this.getRoot = function () {
        return root;
    };

    /**
     * Make the map for location History.
     * @method
     * @param {Function} callback     function to be called when map making is complete
    */
    function makeMap(callback) {
        console.log(&quot;in make map&quot;);
        var initMap = function () {
            console.log(&quot;making map&quot;);
            var mapOptions =
            {
                credentials: &quot;AkNHkEEn3eGC3msbfyjikl4yNwuy5Qt9oHKEnqh4BSqo5zGiMGOURNJALWUfhbmj&quot;,
                mapTypeID: Microsoft.Maps.MapTypeId.road,
                showScalebar: true,
                enableClickableLogo: false,
                enableSearchLogo: false,
                showDashboard: true,
                showMapTypeSelector: false,
                zoom: 2,
                center: new Microsoft.Maps.Location(20, 0),
            };
            var viewOptions = {
                mapTypeId: Microsoft.Maps.MapTypeId.road,
            };
            //create the map based on splitscreen position.
            if (root.data(&#x27;split&#x27;) === &#x27;R&#x27;) {
                map = new Microsoft.Maps.Map(document.getElementById(&#x27;lpMapDivR&#x27;), mapOptions);
            } else {
                map = new Microsoft.Maps.Map(document.getElementById(&#x27;lpMapDiv&#x27;), mapOptions);
            }
            map.setView(viewOptions);

            mapMade = true;
            callback();
        };

        initMap();
    }

};

LADS.Layout.Artmode.default_options = {
    catalogState: {},
    doq: null,
    split: &#x27;L&#x27;,
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
