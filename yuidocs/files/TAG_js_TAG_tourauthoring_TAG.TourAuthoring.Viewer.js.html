<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>TAG\js\TAG\tourauthoring\TAG.TourAuthoring.Viewer.js - Touch Art Gallery web application</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..\..\TAG\images\WideLogo.scale-100.png" title="Touch Art Gallery web application"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Autolinker.html">Autolinker</a></li>
            
                <li><a href="../classes/TAG.AnnotatedImage.html">TAG.AnnotatedImage</a></li>
            
                <li><a href="../classes/TAG.Layout.ArtworkViewer.html">TAG.Layout.ArtworkViewer</a></li>
            
                <li><a href="../classes/TAG.Layout.CollectionsPage.html">TAG.Layout.CollectionsPage</a></li>
            
                <li><a href="../classes/TAG.Layout.InternetFailurePage.js.html">TAG.Layout.InternetFailurePage.js</a></li>
            
                <li><a href="../classes/TAG.Layout.StartPage.html">TAG.Layout.StartPage</a></li>
            
                <li><a href="../classes/TAG.Layout.VideoPlayer.html">TAG.Layout.VideoPlayer</a></li>
            
                <li><a href="../classes/TAG.Util.Artwork.html">TAG.Util.Artwork</a></li>
            
                <li><a href="../classes/TAG.Util.IdleTimer.html">TAG.Util.IdleTimer</a></li>
            
                <li><a href="../classes/TAG_embed.html">TAG_embed</a></li>
            
                <li><a href="../classes/Telemetry.html">Telemetry</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: TAG\js\TAG\tourauthoring\TAG.TourAuthoring.Viewer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿TAG.Util.makeNamespace(&#x27;TAG.TourAuthoring.Viewer&#x27;);

/**
 * Previews current tour while user edits
 * @param spec  timeManager attr, url (url of tour if loading existing tour for editing)
 * @param my    not used
 */
TAG.TourAuthoring.Viewer = function (spec, my) {
    &quot;use strict&quot;;

    var player, timeline,
        that = {},
        artworkPanel = $(document.createElement(&#x27;div&#x27;)),
        rinContainer = $(document.createElement(&#x27;div&#x27;)),
        timeManager = spec.timeManager,
        url = spec.url,

        // viewer state
        playing = false,
        buffering = false,
        reloading = false,
        needRefresh = false, ctime = null,

        // capturing keyframes?
        capturingOn = false,
        currentCapture = &#x27;&#x27;,
        keyframingDisabled = false,
            
        // is the tour reloading?
        isReloading = false;

    // Instantiate RIN player
    (function _startRIN() {
        // HTML containers
        artworkPanel.attr(&#x27;id&#x27;, &#x27;viewer&#x27;);
        artworkPanel.css({
            &quot;background-color&quot;: &quot;rgb(0,0,0)&quot;, &quot;height&quot;: &quot;100%&quot;, &quot;width&quot;: &quot;80%&quot;,
            &quot;position&quot;: &quot;relative&quot;, &quot;left&quot;: &quot;20%&quot;
        });

        // let&#x27;s assume 16:9 ratio for now
        rinContainer.attr(&#x27;id&#x27;, &#x27;rinContainer&#x27;);
        rinContainer.css({
            &#x27;border-style&#x27;: &#x27;solid&#x27;, &#x27;border-width&#x27;: TAG.TourAuthoring.Constants.rinBorder+&#x27;px&#x27;, &#x27;border-color&#x27;: &#x27;white&#x27;,
            &#x27;height&#x27;: &#x27;95%&#x27;, &#x27;width&#x27;: &#x27;30%&#x27;, &#x27;top&#x27;: &#x27;0%&#x27;, &#x27;left&#x27;: &#x27;30%&#x27;, &#x27;position&#x27;: &#x27;absolute&#x27;, &#x27;z-index&#x27;: 0
        });
        artworkPanel.append(rinContainer);

        var playerElement = $(document.createElement(&#x27;div&#x27;));
        playerElement.attr(&#x27;id&#x27;, &#x27;rinplayer&#x27;);
        playerElement.css({
            &#x27;z-index&#x27;: -100, &#x27;overflow&#x27;: &#x27;hidden&#x27;,
            &#x27;height&#x27;: &#x27;100%&#x27;, &#x27;width&#x27;: &#x27;100%&#x27;,
            &#x27;position&#x27;: &#x27;absolute&#x27;
        });
        rinContainer.append(playerElement);

        // creates actual RIN player
        rin.processAll(null, &#x27;js/rin/web/&#x27;).then(function () {
            var options = &#x27;systemRootUrl=js/rin/web/&amp;hideAllControllers=true&amp;playerMode=authorerEditor&#x27;;
            player = rin.createPlayerControl(playerElement[0], options);
            //player.interactionModeStarted.subscribe(_onInteraction);
            player.orchestrator.playerESEvent.subscribe(_onPlayerESEvent, &#x27;id&#x27;);
            player.orchestrator.isPlayerReadyChangedEvent.subscribe(_onPlayerStateEvent);
            
            timeManager.registerTime(getCurrentTime);
        });

        if (url) {
            loadTour(url, function () { console.log(&#x27;Viewer: initial loading complete&#x27;); });
        }
    })();

    //function _onInteraction(eventArgs) {
    //    timeManager.stop();
    //    capturingOn = true;
    //    currentCapture = eventArgs.interactionES._esData.experienceId;
    //    if (!reloading &amp;&amp; timeManager.getReady()) {
    //        _sendKeyframe(eventArgs.interactionES);
    //    }
    //}

    /**
     * When RIN is interacted with, captures new keyframe data and sends it to timeline
     * @param eventArgs     sender, eventId, ? (RIN)
     */
    function _onPlayerESEvent(eventArgs) {
        console.log(eventArgs.eventId);
        if (timeline) {
            switch (eventArgs.eventId) {
                case rin.contracts.esEventIds.interactionActivatedEventId:
                    timeManager.stop(); // on interaction start capturing
                    capturingOn = true;
                    currentCapture = eventArgs.sender._esData.experienceId;
                    if (capturingOn &amp;&amp; !reloading &amp;&amp; !keyframingDisabled &amp;&amp; timeManager.getReady()) {
                        _sendKeyframe(eventArgs.sender);
                    }
                    break;
                case rin.contracts.esEventIds.stateTransitionEventId:
                    // filter out non-interaction transitions
                    if (capturingOn &amp;&amp; !reloading &amp;&amp; !keyframingDisabled &amp;&amp; timeManager.getReady()) {
                        _sendKeyframe(eventArgs.sender);
                    }
                    break;
            }
        }
    }

    function _sendKeyframe(sender) {
        var trackName, capture = &#x27;&#x27;;
        if (sender.captureKeyframe &amp;&amp; capturingOn) {
            capture = sender.captureKeyframe();
            if (capture === &#x27;&#x27;) { // continue capturing until successful
                //setTimeout(function () { _sendKeyframe(sender); }, 10);
				console.log(&#x27;No keyframe captured!?&#x27;);
                return;
            }
            trackName = sender._esData.experienceId;

            timeline.receiveKeyframe(trackName, capture,
                true);
            timeline.allDeselected();
        }
    }

    /**
     * Turn capturing off on update
     */
    function capturingOff() {
        capturingOn = false;
        currentCapture = &#x27;&#x27;;
    }
    that.capturingOff = capturingOff;

    /**
     * Get state of keyframe disable switch.
     */
    function isKeyframingDisabled() {
        return keyframingDisabled;
    }
    that.isKeyframingDisabled = isKeyframingDisabled;

    function setKeyframingDisabled(state) {
        keyframingDisabled = state;
    }
    that.setKeyframingDisabled = setKeyframingDisabled;

    // add event listener for playerReady event to re-enable keyframe capture.
    $(&#x27;body&#x27;)[0].addEventListener(&#x27;playerReady&#x27;, function () {
        keyframingDisabled = false;
    });

    $(&#x27;body&#x27;)[0].addEventListener(&#x27;playerReloading&#x27;, function () {
        keyframingDisabled = true;
        setTimeout(function () {
            keyframingDisabled = false;
        }, 150);
    });

    /**
     * Syncs time manager with buffering state of RIN
     * @param isReady        true if RIN is ready to play
     */
    function _onPlayerStateEvent(isReady) {
        buffering = !isReady;
        timeManager.setReady(isReady);
        reloading = false;
        if (isReady) {
            if (needRefresh &amp;&amp; ctime) {
                needRefresh = false;
                seek(timeManager.getCurrentTime());
                ctime = null;
            }
            needRefresh = false;
            setTimeout(function () {
                var readyEvent = document.createEvent(&#x27;Event&#x27;);
                readyEvent.initEvent(&#x27;playerReady&#x27;, true, true);
                $(&#x27;body&#x27;)[0].dispatchEvent(readyEvent);
            }, 500);
        }
    }

    // Turn off capture on player events
    function _stopCapture() {
        capturingOn = false;
    }
    timeManager.onMove(_stopCapture);
    timeManager.onStop(_stopCapture);

    // Public stuff

    /**
     * @returns     current keyframe state data
     */
    function captureKeyframe(artname) {
        if (player) {
            return player.captureKeyframe(artname); //grab artwork container? BREAKPOINT HERE
        }
    }
    that.captureKeyframe = captureKeyframe;

    /**
     * Passed to TimeManager on player load
     * @returns     current time in player
     */
    function getCurrentTime() {
        return player.orchestrator.getCurrentLogicalTimeOffset();
    }
    that.getCurrentTime = getCurrentTime;
    

    function addToDOM (container) {
        container.append(artworkPanel);
    }
    that.addToDOM = addToDOM;

    /**
     * Get JQuery object containing rin player
     */
    function getContainer() {
        return rinContainer;
    }
    that.getContainer = getContainer;

    /**
     * Updates size of viewer area on resize
     */
    function resize() {
        var h = artworkPanel.height() - 2 * TAG.TourAuthoring.Constants.rinBorder,
            w = artworkPanel.width() - 2 * TAG.TourAuthoring.Constants.rinBorder,
            idealW = h * 16 / 9, idealH, // ideal W given h, vice-versa
            xoffset, yoffset;
        if (idealW &lt;= w) {
            xoffset = (w - idealW) / 2;
            rinContainer.css({
                width: idealW + &#x27;px&#x27;,
                height: h + &#x27;px&#x27;,
                top: &#x27;0px&#x27;,
                left: xoffset + &#x27;px&#x27;
            });
        } else { // no room to support, use ideal H
            idealH = w * 9 / 16;
            yoffset = (h - idealH) / 2; // equal spacing on top and bottom
            rinContainer.css({
                width: w + &#x27;px&#x27;,
                height: idealH + &#x27;px&#x27;,
                top: yoffset + &#x27;px&#x27;,
                left: &#x27;0px&#x27;
            });
        }
    }
    that.resize = resize;

    // PLAYER INTERACTIONS
    /**
     * Play viewer (should only be called from timeManager)
     */
    function play(time) {
        if (!playing) {
            player.play(time);
            playing = true;
        }
    }
    that.play = play;
    timeManager.onPlayStart(function (ev) { play(ev.current); });

    /**
     * Stop viewer (should only be called from timeManager)
     */
    function stop() {
        if (playing &amp;&amp; !buffering) {
            player.pause();
            playing = false;
        }
    }
    that.stop = stop;
    timeManager.onStop(stop);

    /**
     * Seek viewer (should only be called from timeManager)
     * @param time  location to seek to in units of seconds
     */
    function seek(time) {
        if (player.orchestrator._isNarrativeLoaded) {
            if (needRefresh) {
                ctime = timeManager.timeToPx(time);
            }

            else if (player &amp;&amp; !playing) {
                stop();
                playing = false;
                player.pause(time);
            }
        }
    }
    that.seek = seek;
    timeManager.onSeek(function (ev) { seek(ev.current); });

    /**
     * Set volume
     * @param v     volume, between 0 and 1
     */
    function volume(v) {
        player.volume(v);
    }
    that.volume = volume;

    /**
     * Set reference to Timeline for keyframe passing
     */
    function setTimeline(t) {
        timeline = t;
    }
    that.setTimeline = setTimeline;

    /**
     * Load tour from url
     * @param url       URL of json tour
     */
    function loadTour(url, callback) {
        if (player) {
            player.load(url, callback);
        } else {
            setTimeout(function () {
                loadTour(url, callback);
            }, 50);
        }
    }
    that.loadTour = loadTour;

    /**
     * Load / reload tour into viewer
     * @param data      Segment portion of RIN tour
     */
    function reloadTour(data, doNotUpdateReloading) {
        if (!doNotUpdateReloading) {
            isReloading = true;
        }
        console.log(&quot;####################################################: &quot;+isReloading);
        // console.log(&quot;player: &quot;+player);
        for (var key in data.resources) {
            if (data.resources.hasOwnProperty(key)) {
                if (typeof data.resources[key].uriReference === &#x27;string&#x27;) {
                    data.resources[key].uriReference = TAG.Worktop.Database.fixPath(data.resources[key].uriReference);
                }               
            }
        }
        if (player) {
            reloading = true;
            needRefresh = true;
            player.orchestrator._isPlayerReady = false;
            ctime = timeManager.getCurrentTime();
            player.unload();
            player.loadData(data, function () {
                // if needRefresh is false we seeked too early?
                if (!needRefresh) {
                    seek(timeManager.getCurrentTime());
                    setTimeout(function () {
                        var readyEvent = document.createEvent(&#x27;Event&#x27;);
                        readyEvent.initEvent(&#x27;playerReady&#x27;, true, true);
                        $(&#x27;body&#x27;)[0].dispatchEvent(readyEvent);
                    }, 500);
                }
                //setTimeout(function () { seek(ctime); reloading = false; }, 25);
                if (!doNotUpdateReloading) {
                    isReloading = false;

                }
                console.log(&quot;##############################################: &quot;+isReloading);
            });
        } else {
            setTimeout(function () { reloadTour(data, true); }, 50);
        }
    }
    that.reloadTour = reloadTour;

    function getIsReloading() {
        return isReloading;
    }
    that.getIsReloading = getIsReloading;

    function setIsReloading(bool) {
        isReloading = bool;
    }
    that.setIsReloading = setIsReloading;

    function initializeTour(data) {
        var ctime;
        isReloading = true;
        console.log(&quot;isReloading: true, in initializeTour&quot;);
        // console.log(&quot;player: &quot;+player);
        if (player) {
            ctime = timeManager.getCurrentTime();
            player.unload();
            player.loadData(data, function () {
                setTimeout(function () {
                    seek(ctime);
                    isReloading = false;
                    console.log(&quot;isReloading: false, in initializeTour&quot;);
                }, 50);
            });
        } else if (timeline.getTrackslength() === 0) {
            ctime = timeManager.getCurrentTime();
            setTimeout(function () {
                //seek(ctime);
                isReloading = false;
                console.log(&quot;isReloading: false, in initializeTour&quot;);
            }, 50);
        } else {
            setTimeout(function () { reloadTour(data, true); }, 50);
        }
    }
    that.initializeTour = initializeTour;

    /**
     * Unloads RIN player
     * call when exiting Authoring
     */
    function unload() {
        player.unload();
    }
    that.unload = unload;

    return that;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
