<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>TAG/js/TAG/layout/TAG.Layout.VideoPlayer.js - Touch Art Gallery web application</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../TAG/images/WideLogo.scale-100.png" title="Touch Art Gallery web application"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Autolinker.html">Autolinker</a></li>
            
                <li><a href="../classes/TAG.AnnotatedImage.html">TAG.AnnotatedImage</a></li>
            
                <li><a href="../classes/TAG.IdleTimer.html">TAG.IdleTimer</a></li>
            
                <li><a href="../classes/TAG.Layout.Artmode.html">TAG.Layout.Artmode</a></li>
            
                <li><a href="../classes/TAG.Layout.InternetFailurePage.js.html">TAG.Layout.InternetFailurePage.js</a></li>
            
                <li><a href="../classes/TAG.Layout.NewCatalog.html">TAG.Layout.NewCatalog</a></li>
            
                <li><a href="../classes/TAG.Layout.StartPage.html">TAG.Layout.StartPage</a></li>
            
                <li><a href="../classes/TAG.Layout.VideoPlayer.html">TAG.Layout.VideoPlayer</a></li>
            
                <li><a href="../classes/TAG.Util.Artwork.html">TAG.Util.Artwork</a></li>
            
                <li><a href="../classes/TAG_embed.html">TAG_embed</a></li>
            
                <li><a href="../classes/Telemetry.html">Telemetry</a></li>
            
                <li><a href="../classes/TwoStageTimer.html">TwoStageTimer</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: TAG/js/TAG/layout/TAG.Layout.VideoPlayer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
TAG.Util.makeNamespace(&quot;TAG.Layout.VideoPlayer&quot;);

/**
 * TAG video player -- a wrapper around the standard html5 video element
 * @class TAG.Layout.VideoPlayer
 * @constructor
 * @param {Doq} videoSrc     the doq representing our video
 * @param {Doq} collection   the parent collection of this video
 * @param {Object} prevInfo  some info about where we came from on the collections page:
 *                   .artworkPrev     string representing where we came from
 *                   .prevScroll      value of the scrollbar from new catalog page
 * @return {Object}          the object representing public information about the video page
 *                           (at the moment, just the root of the DOM)
 */
TAG.Layout.VideoPlayer = function (videoSrc, collection, prevInfo) {
    &quot;use strict&quot;;

    var artworkPrev,
        prevScroll = 0,
	    prevExhib = collection;

    if (prevInfo) {
        artworkPrev = prevInfo.artworkPrev,
        prevScroll = prevInfo.prevScroll || 0;
    }

    var that = {};

    var root = TAG.Util.getHtmlAjax(&#x27;VideoPlayer.html&#x27;),
        video = root.find(&#x27;#video&#x27;),
        sourceMP4,
        sourceWEBM,
        sourceOGG,
        videoElt = video[0],
        DURATION = parseFloat(videoSrc.Metadata.Duration),
        play = root.find(&#x27;#playPauseButton&#x27;),
        vol = root.find(&#x27;#videoControlsButton&#x27;),
        loop = root.find(&#x27;#loopButton&#x27;),
        sliderContainer = root.find(&#x27;#sliderContainer&#x27;),
        currTime,
        poster = (videoSrc.Metadata.Thumbnail &amp;&amp; !videoSrc.Metadata.Thumbnail.match(/.mp4/)) ? TAG.Worktop.Database.fixPath(videoSrc.Metadata.Thumbnail) : &#x27;&#x27;,
        source = TAG.Worktop.Database.fixPath(videoSrc.Metadata.Source),
        sourceWithoutExtension = source.substring(0, source.lastIndexOf(&#x27;.&#x27;)),
        currentTimeDisplay = root.find(&#x27;#currentTimeDisplay&#x27;),
        backButton = root.find(&#x27;#backButton&#x27;);

    currentPage = TAG.Util.Constants.pages.VIDEO_PLAYER;

    // UNCOMMENT IF WE WANT IDLE TIMER IN Video PLAYER
    // idleTimer = TAG.IdleTimer.TwoStageTimer();
    // idleTimer.start();

    // init the video player status
    initPage();
    timeToZero();
    initVideoPlayHandlers();

    /**
     * Return to the collections page from the video player.
     * @method goBack
     */
    function goBack() {
        videoElt.pause();
        video.attr(&#x27;src&#x27;, &quot;&quot;);

        // UNCOMMENT IF WE WANT IDLE TIMER IN TOUR PLAYER
        // idleTimer.kill();
        // idleTimer = null;

        var backInfo = { backArtwork: videoSrc, backScroll: prevScroll };
        var catalog = new TAG.Layout.NewCatalog({
            backScroll: prevScroll,
            backArtwork: videoSrc,
            backCollection: collection
        });

        catalog.getRoot().css({ &#x27;overflow-x&#x27;: &#x27;hidden&#x27; }); // TODO should be default in .styl file
        TAG.Util.UI.slidePageRightSplit(root, catalog.getRoot(), function () {
            artworkPrev = &quot;catalog&quot;;
            var selectedExhib = $(&#x27;#collection-&#x27; + prevExhib.Identifier);
            selectedExhib.attr(&#x27;flagClicked&#x27;, &#x27;true&#x27;);
            selectedExhib.css({ &#x27;background-color&#x27;: &#x27;white&#x27;, &#x27;color&#x27;: &#x27;black&#x27; });
            $(selectedExhib[0].firstChild).css({&#x27;color&#x27;: &#x27;black&#x27;});
        });
    }

    function loop(){

    }

    /**
     * Take video to time 0 and pause.
     * @method timeToZero
     */
    function timeToZero() {
        if (videoElt.currentTime !== 0) {
            videoElt.currentTime = 0;
            videoElt.pause();
        }
        play.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/PlayWhite.svg&#x27;);
    }

    /**
     * Play video and change play button image
     * @method playVideo
     */
    function playVideo() {
        videoElt.play();
        play.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/PauseWhite.svg&#x27;);
    }

    /**
     * Pause video and change play button image
     * @method pauseVideo
     */
    function pauseVideo() {
        videoElt.pause();
        play.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/PlayWhite.svg&#x27;);
    }

    /**
     * Play or pause video depending on its current state
     * @method toggleVideo
     */
    function toggleVideo() {
        videoElt.paused ? playVideo() : pauseVideo();
    }

    /**
     * Set up handlers for video element and play/pause button
     * @method initVideoPlayHandlers
     */
    function initVideoPlayHandlers() {
        video.on(&#x27;loadedmetadata&#x27;, initSeekHandlers);

        // set up play button
        play.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/PlayWhite.svg&#x27;);
        play.on(&#x27;click&#x27;, toggleVideo);

        // set up mute button
        vol.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/VolumeUpWhite.svg&#x27;);
        $(vol).on(&#x27;click&#x27;, function () {
            videoElt.muted = !videoElt.muted;
            vol.attr(&#x27;src&#x27;, tagPath+&#x27;images/icons/Volume&#x27;+ (videoElt.muted ? &#x27;Down&#x27; : &#x27;Up&#x27;) + &#x27;White.svg&#x27;);
        });

        // when video ends, return to collections page after a short delay
        video.on(&#x27;ended&#x27;, function () {
            setTimeout(goBack, 300);
        });

        // set up loop button
        loop.on(&#x27;click&#x27;, function() {

        });

        // Update the seek bar as the video plays
        video.on(&quot;timeupdate&quot;, function () {
            var value,
                minutes,
                seconds,
                adjMin;

            // Calculate the slider value and update the slider value
            value = ($(&#x27;#sliderContainer&#x27;).width() / videoElt.duration) * videoElt.currentTime;
            $(&#x27;#sliderPoint&#x27;).css(&#x27;width&#x27;,value);

            minutes = Math.floor(videoElt.currentTime / 60);
            seconds = Math.floor(videoElt.currentTime % 60);
            if (String(minutes).length &lt; 2) {
                adjMin = &#x27;0&#x27; + minutes;
            } else {
                adjMin = minutes;
            }
            currentTimeDisplay.text(adjMin + &quot;:&quot; + (seconds &lt; 10 ? &quot;0&quot; : &quot;&quot;) + seconds);
        });
    }

    /**
     * Set up handlers for the seekbar
     * @method initSeekHandlers
     */
    function initSeekHandlers() {
        sliderContainer.on(&#x27;mousedown&#x27;, function(evt) {
            var time = videoElt.duration * (evt.offsetX / $(&#x27;#sliderContainer&#x27;).width());    
            if (!isNaN(time)) {
                videoElt.currentTime = time;
            }
        });

        // set up mousedown handler for the seekbar
        sliderContainer.on(&#x27;mousedown&#x27;, function(e) {
            e.stopPropagation();
            var origPoint = e.pageX,
                origTime = videoElt.currentTime,
                timePxRatio = DURATION / sliderContainer.width(), // sec/px
                currPx,
                minutes,
                seconds;
            
            currTime = Math.max(0, Math.min(DURATION, origTime));
            currPx   = currTime / timePxRatio;
            minutes  = Math.floor(currTime / 60);
            seconds  = Math.floor(currTime % 60);

            if((&quot;&quot;+minutes).length &lt; 2) {
                minutes = &quot;0&quot; + minutes;
            }

            // set up mousemove handler now that mousedown has happened
            $(&#x27;body&#x27;).on(&#x27;mousemove.seek&#x27;, function(evt) {
                var currPoint = evt.pageX,
                    timeDiff = (currPoint - origPoint) * timePxRatio;

                currTime = Math.max(0, Math.min(DURATION, origTime + timeDiff));
                currPx   = currTime / timePxRatio;
                minutes  = Math.floor(currTime / 60);
                seconds  = Math.floor(currTime % 60);

                if((&quot;&quot;+minutes).length &lt; 2) {
                    minutes = &quot;0&quot; + minutes;
                }

                // Update the video time and slider values
                if (!isNaN(currTime)) {
                    $(&#x27;#currentTimeDisplay&#x27;).text(minutes + &quot;:&quot; + (seconds &lt; 10 ? &quot;0&quot; : &quot;&quot;) + seconds);
                    videoElt.currentTime = currTime;
                    $(&#x27;#sliderPoint&#x27;).css(&#x27;width&#x27;, currPx);
                }

            });

            // when the mouse is released or leaves iframe, remove the mousemove handler and set time
            $(&#x27;body&#x27;).on(&#x27;mouseup.seek mouseleave.seek&#x27;, function() {
                $(&#x27;body&#x27;).off(&#x27;mousemove.seek&#x27;);
                $(&#x27;body&#x27;).off(&#x27;mouseup.seek&#x27;);
                $(&#x27;body&#x27;).off(&#x27;mouseleave.seek&#x27;);
		        $(&#x27;#currentTimeDisplay&#x27;).text(minutes + &quot;:&quot; + (seconds &lt; 10 ? &quot;0&quot; : &quot;&quot;) + seconds);
                videoElt.currentTime = currTime;
		        $(&#x27;#sliderPoint&#x27;).css(&#x27;width&#x27;, currPx);
            });
        });
    }

    /**
     * Initialize misc parts of the video player
     * @method initPage
     */
    function initPage() {
        // set attributes of video element
        video.attr({
            poster: poster,
            controls: false,
            preload: &#x27;metadata&#x27;
        });

        //Adding sources for the video file
        sourceMP4  = sourceWithoutExtension + &quot;.mp4&quot;;
        sourceWEBM = sourceWithoutExtension + &quot;.webm&quot;;
        sourceOGG  = sourceWithoutExtension + &quot;.ogg&quot;;
        
        //video[0] converts the jQuery object &#x27;video&#x27; into an HTML object, allowing us to use innerHTML on it
        videoElt.innerHTML  = &#x27;&lt;source src=&quot;&#x27; + sourceMP4  + &#x27;&quot; type=&quot;video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;&quot;&gt;&#x27;;
        videoElt.innerHTML += &#x27;&lt;source src=&quot;&#x27; + sourceWEBM + &#x27;&quot; type=&quot;video/webm; codecs=&quot;vorbis, vp8&quot;&quot;&gt;&#x27;;
        videoElt.innerHTML += &#x27;&lt;source src=&quot;&#x27; + sourceOGG  + &#x27;&quot; type=&quot;video/ogg; codecs=&quot;theora, vorbis&quot;&quot;&gt;&#x27;;

        // set text of time display
        currentTimeDisplay.text(&quot;00:00&quot;);
    
        // set up back button
        backButton.attr(&#x27;src&#x27;,tagPath+&#x27;images/icons/Back.svg&#x27;);
        backButton.on(&#x27;mousedown&#x27;, function () {
            TAG.Util.UI.cgBackColor(&quot;backButton&quot;, backButton, false);
        });
        backButton.on(&#x27;mouseleave&#x27;, function () {
            TAG.Util.UI.cgBackColor(&quot;backButton&quot;, backButton, true);
        });

        backButton.on(&#x27;click&#x27;, goBack);
    }

    /**
     * Return the root of the video page
     * @method getRoot
     * @return {jQuery object}   root of the video page
     */
    function getRoot() {
        return root;
    }
    that.getRoot = getRoot;

    return that;
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
